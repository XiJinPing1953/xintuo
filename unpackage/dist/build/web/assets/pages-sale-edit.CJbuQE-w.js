import{t as e,o as t,c as s,w as a,d as l,e as r,p as o,x as i,y as u,F as n,q as c,f as d,g as m,i as h,I as _,z as f,B as p,D as g,l as b,m as y,r as v,s as k,C as w,u as N,v as S,j as x}from"./index-B6DdPhlT.js";import{_ as B,f as I,i as C,e as F,g as D}from"./_plugin-vue_export-helper.Dda_PF8M.js";import{B as A}from"./BackToDashboardBar.0jhbkRhX.js";const T=B({components:{BackToDashboardBar:A,SaleBasicInfoCard:B({name:"SaleBasicInfoCard",model:{prop:"value",event:"input"},props:{value:{type:Object,required:!0},customers:{type:Array,default:()=>[]},deliveryList:{type:Array,default:()=>[]},vehicleList:{type:Array,default:()=>[]}},data:()=>({localMode:"bottle",customerKeyword:"",customerSuggests:[],customerSuggestLoading:!1,customerSuggestTimer:null,deliveryKeyword1:"",deliverySuggests1:[],deliveryKeyword2:"",deliverySuggests2:[],vehicleKeyword:"",vehicleSuggests:[],priceUnitOptions:["元/kg","元/瓶","元/立方米"],priceUnitIndex:0,debugSuggest:!1,_suggestSeq:0}),computed:{header(){return this.value||{}}},watch:{value:{immediate:!0,handler(e){const t=e||{};this.customerKeyword=t.customer_name||"",this.deliveryKeyword1=t.delivery_man_1||"",this.deliveryKeyword2=t.delivery_man_2||"",this.vehicleKeyword=t.car_no||"";const s=t.price_unit||"kg",a={kg:0,bottle:1,cbm:2,m3:2};this.priceUnitIndex=null!=a[s]?a[s]:0;let l=t.biz_mode||"bottle";"bottle"!==l&&"truck"!==l&&(l="bottle"),this.localMode=l}}},mounted(){this.exposeVmToConsole()},methods:{updateHeader(e){const t={...this.value||{},...e};this.$emit("input",t)},normalizeKeyword:e=>String(e||"").replace(/[\s\u3000]+/g,"").trim(),onModeClick(e){if(this.localMode===e)return;this.localMode=e;const t={biz_mode:e};"truck"===e?this.header.price_unit&&"m3"!==this.header.price_unit||(t.price_unit="kg",this.priceUnitIndex=0):"m3"===this.header.price_unit&&(t.price_unit="kg",this.priceUnitIndex=0),this.updateHeader(t),this.$emit("mode-change",e)},onCustomerInput(e){const t=this.normalizeKeyword(e.detail.value);this.customerKeyword=t,this.updateHeader({customer_name:t,customer_id:""}),t?(this.customerSuggestTimer&&clearTimeout(this.customerSuggestTimer),this.customerSuggestTimer=setTimeout((()=>{this.fetchCustomerSuggests()}),200)):this.customerSuggests=[]},onSelectCustomer(e){e&&(this.customerKeyword=this.normalizeKeyword(e.name),this.customerSuggests=[],this.updateHeader({customer_id:e._id,customer_name:e.name}))},async fetchCustomerSuggests(){const t=this.normalizeKeyword(this.customerKeyword);if(!t)return this.customerSuggests=[],void(this.customerSuggestLoading=!1);const s=I();if(!s)return;const a=++this._suggestSeq;this.customerSuggestLoading=!0;try{const l=await e.callFunction({name:"crm-customer",data:{action:"suggest",token:s,data:{keyword:t,limit:20,debug:!0===this.debugSuggest}}});if(a!==this._suggestSeq)return;const r=l.result||{};this.debugSuggest&&console.log("[customer suggest]","kw=",t,"code=",r.code,"count=",(r.data||[]).length,"debug=",r.debug,r.data),0===r.code?this.customerSuggests=r.data||[]:this.customerSuggests=[]}catch(l){if(a!==this._suggestSeq)return;console.error("[SaleBasicInfoCard] fetchCustomerSuggests error",l)}finally{a===this._suggestSeq&&(this.customerSuggestLoading=!1)}},onVehicleInput(e){const t=e.detail.value.trim();if(this.vehicleKeyword=t,this.updateHeader({car_no:t,vehicle_id:""}),!t)return void(this.vehicleSuggests=[]);const s=(this.vehicleList||[]).filter((e=>{if(!e)return!1;return-1!==(e.car_no||e.plate_no||e.plateNo||"").indexOf(t)}));this.vehicleSuggests=s.slice(0,20)},onSelectVehicle(e){if(!e)return;const t=e.car_no||e.plate_no||e.plateNo||"";this.vehicleKeyword=t,this.vehicleSuggests=[],this.updateHeader({vehicle_id:e._id||"",car_no:t})},onDelivery1Input(e){const t=e.detail.value.trim();if(this.deliveryKeyword1=t,this.updateHeader({delivery_man_1:t}),!t)return void(this.deliverySuggests1=[]);const s=(this.deliveryList||[]).filter((e=>e&&e.name&&-1!==e.name.indexOf(t)));this.deliverySuggests1=s.slice(0,20)},onSelectDelivery1(e){e&&(this.deliveryKeyword1=e.name,this.deliverySuggests1=[],this.updateHeader({delivery_man_1:e.name}))},onDelivery2Input(e){const t=e.detail.value.trim();if(this.deliveryKeyword2=t,this.updateHeader({delivery_man_2:t}),!t)return void(this.deliverySuggests2=[]);const s=(this.deliveryList||[]).filter((e=>e&&e.name&&-1!==e.name.indexOf(t)));this.deliverySuggests2=s.slice(0,20)},onSelectDelivery2(e){e&&(this.deliveryKeyword2=e.name,this.deliverySuggests2=[],this.updateHeader({delivery_man_2:e.name}))},onDateChange(e){this.updateHeader({date:e.detail.value})},onUnitPriceInput(e){this.updateHeader({unit_price:e.detail.value})},onPriceUnitChange(e){const t=Number(e.detail.value);this.priceUnitIndex=t;let s="kg";1===t&&(s="bottle"),2===t&&(s="m3"),this.updateHeader({price_unit:s})},exposeVmToConsole(){try{"undefined"!=typeof window&&(window.__sale_basic_info_vm__=this)}catch(e){}},async callCrmCustomer(t,s){const a=I();if(!a)throw new Error("没有 token：请先登录");const l=(await e.callFunction({name:"crm-customer",data:{action:t,token:a,data:s}})).result||{};if(0!==l.code)throw new Error(l.msg||`callFunction ${t} failed`);return l},async runCustomerFixAll({dryRun:e=!0,batchSize:t=200}={}){let s="",a=0,l=0,r=0;for(console.log("[fix] start",{dryRun:e,batchSize:t});;){r+=1;const o=await this.callCrmCustomer("fix",{dryRun:e,batchSize:t,startAfterId:s}),i=Number(o.scanned||0),u=Number(o.updated||0),n=o.nextAfterId||"";if(console.log(`[fix] batch #${r}`,{scanned:i,updated:u,nextAfterId:n,dups:o.dups||[]}),!i)break;a+=i,l+=u,s=n}return console.log("[fix] finished",{dryRun:e,totalScanned:a,totalUpdated:l}),{dryRun:e,totalScanned:a,totalUpdated:l}},async runCustomerImport({rows:e=[],dryRun:t=!0,overwrite:s=!1}={}){if(!Array.isArray(e)||0===e.length)throw new Error("rows 为空：请先把导入数据整理成数组");console.log("[import] start",{dryRun:t,overwrite:s,rows:e.length});const a=await this.callCrmCustomer("import",{rows:e,dryRun:t,overwrite:s});return console.log("[import] result",a),a}}},[["render",function(e,g,b,y,v,k){const w=m,N=h,S=_,x=f;return t(),s(N,{class:"card card-basic"},{default:a((()=>[l(N,{class:"card-header"},{default:a((()=>[l(w,{class:"card-title"},{default:a((()=>[r("基础信息")])),_:1})])),_:1}),l(N,{class:"card-body"},{default:a((()=>[l(N,{class:"mode-switch-bar"},{default:a((()=>[l(N,{class:o(["mode-pill","bottle"===v.localMode?"mode-pill-active":""]),onClick:g[0]||(g[0]=e=>k.onModeClick("bottle"))},{default:a((()=>[l(w,{class:o(["mode-pill-text","bottle"===v.localMode?"mode-pill-text-active":""])},{default:a((()=>[r(" 瓶装模式 ")])),_:1},8,["class"])])),_:1},8,["class"]),l(N,{class:o(["mode-pill","truck"===v.localMode?"mode-pill-active":""]),onClick:g[1]||(g[1]=e=>k.onModeClick("truck"))},{default:a((()=>[l(w,{class:o(["mode-pill-text","truck"===v.localMode?"mode-pill-text-active":""])},{default:a((()=>[r(" 整车模式 ")])),_:1},8,["class"])])),_:1},8,["class"])])),_:1}),l(N,{class:"form-row"},{default:a((()=>[l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[r("* 客户")])),_:1}),l(N,{class:"input-wrapper"},{default:a((()=>[l(S,{class:"input",value:v.customerKeyword,placeholder:"请输入客户名搜索",onInput:k.onCustomerInput},null,8,["value","onInput"])])),_:1}),v.customerSuggests.length?(t(),s(N,{key:0,class:"sbic-suggest"},{default:a((()=>[(t(!0),i(n,null,u(v.customerSuggests,(e=>(t(),s(N,{key:e._id,class:"sbic-suggest-item",onClick:p((t=>k.onSelectCustomer(e)),["stop"])},{default:a((()=>[l(w,{class:"sbic-suggest-main"},{default:a((()=>[r(d(e.name),1)])),_:2},1024),l(w,{class:"sbic-suggest-sub"},{default:a((()=>[r(d(e.contact||""),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):c("",!0)])),_:1}),l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[r("* 日期")])),_:1}),l(x,{mode:"date",value:k.header.date,onChange:k.onDateChange},{default:a((()=>[l(N,{class:"input-wrapper"},{default:a((()=>[l(N,{class:"picker"},{default:a((()=>[l(w,null,{default:a((()=>[r(d(k.header.date||"请选择日期"),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["value","onChange"])])),_:1}),l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[r("车辆")])),_:1}),l(N,{class:"input-wrapper"},{default:a((()=>[l(S,{class:"input",value:v.vehicleKeyword,placeholder:"车牌模糊搜索",onInput:k.onVehicleInput},null,8,["value","onInput"])])),_:1}),v.vehicleSuggests.length?(t(),s(N,{key:0,class:"sbic-suggest"},{default:a((()=>[(t(!0),i(n,null,u(v.vehicleSuggests,(e=>(t(),s(N,{key:e._id,class:"sbic-suggest-item",onClick:p((t=>k.onSelectVehicle(e)),["stop"])},{default:a((()=>[l(w,{class:"sbic-suggest-main"},{default:a((()=>[r(d(e.plate_no||e.car_no||e.plateNo),1)])),_:2},1024),l(w,{class:"sbic-suggest-sub"},{default:a((()=>[r(d(e.name||""),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):c("",!0)])),_:1})])),_:1}),l(N,{class:"form-row"},{default:a((()=>[l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[r("配送员 1")])),_:1}),l(N,{class:"input-wrapper"},{default:a((()=>[l(S,{class:"input",value:v.deliveryKeyword1,placeholder:"输入姓名搜索",onInput:k.onDelivery1Input},null,8,["value","onInput"])])),_:1}),v.deliverySuggests1.length?(t(),s(N,{key:0,class:"sbic-suggest"},{default:a((()=>[(t(!0),i(n,null,u(v.deliverySuggests1,(e=>(t(),s(N,{key:e._id,class:"sbic-suggest-item",onClick:p((t=>k.onSelectDelivery1(e)),["stop"])},{default:a((()=>[l(w,{class:"sbic-suggest-main"},{default:a((()=>[r(d(e.name),1)])),_:2},1024),l(w,{class:"sbic-suggest-sub"},{default:a((()=>[r(d(e.phone||""),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):c("",!0)])),_:1}),l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[r("配送员 2（可空）")])),_:1}),l(N,{class:"input-wrapper"},{default:a((()=>[l(S,{class:"input",value:v.deliveryKeyword2,placeholder:"输入姓名搜索",onInput:k.onDelivery2Input},null,8,["value","onInput"])])),_:1}),v.deliverySuggests2.length?(t(),s(N,{key:0,class:"sbic-suggest"},{default:a((()=>[(t(!0),i(n,null,u(v.deliverySuggests2,(e=>(t(),s(N,{key:e._id,class:"sbic-suggest-item",onClick:p((t=>k.onSelectDelivery2(e)),["stop"])},{default:a((()=>[l(w,{class:"sbic-suggest-main"},{default:a((()=>[r(d(e.name),1)])),_:2},1024),l(w,{class:"sbic-suggest-sub"},{default:a((()=>[r(d(e.phone||""),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):c("",!0)])),_:1}),l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[r("单价 & 计价单位")])),_:1}),l(N,{class:"dual-input"},{default:a((()=>[l(N,{class:"input-wrapper dual-left"},{default:a((()=>[l(S,{class:"input",type:"number",placeholder:"单价",value:k.header.unit_price,onInput:k.onUnitPriceInput},null,8,["value","onInput"])])),_:1}),l(x,{mode:"selector",class:"dual-right",range:v.priceUnitOptions,value:v.priceUnitIndex,onChange:k.onPriceUnitChange},{default:a((()=>[l(N,{class:"input-wrapper"},{default:a((()=>[l(N,{class:"picker"},{default:a((()=>[l(w,null,{default:a((()=>[r(d(v.priceUnitOptions[v.priceUnitIndex]),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-3e00bd15"]]),FlowSettlementCard:B({name:"FlowSettlementCard",props:{unitPrice:{type:[Number,String],default:0},prevIndex:{type:[Number,String],default:""},currIndex:{type:[Number,String],default:""},amountReceived:{type:[Number,String],default:""},paymentStatus:{type:String,default:"挂账"},remark:{type:String,default:""},paymentStatusOptions:{type:Array,default:()=>["挂账","已付","部分已付","冲减"]}},data(){return{prev:String(this.prevIndex||""),curr:String(this.currIndex||""),localAmountReceived:String(this.amountReceived||""),localPaymentStatus:this.paymentStatus||"挂账",localRemark:this.remark||""}},watch:{prevIndex(e){this.prev=String(e||"")},currIndex(e){this.curr=String(e||"")},amountReceived(e){this.localAmountReceived=String(e||"")},paymentStatus(e){this.localPaymentStatus=e||"挂账"},remark(e){this.localRemark=e||""}},computed:{volumeNumber(){const e=Number(this.prev),t=Number(this.curr);return isNaN(e)||isNaN(t)||t<e?0:t-e},volumeText(){return this.volumeNumber.toFixed(4)},volumeFormula(){return this.volumeNumber?`${this.curr||0} - ${this.prev||0} = ${this.volumeText}m³`:""},amountNumber(){const e=this.volumeNumber,t=Number(this.unitPrice);return!e||isNaN(t)?0:e*t},amountText(){return this.amountNumber.toFixed(2)},amountFormula(){const e=Number(this.unitPrice);return!this.volumeNumber||isNaN(e)?"":`应收金额 = 用气量 × 单价 = ${this.volumeText}m³ × ${e}元/m³ = ${this.amountText}元`},paymentStatusIndex(){const e=this.paymentStatusOptions.indexOf(this.localPaymentStatus);return e>=0?e:0},paymentStatusLabel(){return this.paymentStatusOptions[this.paymentStatusIndex]||"挂账"}},methods:{onPaymentStatusChange(e){const t=Number(e.detail.value);this.localPaymentStatus=this.paymentStatusOptions[t]||"挂账",this.emitChange()},emitChange(){const e={prev:this.prev,curr:this.curr,volume:this.volumeText,amount:this.amountText,amount_received:this.localAmountReceived,payment_status:this.localPaymentStatus,remark:this.localRemark};this.$emit("input",e),this.$emit("update",e)}}},[["render",function(e,o,i,u,n,p){const b=m,y=h,v=_,k=f,w=g;return t(),s(y,{class:"card flow-settle-card"},{default:a((()=>[l(y,{class:"card-header"},{default:a((()=>[l(b,{class:"card-title"},{default:a((()=>[r("流量结算")])),_:1}),l(b,{class:"card-sub"},{default:a((()=>[r("单位为 元/m³ 时自动启用此卡片")])),_:1})])),_:1}),l(y,{class:"card-body"},{default:a((()=>[l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[r("上次表数 (m³)")])),_:1}),l(y,{class:"input-wrapper"},{default:a((()=>[l(v,{type:"number",class:"input",modelValue:n.prev,"onUpdate:modelValue":o[0]||(o[0]=e=>n.prev=e),onBlur:p.emitChange},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[r("本次表数 (m³)")])),_:1}),l(y,{class:"input-wrapper"},{default:a((()=>[l(v,{type:"number",class:"input",modelValue:n.curr,"onUpdate:modelValue":o[1]||(o[1]=e=>n.curr=e),onBlur:p.emitChange},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(y,{class:"summary-chip"},{default:a((()=>[l(y,{class:"summary-line"},{default:a((()=>[l(b,{class:"summary-label"},{default:a((()=>[r("本次用气量：")])),_:1}),l(b,{class:"summary-value-strong"},{default:a((()=>[r(d(p.volumeText)+" m³",1)])),_:1})])),_:1}),p.volumeFormula?(t(),s(y,{key:0,class:"summary-line"},{default:a((()=>[l(b,{class:"summary-formula"},{default:a((()=>[r(d(p.volumeFormula),1)])),_:1})])),_:1})):c("",!0)])),_:1}),l(y,{class:"summary-chip"},{default:a((()=>[l(y,{class:"summary-line"},{default:a((()=>[l(b,{class:"summary-label-strong"},{default:a((()=>[r("应收金额：")])),_:1}),l(b,{class:"summary-value-strong"},{default:a((()=>[r(d(p.amountText)+" 元",1)])),_:1})])),_:1}),p.amountFormula?(t(),s(y,{key:0,class:"summary-line"},{default:a((()=>[l(b,{class:"summary-formula"},{default:a((()=>[r(d(p.amountFormula),1)])),_:1})])),_:1})):c("",!0)])),_:1}),l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[r("实收金额 (元)")])),_:1}),l(y,{class:"input-wrapper"},{default:a((()=>[l(v,{type:"number",class:"input",modelValue:n.localAmountReceived,"onUpdate:modelValue":o[2]||(o[2]=e=>n.localAmountReceived=e),onBlur:p.emitChange,placeholder:"本次实际收了多少，可为 0"},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[r("付款状态")])),_:1}),l(k,{mode:"selector",range:i.paymentStatusOptions,value:p.paymentStatusIndex,onChange:p.onPaymentStatusChange},{default:a((()=>[l(y,{class:"input-wrapper"},{default:a((()=>[l(y,{class:"picker"},{default:a((()=>[l(b,null,{default:a((()=>[r(d(p.paymentStatusLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1}),l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[r("备注")])),_:1}),l(w,{class:"textarea",modelValue:n.localRemark,"onUpdate:modelValue":o[3]||(o[3]=e=>n.localRemark=e),onBlur:p.emitChange,placeholder:"例如：只抄表未送气；或补录某日流量结算"},null,8,["modelValue","onBlur"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-f3d0af82"]]),FlowTheoryCard:B({name:"FlowTheoryCard",props:{totalOutNet:{type:[Number,String],default:0},totalBackNet:{type:[Number,String],default:0},ratio:{type:[Number,String],default:1.37}},data(){return{ratioInput:this.ratio}},watch:{ratio(e){this.ratioInput=e}},computed:{outKgNumber(){const e=Number(this.totalOutNet);return isNaN(e)?0:e},backKgNumber(){const e=Number(this.totalBackNet);return isNaN(e)?0:e},actualKgNumber(){return this.outKgNumber-this.backKgNumber},outKgText(){return this.outKgNumber.toFixed(2)},backKgText(){return this.backKgNumber.toFixed(2)},actualKgText(){return this.actualKgNumber.toFixed(2)},actualFormula(){return this.outKgNumber||this.backKgNumber?`实际消耗 = 出瓶净重合计 - 回瓶净重合计 = ${this.outKgText}kg - ${this.backKgText}kg = ${this.actualKgText}kg`:""},ratioNumber(){const e=Number(this.ratioInput);return isNaN(e)||e<=0?0:e},theoryVolumeNumber(){return this.ratioNumber?this.actualKgNumber*this.ratioNumber:0},theoryVolumeText(){return this.theoryVolumeNumber.toFixed(2)},theoryFormula(){return this.theoryVolumeNumber&&this.ratioNumber?`理论用气量 = 实际消耗 × 换算系数 = ${this.actualKgText}kg × ${this.ratioNumber}m³/kg = ${this.theoryVolumeText}m³`:""}},methods:{onRatioInput(e){const t=e.detail.value;this.ratioInput=t;const s=Number(t);this.$emit("update-ratio",isNaN(s)?0:s)}}},[["render",function(e,o,i,u,n,f){const p=m,g=h,b=_;return t(),s(g,{class:"card flow-theory-card"},{default:a((()=>[l(g,{class:"card-header"},{default:a((()=>[l(p,{class:"card-title"},{default:a((()=>[r("称重推算理论流量")])),_:1}),l(p,{class:"card-sub"},{default:a((()=>[r(" 从瓶子 / 罐车称重看本次实际消耗多少公斤，并换算成立方米 ")])),_:1})])),_:1}),l(g,{class:"card-body"},{default:a((()=>[l(g,{class:"summary-chip"},{default:a((()=>[l(g,{class:"summary-line"},{default:a((()=>[l(p,{class:"summary-label"},{default:a((()=>[r("出瓶净重合计：")])),_:1}),l(p,{class:"summary-value"},{default:a((()=>[r(d(f.outKgText)+" kg",1)])),_:1})])),_:1}),l(g,{class:"summary-line"},{default:a((()=>[l(p,{class:"summary-label"},{default:a((()=>[r("回瓶净重合计：")])),_:1}),l(p,{class:"summary-value"},{default:a((()=>[r(d(f.backKgText)+" kg",1)])),_:1})])),_:1}),l(g,{class:"summary-line"},{default:a((()=>[l(p,{class:"summary-label"},{default:a((()=>[r("实际消耗：")])),_:1}),l(p,{class:"summary-value-strong"},{default:a((()=>[r(d(f.actualKgText)+" kg",1)])),_:1})])),_:1}),f.actualFormula?(t(),s(g,{key:0,class:"summary-line"},{default:a((()=>[l(p,{class:"summary-formula"},{default:a((()=>[r(d(f.actualFormula),1)])),_:1})])),_:1})):c("",!0)])),_:1}),l(g,{class:"form-row"},{default:a((()=>[l(g,{class:"form-item col-half"},{default:a((()=>[l(p,{class:"label"},{default:a((()=>[r("换算系数 (m³/kg)")])),_:1}),l(g,{class:"input-wrapper"},{default:a((()=>[l(b,{class:"input",type:"number",value:n.ratioInput,placeholder:"例如 1.37",onInput:f.onRatioInput},null,8,["value","onInput"])])),_:1})])),_:1})])),_:1}),l(g,{class:"summary-chip"},{default:a((()=>[l(g,{class:"summary-line"},{default:a((()=>[l(p,{class:"summary-label"},{default:a((()=>[r("理论用气量：")])),_:1}),l(p,{class:"summary-value-strong"},{default:a((()=>[r(d(f.theoryVolumeText)+" m³",1)])),_:1})])),_:1}),f.theoryFormula?(t(),s(g,{key:0,class:"summary-line"},{default:a((()=>[l(p,{class:"summary-formula"},{default:a((()=>[r(d(f.theoryFormula),1)])),_:1})])),_:1})):c("",!0)])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-7b41d630"]])},data:()=>({todayText:"",statusTextMap:{in_station:"在站",at_customer:"在客户",in_transit:"途中",repairing:"维修",scrapped:"报废",lost:"丢失"},header:{date:"",customer_id:"",customer_name:"",delivery_man_1:"",delivery_man_2:"",vehicle_id:"",car_no:"",unit_price:"",price_unit:"kg",amount_received:"",payment_status:"挂账",remark:"",biz_mode:"bottle",truck_gross:"",truck_tare:"",truck_net:""},defaultRatio:1.37,flowTheoryRatio:1.37,flowSettle:{prev:"",curr:"",volume:"",amount:"",amount_received:"",payment_status:"挂账",remark:"",flow_index_prev:"",flow_index_curr:"",flow_volume:"",flow_unit_price:"",flow_amount_should:"",flow_amount_received:"",flow_payment_status:"",flow_remark:""},truckNetManual:!1,customers:[],customerIndex:-1,customerKeyword:"",customerSuggests:[],deliveryList:[],deliveryIndex1:-1,deliveryIndex2:-1,vehicleList:[],vehicleIndex:-1,priceUnitOptions:["元/kg","元/瓶","元/m³"],priceUnitIndex:0,paymentStatusOptions:["挂账","已付","部分已付","冲减"],paymentStatusIndex:0,outBottles:[{number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1}],backBottles:[{number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1}],depositBottles:[{number:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1}],customerDeposits:[],submitting:!1,bottleSearchCache:{},bottleSearchPending:{},debouncedBottleSuggest:null,editId:"",isEditing:!1,userInfo:{}}),computed:{isAdmin(){return C(this.userInfo)},pageTitle(){return this.isEditing?"编辑销售记录":"新增销售记录"},tagText(){return this.isEditing?this.header&&this.header.date?`单据日期 · ${this.header.date}`:"单据日期未填写":`今日 · ${this.todayText}`},bizMode(){return this.header.biz_mode||this.header.business_mode||"bottle"},showBottleCards(){return"bottle"===this.bizMode},isFlowPriceMode(){return"m3"===this.header.price_unit},normalizedCustomerDeposits(){return this.normalizeDepositList(this.customerDeposits)},liveDeposits(){const e=[],t=new Set,s=s=>{const a=(s||"").trim();a&&!t.has(a)&&(t.add(a),e.push(a))};return this.normalizedCustomerDeposits.forEach(s),(this.depositBottles||[]).forEach((e=>s(e&&e.number))),(this.outBottles||[]).forEach((e=>s(e&&e.number))),(this.backBottles||[]).forEach((s=>{const a=s&&s.number?s.number.trim():"";if(!a||!t.has(a))return;t.delete(a);const l=e.indexOf(a);l>-1&&e.splice(l,1)})),e},remainingDeposits(){if(!this.isEditing)return this.liveDeposits;const e=[],t=new Set,s=s=>{const a=(s||"").trim();a&&!t.has(a)&&(t.add(a),e.push(a))};return(this.depositBottles||[]).forEach((e=>s(e&&e.number))),(this.outBottles||[]).forEach((e=>s(e&&e.number))),(this.backBottles||[]).forEach((s=>{const a=s&&s.number?s.number.trim():"";if(!a||!t.has(a))return;t.delete(a);const l=e.indexOf(a);l>-1&&e.splice(l,1)})),e},truckNetNumber(){const e=Number(this.header.truck_net);return isNaN(e)?0:e},truckGrossTon:{get(){const e=this.header.truck_gross;if(""===e||null==e)return"";const t=Number(e);return isNaN(t)?"":t/1e3},set(e){const t=Number(e);isNaN(t)?this.header.truck_gross="":(this.header.truck_gross=String(Math.round(1e3*t)),this.updateTruckNet())}},truckTareTon:{get(){const e=this.header.truck_tare;if(""===e||null==e)return"";const t=Number(e);return isNaN(t)?"":t/1e3},set(e){const t=Number(e);isNaN(t)?this.header.truck_tare="":(this.header.truck_tare=String(Math.round(1e3*t)),this.updateTruckNet())}},truckNetTon:{get(){const e=this.header.truck_net;if(""===e||null==e)return"";const t=Number(e);return isNaN(t)?"":t/1e3},set(e){this.truckNetManual=!0;const t=Number(e);isNaN(t)?this.header.truck_net="":this.header.truck_net=String(Math.round(1e3*t))}},backAmountAbs(){const e=this.backAmount;return e?Math.abs(e).toFixed(2):"0"},backAmountDirectionText(){return this.backAmount>0?"（需退给客户）":this.backAmount<0?"（需客户补）":""},backAmountDisplayForSummary(){const e=this.backAmount;if(!e)return"0";const t=Math.abs(e).toFixed(2);return e>0?"-"+t:t},outAmountDetail(){const e=this.unitPriceNumber;if(!e)return"";if("truck"===this.bizMode){const t=this.truckNetNumber;return t?`${t.toFixed(2)}kg×${e.toFixed(2)}元/kg=${this.outAmount}元`:""}if("bottle"===this.header.price_unit){const t=this.outBottles.filter((e=>e.number.trim())).length;return t?`${t}瓶×${e.toFixed(2)}元/瓶=${this.outAmount}元`:""}if("kg"===this.header.price_unit){const t=Number(this.totalOutNet);return t?`${t.toFixed(2)}kg×${e.toFixed(2)}元/kg=${this.outAmount}元`:""}return""},backAmountDetail(){const e=this.unitPriceNumber;if(!e)return"";if("bottle"===this.header.price_unit||"m3"===this.header.price_unit)return"";const t=Number(this.totalBackNet);if(!t)return"";const s=Math.abs(t).toFixed(2),a=Math.abs(this.backAmount).toFixed(2),l=t>0?"减收":"加收";return`${s}kg×${e.toFixed(2)}元/kg=${a}元，${l}${a}元`},shouldReceiveDetail(){const e=Number(this.outAmount);if(!e)return"";const t=this.backAmount,s=Math.abs(t).toFixed(2),a=this.shouldReceive;return t?t>0?`${e.toFixed(2)}-${s}=${a}元`:`${e.toFixed(2)}+${s}=${a}元`:`${e.toFixed(2)}=${a}元`},customerLabel(){var e;return this.customerIndex<0?"请选择客户":(null==(e=this.customers[this.customerIndex])?void 0:e.name)||"请选择客户"},deliveryLabel1(){var e;return this.deliveryIndex1<0?"请选择配送员":(null==(e=this.deliveryList[this.deliveryIndex1])?void 0:e.name)||"请选择配送员"},deliveryLabel2(){var e;return this.deliveryIndex2<0?"（可空）":(null==(e=this.deliveryList[this.deliveryIndex2])?void 0:e.name)||"（可空）"},vehicleLabel(){if(this.vehicleIndex<0)return"请选择车辆";const e=this.vehicleList[this.vehicleIndex];return e?e.name?`${e.plate_no} - ${e.name}`:e.plate_no:"请选择车辆"},priceUnitLabel(){return this.priceUnitOptions[this.priceUnitIndex]},paymentStatusLabel(){return this.paymentStatusOptions[this.paymentStatusIndex]},totalOutNet(){let e=0;return this.outBottles.forEach((t=>{const s=Number(t.net);isNaN(s)||(e+=s)})),e.toFixed(2)},totalBackNet(){let e=0;return this.backBottles.forEach((t=>{const s=Number(t.net);isNaN(s)||(e+=s)})),e.toFixed(2)},totalOutNetDetail(){const e=this.outBottles.map((e=>Number(e.net))).filter((e=>!isNaN(e)&&0!==e));if(!e.length)return"";let t="";e.forEach(((e,s)=>{const a=Math.abs(e),l=(a%1==0?a.toString():a.toFixed(2))+"kg";t+=0===s?(e<0?"-":"")+l:(e<0?"-":"+")+l}));const s=Number(this.totalOutNet),a=Math.abs(s),l=(a%1==0?a.toString():a.toFixed(2))+"kg";return t+="="+(s<0?"-":"")+l,t},totalBackNetDetail(){const e=this.backBottles.map((e=>Number(e.net))).filter((e=>!isNaN(e)&&0!==e));if(!e.length)return"";let t="";e.forEach(((e,s)=>{const a=Math.abs(e),l=(a%1==0?a.toString():a.toFixed(2))+"kg";t+=0===s?(e<0?"-":"")+l:(e<0?"-":"+")+l}));const s=Number(this.totalBackNet),a=Math.abs(s),l=(a%1==0?a.toString():a.toFixed(2))+"kg";return t+="="+(s<0?"-":"")+l,t},totalInOutNet(){if("truck"===this.bizMode)return this.truckNetNumber.toFixed(2);const e=Number(this.totalOutNet),t=Number(this.totalBackNet);return((isNaN(e)?0:e)-(isNaN(t)?0:t)).toFixed(2)},totalInOutNetDetail(){if("truck"===this.bizMode){const e=this.truckNetNumber;if(!e)return"";const t=(e=>{const t=Math.abs(e);return t%1==0?t.toString():t.toFixed(2)})(e);return`${t}kg=${t}kg`}const e=Number(this.totalOutNet),t=Number(this.totalBackNet),s=isNaN(e)?0:e,a=isNaN(t)?0:t;if(!s&&!a)return"";const l=e=>{const t=Math.abs(e);return t%1==0?t.toString():t.toFixed(2)},r=l(s),o=l(a),i=l(s-a);return a>0?`${r}kg-${o}kg=${i}kg`:a<0?`${r}kg+${o}kg=${i}kg`:`${r}kg=${i}kg`},unitPriceNumber(){const e=Number(this.header.unit_price);return isNaN(e)?0:e},outAmount(){const e=this.unitPriceNumber;if(!e)return"0";if("truck"===this.bizMode)return(this.truckNetNumber*e).toFixed(2);if("bottle"===this.header.price_unit){return(this.outBottles.filter((e=>e.number.trim())).length*e).toFixed(2)}return"kg"===this.header.price_unit?(Number(this.totalOutNet)*e).toFixed(2):"0"},backAmount(){const e=this.unitPriceNumber;if(!e)return 0;if("bottle"===this.header.price_unit||"m3"===this.header.price_unit)return 0;const t=Number(this.totalBackNet);return Number((t*e).toFixed(2))},shouldReceive(){return(Number(this.outAmount)-Number(this.backAmount)).toFixed(2)},flowTheoryOutNet(){return"truck"===this.bizMode?this.truckNetNumber:Number(this.totalOutNet)||0},flowTheoryBackNet(){return"truck"===this.bizMode?0:Number(this.totalBackNet)||0}},watch:{"header.customer_id"(e){this.isFlowPriceMode&&e&&this.loadLastFlowIndexForCustomer(e),this.loadCustomerDeposits(e)},"header.payment_status":{immediate:!0,handler(e){const t=this.paymentStatusOptions.indexOf(e);this.paymentStatusIndex=t>=0?t:0}},"header.price_unit":{immediate:!0,handler(e){this.priceUnitIndex="kg"===e?0:"bottle"===e?1:"m3"===e?2:0,"m3"===e&&this.header.customer_id&&this.loadLastFlowIndexForCustomer(this.header.customer_id)}}},onLoad(e){if(!F())return void b({title:"提示",content:"登录已过期，请重新登录",showCancel:!1,success:()=>{try{y()}catch(e){}v({url:"/pages/login/login"})}});if(this.userInfo=D()||{},!this.isAdmin)return void b({title:"提示",content:"当前账号无权限新增销售记录",showCancel:!1,success:()=>{this.goBack()}});const t=e&&(e.id||e.sale_id);t&&(this.editId=t,this.isEditing=!0);const s=new Date,a=s.getFullYear(),l=String(s.getMonth()+1).padStart(2,"0"),r=String(s.getDate()).padStart(2,"0");this.header.date=`${a}-${l}-${r}`,this.todayText=`${l} 月 ${r} 日`,this.flowTheoryRatio=this.defaultRatio,this.loadCustomers(),this.loadDeliveryList(),this.loadVehicles(),this.debouncedBottleSuggest=function(e,t=200){let s=null;return function(...a){clearTimeout(s),s=setTimeout((()=>{e.apply(this,a)}),t)}}(this.doBottleSuggest,200),this.isEditing&&this.editId&&this.loadSaleForEdit(this.editId)},onShow(){F()&&(this.userInfo=D()||{},this.isAdmin?(this.loadCustomers(),this.loadDeliveryList(),this.loadVehicles(),this.syncSelectIndexesFromHeader()):b({title:"提示",content:"当前账号无权限新增销售记录",showCancel:!1,success:()=>{this.goBack()}}))},methods:{handleAuthError(e){const t=e&&e.result&&e.result.code,s=e&&e.result&&e.result.msg||"";return(401===t||"UNAUTHORIZED"===t||"NO_LOGIN"===t||"AUTH_FAILED"===t||-1!==s.indexOf("未登录")||-1!==s.indexOf("登录已过期"))&&(b({title:"提示",content:s||"登录已过期，请重新登录",showCancel:!1,success:()=>{try{y()}catch(e){}v({url:"/pages/login/login"})}}),!0)},normalizeDepositList(e){if(!e)return[];if("string"==typeof e)return String(e).split(/[\/、,，\s]+/).map((e=>e.trim())).filter(Boolean);return(Array.isArray(e)?e:[e]).map((e=>"string"==typeof e?e.trim():e&&"object"==typeof e?String(e.bottle_no||e.number||e.bottleInput||"").trim():"")).filter(Boolean)},async loadSaleForEdit(t){var s;if(!t)return;const a=I();try{const l=await e.callFunction({name:"crm-sale",data:{action:"get",token:a,data:{id:t}}});if(this.handleAuthError(l))return;if(!l.result||0!==l.result.code||!l.result.data)return void k({title:(null==(s=l.result)?void 0:s.msg)||"未找到销售记录",icon:"none"});const r=l.result.data;let o=r.delivery_man_1||r.delivery1||"",i=r.delivery_man_2||r.delivery2||"";if((!o||!i)&&r.delivery_man){const e=String(r.delivery_man).split(/[\/、,，]/).map((e=>e.trim())).filter(Boolean);o||(o=e[0]||""),i||(i=e[1]||"")}this.header={date:r.date||"",customer_id:r.customer_id||r.customerId||"",customer_name:r.customer_name||r.customerName||"",delivery_man_1:o,delivery_man_2:i,vehicle_id:r.vehicle_id||r.vehicleId||"",car_no:r.car_no||"",unit_price:null!=r.unit_price?String(r.unit_price):"",price_unit:(r.price_unit||r.priceUnit||"kg").toLowerCase(),amount_received:null!=r.amount_received?String(r.amount_received):"",payment_status:r.payment_status||"挂账",remark:r.remark||"",biz_mode:r.biz_mode||r.bizMode||"bottle",truck_gross:null!=r.truck_gross?String(r.truck_gross):"",truck_tare:null!=r.truck_tare?String(r.truck_tare):"",truck_net:null!=r.truck_net?String(r.truck_net):""},"number"==typeof r.flow_theory_ratio&&(this.flowTheoryRatio=r.flow_theory_ratio);const u=r.out_items||r.outItems||[];Array.isArray(u)&&u.length?this.outBottles=u.map((e=>({number:e.bottle_no||e.bottleInput||"",gross:null!=e.gross?String(e.gross):"",tare:null!=e.tare?String(e.tare):"",net:null!=e.net?String(e.net):"",bottleId:e.bottle_id||e.bottleId||null,exists:!0,suggestions:[],fromSelect:!1,netManual:!0}))):r.bottle_no&&(this.outBottles=[{number:r.bottle_no,gross:null!=r.gross_weight_out?String(r.gross_weight_out):"",tare:null!=r.tare_weight_out?String(r.tare_weight_out):"",net:null!=r.net_weight_out?String(r.net_weight_out):"",bottleId:r.bottle_id||null,exists:!0,suggestions:[],fromSelect:!1,netManual:!0}]);const n=r.back_items||r.backItems||[];Array.isArray(n)&&n.length?this.backBottles=n.map((e=>({number:e.bottle_no||e.bottleInput||"",gross:null!=e.gross?String(e.gross):"",tare:null!=e.tare?String(e.tare):"",net:null!=e.net?String(e.net):"",bottleId:e.bottle_id||e.bottleId||null,exists:!0,suggestions:[],fromSelect:!1,netManual:!0}))):r.return_bottle_no&&(this.backBottles=[{number:r.return_bottle_no,gross:null!=r.gross_weight_back?String(r.gross_weight_back):"",tare:null!=r.tare_weight_back?String(r.tare_weight_back):"",net:null!=r.net_weight_back?String(r.net_weight_back):"",bottleId:r.return_bottle_id||null,exists:!0,suggestions:[],fromSelect:!1,netManual:!0}]);const c=r.deposit_rows||r.deposit_items||r.depositRows||r.depositItems||null;if(Array.isArray(c)&&c.length){const e=this.normalizeDepositList(c);this.depositBottles=e.length?e.map((e=>this.createDepositRow(e))):[this.createDepositRow()]}else if(r.deposit_bottles_raw){const e=this.normalizeDepositList(r.deposit_bottles_raw);this.depositBottles=e.length?e.map((e=>this.createDepositRow(e))):[this.createDepositRow()]}else this.depositBottles=[this.createDepositRow()];"m3"===(r.price_unit||r.priceUnit)&&(this.flowSettle={prev:null!=r.flow_index_prev?String(r.flow_index_prev):"",curr:null!=r.flow_index_curr?String(r.flow_index_curr):"",volume:null!=r.flow_volume_m3?String(r.flow_volume_m3):"",amount:null!=r.flow_amount_should?String(r.flow_amount_should):"",amount_received:null!=r.flow_amount_received?String(r.flow_amount_received):"",payment_status:r.flow_payment_status||"挂账",remark:r.flow_remark||"",flow_index_prev:r.flow_index_prev,flow_index_curr:r.flow_index_curr,flow_volume:r.flow_volume_m3,flow_unit_price:r.flow_unit_price||r.unit_price||"",flow_amount_should:r.flow_amount_should,flow_amount_received:r.flow_amount_received,flow_payment_status:r.flow_payment_status||"挂账",flow_remark:r.flow_remark||""}),this.header.customer_id&&await this.loadCustomerDeposits(this.header.customer_id),this.syncSelectIndexesFromHeader()}catch(l){console.error("loadSaleForEdit error",l),k({title:"加载销售记录失败",icon:"none"})}},syncSelectIndexesFromHeader(){if(this.header.customer_id&&Array.isArray(this.customers)){const e=this.customers.findIndex((e=>e._id===this.header.customer_id));this.customerIndex=e}if(Array.isArray(this.deliveryList)){if(this.header.delivery_man_1){const e=this.deliveryList.findIndex((e=>e.name===this.header.delivery_man_1));this.deliveryIndex1=e}if(this.header.delivery_man_2){const e=this.deliveryList.findIndex((e=>e.name===this.header.delivery_man_2));this.deliveryIndex2=e}}if(this.header.vehicle_id&&Array.isArray(this.vehicleList)){const e=this.vehicleList.findIndex((e=>e._id===this.header.vehicle_id));this.vehicleIndex=e}},onFlowSettleChange(e){const t={...this.flowSettle||{},...e||{}};t.flow_index_prev=t.prev,t.flow_index_curr=t.curr,t.flow_volume=t.volume,t.flow_amount_should=t.amount,t.flow_amount_received=t.amount_received,t.flow_payment_status=t.payment_status,t.flow_remark=t.remark,t.flow_unit_price=this.header.unit_price,this.flowSettle=t},onUpdateFlowRatio(e){this.flowTheoryRatio=e||0},goBack(){w().length>1?N():v({url:"/pages/dashboard/index"})},onCustomerChange(e){const t=Number(e.detail.value);this.customerIndex=t;const s=this.customers[t];s?(this.header.customer_id=s._id,this.header.customer_name=s.name,this.loadCustomerDeposits(s._id)):(this.header.customer_id="",this.header.customer_name="",this.customerDeposits=[])},onCustomerInput(e){const t=e.detail.value.trim();if(this.customerKeyword=t,!t)return this.customerSuggests=[],this.header.customer_id="",void(this.header.customer_name="");const s=(this.customers||[]).filter((e=>!(!e||!e.name)&&-1!==e.name.indexOf(t)));this.customerSuggests=s.slice(0,20)},onSelectCustomer(e){e&&(this.header.customer_id=e._id,this.header.customer_name=e.name,this.customerKeyword=e.name,this.customerSuggests=[],this.loadCustomerDeposits(e._id))},onDeliveryChange1(e){const t=Number(e.detail.value);this.deliveryIndex1=t;const s=this.deliveryList[t];this.header.delivery_man_1=s?s.name:""},onDeliveryChange2(e){const t=Number(e.detail.value);this.deliveryIndex2=t;const s=this.deliveryList[t];this.header.delivery_man_2=s?s.name:""},onVehicleChange(e){const t=Number(e.detail.value);this.vehicleIndex=t;const s=this.vehicleList[t];if(s){this.header.vehicle_id=s._id||"";const e=s.car_no||s.plate_no||s.plateNo||"";this.header.car_no=e}else this.header.vehicle_id="",this.header.car_no=""},resetForm(){const e=this.header.date,t=this.bizMode||"bottle",s=this.header.payment_status||"挂账",a=this.header.price_unit||"kg";this.header={date:e,customer_id:"",customer_name:"",delivery_man_1:"",delivery_man_2:"",vehicle_id:"",car_no:"",unit_price:"",price_unit:a,amount_received:"",payment_status:s,remark:"",biz_mode:t,truck_gross:"",truck_tare:"",truck_net:""},this.truckNetManual=!1,this.flowTheoryRatio=this.defaultRatio,this.flowSettle={prev:"",curr:"",volume:"",amount:"",amount_received:"",payment_status:"挂账",remark:"",flow_index_prev:"",flow_index_curr:"",flow_volume:"",flow_unit_price:"",flow_amount_should:"",flow_amount_received:"",flow_payment_status:"挂账",flow_remark:""},this.customerIndex=-1,this.deliveryIndex1=-1,this.deliveryIndex2=-1,this.vehicleIndex=-1,this.customerDeposits=[],this.outBottles=[{number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1}],this.backBottles=[{number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1}],this.depositBottles=[this.createDepositRow()]},updateTruckNet(){if(this.truckNetManual)return;const e=Number(this.header.truck_gross),t=Number(this.header.truck_tare);isNaN(e)||isNaN(t)?this.header.truck_net="":this.header.truck_net=(e-t).toFixed(2)},onTruckWeightBlur(){this.updateTruckNet()},async searchBottle(t){const s=t.trim();if(!s)return[];if(this.bottleSearchCache[s])return this.bottleSearchCache[s];if(this.bottleSearchPending[s])return this.bottleSearchPending[s];const a=I(),l=e.callFunction({name:"crm-bottle",data:{action:"search",token:a,data:{keyword:s,limit:20}}}).then((e=>{var t;const a=(null==(t=e.result)?void 0:t.data)||[];return this.$set(this.bottleSearchCache,s,a),delete this.bottleSearchPending[s],a})).catch((e=>(console.error("searchBottle error",e),delete this.bottleSearchPending[s],[])));return this.bottleSearchPending[s]=l,l},async doBottleSuggest(e,t,s){const a=await this.searchBottle(s);const l=("out"===e?this.outBottles:"back"===e?this.backBottles:this.depositBottles)[t];l&&l.number.trim()===s.trim()&&this.$set(l,"suggestions",a)},async loadCustomers(){var t;try{const s=I(),a=await e.callFunction({name:"crm-customer",data:{action:"list",token:s,data:{}}});if(this.handleAuthError(a))return;0===(null==(t=a.result)?void 0:t.code)&&(this.customers=a.result.data||[],this.syncSelectIndexesFromHeader())}catch(s){console.error("加载客户异常",s)}},async loadCustomerDeposits(t){var s;if(this.customerDeposits=[],t)try{const a=I(),l=await e.callFunction({name:"crm-sale",data:{action:"customerDeposits",token:a,data:{customerId:t}}});if(this.handleAuthError(l))return;0===(null==(s=l.result)?void 0:s.code)&&Array.isArray(l.result.data)&&(this.customerDeposits=l.result.data)}catch(a){console.error("loadCustomerDeposits error",a)}},async loadLastFlowIndexForCustomer(t){var s;if(t)try{const a=I(),l=await e.callFunction({name:"crm-sale",data:{action:"getLastFlowRecord",token:a,data:{customerId:t}}});if(this.handleAuthError(l))return;const r=null==(s=l.result)?void 0:s.data;if(r&&null!=r.flowIndexCurr){const e=r.flowIndexCurr;this.flowSettle.flow_index_prev=e,this.flowSettle.prev=e}else this.flowSettle.flow_index_prev="",this.flowSettle.prev=""}catch(a){console.error("loadLastFlowIndexForCustomer error",a)}},async loadDeliveryList(){var t;try{const s=I(),a=await e.callFunction({name:"crm-delivery",data:{action:"list",token:s,data:{}}});if(this.handleAuthError(a))return;0===(null==(t=a.result)?void 0:t.code)&&(this.deliveryList=a.result.data||[],this.syncSelectIndexesFromHeader())}catch(s){console.error("加载配送员异常",s)}},async loadVehicles(){var t;try{const s=I(),a=await e.callFunction({name:"crm-vehicle",data:{action:"list",token:s,data:{}}});if(this.handleAuthError(a))return;0===(null==(t=a.result)?void 0:t.code)&&(this.vehicleList=a.result.data||[],this.syncSelectIndexesFromHeader())}catch(s){console.error("加载车辆异常",s)}},onDateChange(e){this.header.date=e.detail.value},onPriceUnitChange(e){const t=Number(e.detail.value);this.priceUnitIndex=t,this.header.price_unit=0===t?"kg":1===t?"bottle":"m3"},onPaymentStatusChange(e){const t=Number(e.detail.value);this.paymentStatusIndex=t,this.header.payment_status=this.paymentStatusOptions[t]},addOutBottleRow(){this.outBottles.push({number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1})},removeOutBottleRow(e){var t;this.outBottles.length<=1||(null==(t=this.outBottles[e].number)||t.trim(),this.outBottles.splice(e,1))},async onOutBottleInput(e,t){const s=t.detail.value.trim(),a=this.outBottles[e];a.number=s,a.fromSelect=!1,a.exists=null,a.bottleId=null,s?this.debouncedBottleSuggest("out",e,s):a.suggestions=[]},onSelectOutBottle(e,t){const s=this.outBottles[e];s.number=t.number,s.tare=null!=t.tare_weight?String(t.tare_weight):s.tare,s.bottleId=t._id,s.exists=!0,s.fromSelect=!0,s.suggestions=[],s.netManual=!1,this.updateOutNet(e)},async onOutBottleBlur(t){var s;const a=this.outBottles[t],l=a.number.trim();if(l&&(!a.suggestions.length||a.fromSelect)&&!a.fromSelect)try{const r=I(),o=await e.callFunction({name:"crm-bottle",data:{action:"getByNumber",token:r,data:{number:l}}});if(this.handleAuthError(o))return;const i=null==(s=o.result)?void 0:s.data;i?(a.exists=!0,a.bottleId=i._id,a.tare||null==i.tare_weight||(a.tare=String(i.tare_weight)),a.netManual=!1,this.updateOutNet(t)):(a.exists=!1,a.bottleId=null,b({title:"提示",content:`系统中不存在瓶号 ${l}。\n保存时会自动加入瓶子库，请记得填写皮重。`,showCancel:!1}))}catch(r){console.error("check bottle error",r)}},updateOutNet(e){const t=this.outBottles[e];if(t.netManual)return;const s=Number(t.gross),a=Number(t.tare);isNaN(s)||isNaN(a)||(t.net=(s-a).toFixed(2))},addBackBottleRow(){this.backBottles.push({number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1})},removeBackBottleRow(e){this.backBottles.length<=1||this.backBottles.splice(e,1)},async onBackBottleInput(e,t){const s=t.detail.value.trim(),a=this.backBottles[e];a.number=s,a.fromSelect=!1,a.exists=null,a.bottleId=null,s?this.debouncedBottleSuggest("back",e,s):a.suggestions=[]},onSelectBackBottle(e,t){const s=this.backBottles[e];s.number=t.number,s.tare=null!=t.tare_weight?String(t.tare_weight):s.tare,s.bottleId=t._id,s.exists=!0,s.fromSelect=!0,s.suggestions=[],s.netManual=!1,this.updateBackNet(e)},async onBackBottleBlur(t){var s;const a=this.backBottles[t],l=a.number.trim();if(l&&(!a.suggestions.length||a.fromSelect)&&!a.fromSelect)try{const r=I(),o=await e.callFunction({name:"crm-bottle",data:{action:"getByNumber",token:r,data:{number:l}}});if(this.handleAuthError(o))return;const i=null==(s=o.result)?void 0:s.data;i?(a.exists=!0,a.bottleId=i._id,a.tare||null==i.tare_weight||(a.tare=String(i.tare_weight)),a.netManual=!1,this.updateBackNet(t)):(a.exists=!1,a.bottleId=null,b({title:"提示",content:`系统中不存在瓶号 ${l}。\n保存时会自动加入瓶子库，请记得填写皮重。`,showCancel:!1}))}catch(r){console.error("check back bottle error",r)}},updateBackNet(e){const t=this.backBottles[e];if(t.netManual)return;const s=Number(t.gross),a=Number(t.tare);isNaN(s)||isNaN(a)?t.net="":t.net=(s-a).toFixed(2)},addDepositBottleRow(){this.depositBottles.push(this.createDepositRow())},removeDepositBottleRow(e){this.depositBottles.length<=1||this.depositBottles.splice(e,1)},async onDepositBottleInput(e,t){const s=t.detail.value.trim(),a=this.depositBottles[e];a.number=s,a.fromSelect=!1,a.exists=null,a.bottleId=null,s?this.debouncedBottleSuggest("deposit",e,s):a.suggestions=[]},onSelectDepositBottle(e,t){const s=this.depositBottles[e];s.number=t.number,s.bottleId=t._id,s.exists=!0,s.fromSelect=!0,s.suggestions=[]},async onDepositBottleBlur(t){var s;const a=this.depositBottles[t],l=a.number.trim();if(l&&(!a.suggestions.length||a.fromSelect)&&!a.fromSelect)try{const t=I(),r=await e.callFunction({name:"crm-bottle",data:{action:"getByNumber",token:t,data:{number:l}}});if(this.handleAuthError(r))return;const o=null==(s=r.result)?void 0:s.data;o?(a.exists=!0,a.bottleId=o._id):(a.exists=!1,a.bottleId=null,b({title:"提示",content:`系统中不存在瓶号 ${l}，\n保存时会自动加入瓶子库，后续可在瓶子管理中补充皮重等信息。`,showCancel:!1}))}catch(r){console.error("check deposit bottle error",r)}},createDepositRow:(e="")=>({number:e,bottleId:null,exists:null,suggestions:[],fromSelect:!1}),async ensureNewBottlesCreated(){const t=I(),s=[],a=(s,a,l)=>{const r={number:s};return l&&(r.status=l),"number"!=typeof a||Number.isNaN(a)||(r.tare_weight=a),e.callFunction({name:"crm-bottle",data:{action:"quickCreate",token:t,data:r}})},l=async(l,r,o)=>{if(!l||!l.number)return;const i=String(l.number).trim();if(!i)return;let u=null,n=!1;if(r){const e=Number(l.tare);Number.isNaN(e)||(u=e,n=!0)}if(!1!==l.exists){if(null==l.exists)try{const c=await e.callFunction({name:"crm-bottle",data:{action:"getByNumber",token:t,data:{number:i}}});if(this.handleAuthError(c))return;const d=c.result&&c.result.data;if(d&&d._id)return l.exists=!0,void(l.bottleId=d._id);if(r&&!n)return;s.push(a(i,r?u:void 0,o)),l.exists=!1}catch(c){console.error("ensureNewBottlesCreated getByNumber error",c)}}else{if(r&&!n)return;s.push(a(i,r?u:void 0,o))}};for(const e of this.outBottles)await l(e,!0,"at_customer");for(const e of this.backBottles)await l(e,!0,"in_station");if(Array.isArray(this.depositBottles))for(const e of this.depositBottles)await l(e,!1,"at_customer");if(!s.length)return!0;try{return await Promise.all(s),!0}catch(r){return console.error("ensureNewBottlesCreated quickCreate error",r),k({title:"自动创建瓶子失败",icon:"none"}),!1}},validateBeforeSubmit(){if(!this.header.date)return k({title:"请选择日期",icon:"none"}),!1;const e=(this.header.customer_name||"").trim();if(!this.header.customer_id&&!e)return k({title:"请选择客户",icon:"none"}),!1;if(e.length>50)return k({title:"客户名称过长",icon:"none"}),!1;const t=this.header.unit_price;if(""!==t&&(isNaN(Number(t))||Number(t)<0))return k({title:"请填写正确的单价",icon:"none"}),!1;if("truck"===this.bizMode){const e=Number(this.header.truck_gross),t=Number(this.header.truck_tare);if(isNaN(e)||isNaN(t))return k({title:"请完善整车毛重/皮重",icon:"none"}),!1;if(e<=t)return k({title:"毛重需大于皮重",icon:"none"}),!1}if(!this.outBottles.some((e=>e.number&&e.number.trim()))&&"m3"!==this.header.price_unit)return k({title:"请至少录入一个出瓶瓶号",icon:"none"}),!1;const s=["gross","tare","net"],a=[...this.outBottles,...this.backBottles];for(const l of a)for(const e of s){const t=l[e];if(""!==t&&null!=t&&isNaN(Number(t)))return k({title:"重量字段需为数字",icon:"none"}),!1}return!0},async handleSubmit(){var t,s;if(!this.validateBeforeSubmit())return;if(!(await this.ensureNewBottlesCreated()))return;const a=I(),l=(this.header.customer_name||"").trim();this.header.customer_name=l;let r=this.header.unit_price;"m3"===this.header.price_unit&&this.flowSettle.flow_unit_price&&(r=this.flowSettle.flow_unit_price);let o=this.header.amount_received,i=this.header.payment_status;"m3"===this.header.price_unit&&(""!==this.flowSettle.flow_amount_received&&(o=this.flowSettle.flow_amount_received),this.flowSettle.flow_payment_status&&(i=this.flowSettle.flow_payment_status));const u={date:this.header.date,customerId:this.header.customer_id,customerName:l,unitPrice:r,priceUnit:this.header.price_unit,delivery1:this.header.delivery_man_1,delivery2:this.header.delivery_man_2,vehicleId:this.header.vehicle_id,car_no:this.header.car_no,remark:this.header.remark,amountReceived:o,paymentStatus:i,paymentNote:"",bizMode:this.bizMode,truckGross:this.header.truck_gross,truckTare:this.header.truck_tare,truckNet:this.header.truck_net,flow_theory_ratio:this.flowTheoryRatio};"m3"===this.header.price_unit&&Object.assign(u,{flow_index_prev:this.flowSettle.flow_index_prev,flow_index_curr:this.flowSettle.flow_index_curr,flow_volume:this.flowSettle.flow_volume,flow_unit_price:this.flowSettle.flow_unit_price,flow_amount_should:this.flowSettle.flow_amount_should,flow_amount_received:this.flowSettle.flow_amount_received,flow_payment_status:this.flowSettle.flow_payment_status,flow_remark:this.flowSettle.flow_remark});const n=this.outBottles.map((e=>({bottleInput:e.number.trim(),gross:e.gross,tare:e.tare,net:e.net,bottleId:e.bottleId}))),c=this.backBottles.map((e=>({bottleInput:e.number.trim(),gross:e.gross,tare:e.tare,net:e.net,bottleId:e.bottleId}))),d=new Map((this.depositBottles||[]).map((e=>[(e.number||"").trim(),e.bottleId||null])).filter((([e])=>!!e))),m={base:u,outRows:n,backRows:c,depositRows:this.liveDeposits.map((e=>({bottleInput:e,bottleId:d.get(e)||null}))),source:"manual-v2"},h=this.isEditing?"updateV2":"createV2",_=this.isEditing?{action:h,token:a,data:{id:this.editId,...m}}:{action:h,token:a,data:m};this.submitting=!0;try{const a=await e.callFunction({name:"crm-sale",data:_});if(this.handleAuthError(a))return;0===(null==(t=a.result)?void 0:t.code)?(k({title:a.result.msg||(this.isEditing?"修改已保存":"保存成功"),icon:"success",duration:2e3}),this.isEditing?setTimeout((()=>{this.goBack()}),500):this.resetForm&&this.resetForm()):k({title:(null==(s=a.result)?void 0:s.msg)||"保存失败",icon:"none"})}catch(f){k({title:"请求异常",icon:"none"})}finally{this.submitting=!1}}}},[["render",function(e,b,y,v,k,w){const N=S("BackToDashboardBar"),B=m,I=h,C=S("SaleBasicInfoCard"),F=_,D=x,A=S("FlowTheoryCard"),T=f,V=g,M=S("FlowSettlementCard");return t(),s(I,{class:"sale-page"},{default:a((()=>[l(I,{class:"sale-inner"},{default:a((()=>[l(N,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),l(I,{class:"page-header"},{default:a((()=>[l(I,{class:"page-header-left"},{default:a((()=>[l(I,{class:"page-icon"},{default:a((()=>[l(B,{class:"page-icon-text"},{default:a((()=>[r("记")])),_:1})])),_:1}),l(I,{class:"page-header-text"},{default:a((()=>[l(B,{class:"page-title"},{default:a((()=>[r("新增销售记录")])),_:1}),l(B,{class:"page-sub"},{default:a((()=>[r(" 分别记录出瓶、回瓶、存瓶与结算信息，方便后续统计与对账 ")])),_:1})])),_:1})])),_:1}),l(I,{class:"page-header-right"},{default:a((()=>[l(I,{class:"tag-soft"},{default:a((()=>[l(B,{class:"tag-dot"}),l(B,{class:"tag-text"},{default:a((()=>[r("今日 · "+d(k.todayText),1)])),_:1})])),_:1})])),_:1})])),_:1}),l(C,{value:k.header,onInput:b[0]||(b[0]=e=>k.header=e),customers:k.customers,deliveryList:k.deliveryList,vehicleList:k.vehicleList},null,8,["value","customers","deliveryList","vehicleList"]),w.showBottleCards?(t(),s(I,{key:0,class:"card-row"},{default:a((()=>[l(I,{class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[r("出瓶")])),_:1}),l(B,{class:"card-sub"},{default:a((()=>[r("本次送出去的瓶子，可添加多行")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[(t(!0),i(n,null,u(k.outBottles,((e,o)=>(t(),s(I,{key:"out-"+o,class:"bottle-row"},{default:a((()=>[l(I,{class:"row-header"},{default:a((()=>[l(I,{class:"row-header-left"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("瓶号")])),_:1})])),_:1}),k.outBottles.length>1?(t(),s(I,{key:0,class:"row-header-right"},{default:a((()=>[l(B,{class:"delete-text",onClick:e=>w.removeOutBottleRow(o)},{default:a((()=>[r("删除")])),_:2},1032,["onClick"])])),_:2},1024)):c("",!0)])),_:2},1024),l(I,{class:"form-item"},{default:a((()=>[l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",modelValue:e.number,"onUpdate:modelValue":t=>e.number=t,placeholder:"例如 207，支持模糊搜索",onInput:e=>w.onOutBottleInput(o,e),onBlur:e=>w.onOutBottleBlur(o)},null,8,["modelValue","onUpdate:modelValue","onInput","onBlur"])])),_:2},1024),e.suggestions&&e.suggestions.length?(t(),s(I,{key:0,class:"bottle-suggest"},{default:a((()=>[(t(!0),i(n,null,u(e.suggestions,(e=>(t(),s(I,{key:e._id,class:"suggest-item",onClick:p((t=>w.onSelectOutBottle(o,e)),["stop"])},{default:a((()=>[l(B,{class:"suggest-no"},{default:a((()=>[r(d(e.number),1)])),_:2},1024),l(B,{class:"suggest-sub"},{default:a((()=>[r(" 皮重 "+d(null!=e.tare_weight?e.tare_weight:"-")+"kg · "+d(k.statusTextMap[e.status]||"未知状态"),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:2},1024)):c("",!0)])),_:2},1024),l(I,{class:"form-row"},{default:a((()=>[l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("毛重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"kg",modelValue:e.gross,"onUpdate:modelValue":t=>e.gross=t,onBlur:e=>w.updateOutNet(o)},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024)])),_:2},1024),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("皮重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"kg",modelValue:e.tare,"onUpdate:modelValue":t=>e.tare=t,onBlur:e=>w.updateOutNet(o)},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024)])),_:2},1024),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("净重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"若不填将按 毛重-皮重 自动计算",modelValue:e.net,"onUpdate:modelValue":t=>e.net=t,onInput:t=>e.netManual=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])])),_:2},1024)])),_:2},1024)])),_:2},1024),l(I,{class:"row-divider"})])),_:2},1024)))),128)),l(I,{class:"btn-row-inline"},{default:a((()=>[l(D,{class:"btn-soft",onClick:w.addOutBottleRow},{default:a((()=>[r(" + 添加出瓶 ")])),_:1},8,["onClick"])])),_:1}),l(I,{class:"summary-chip"},{default:a((()=>[l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[r("本次出瓶净重合计：")])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[r(d(w.totalOutNet)+" kg",1)])),_:1})])),_:1}),w.totalOutNetDetail?(t(),s(I,{key:0,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[r(d(w.totalOutNetDetail),1)])),_:1})])),_:1})):c("",!0)])),_:1})])),_:1})])),_:1}),l(I,{class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[r("回收瓶")])),_:1}),l(B,{class:"card-sub"},{default:a((()=>[r("本次从客户处回收的瓶子，可添加多行")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[(t(!0),i(n,null,u(k.backBottles,((e,o)=>(t(),s(I,{key:"back-"+o,class:"bottle-row"},{default:a((()=>[l(I,{class:"row-header"},{default:a((()=>[l(I,{class:"row-header-left"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("回收瓶号")])),_:1})])),_:1}),k.backBottles.length>1?(t(),s(I,{key:0,class:"row-header-right"},{default:a((()=>[l(B,{class:"delete-text",onClick:e=>w.removeBackBottleRow(o)},{default:a((()=>[r("删除")])),_:2},1032,["onClick"])])),_:2},1024)):c("",!0)])),_:2},1024),l(I,{class:"form-item"},{default:a((()=>[l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",modelValue:e.number,"onUpdate:modelValue":t=>e.number=t,placeholder:"例如 114 / 207",onInput:e=>w.onBackBottleInput(o,e),onBlur:e=>w.onBackBottleBlur(o)},null,8,["modelValue","onUpdate:modelValue","onInput","onBlur"])])),_:2},1024),e.suggestions&&e.suggestions.length?(t(),s(I,{key:0,class:"bottle-suggest"},{default:a((()=>[(t(!0),i(n,null,u(e.suggestions,(e=>(t(),s(I,{key:e._id,class:"suggest-item",onClick:p((t=>w.onSelectBackBottle(o,e)),["stop"])},{default:a((()=>[l(B,{class:"suggest-no"},{default:a((()=>[r(d(e.number),1)])),_:2},1024),l(B,{class:"suggest-sub"},{default:a((()=>[r(" 皮重 "+d(null!=e.tare_weight?e.tare_weight:"-")+"kg · "+d(k.statusTextMap[e.status]||"未知状态"),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:2},1024)):c("",!0)])),_:2},1024),l(I,{class:"form-row"},{default:a((()=>[l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("毛重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"kg",modelValue:e.gross,"onUpdate:modelValue":t=>e.gross=t,onBlur:e=>w.updateBackNet(o)},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024)])),_:2},1024),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("皮重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"kg",modelValue:e.tare,"onUpdate:modelValue":t=>e.tare=t,onBlur:e=>w.updateBackNet(o)},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024)])),_:2},1024),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("净重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"若不填将按 毛重-皮重 自动计算，可手动改为负数/正数",modelValue:e.net,"onUpdate:modelValue":t=>e.net=t,onInput:t=>e.netManual=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])])),_:2},1024)])),_:2},1024)])),_:2},1024),l(I,{class:"row-divider"})])),_:2},1024)))),128)),l(I,{class:"btn-row-inline"},{default:a((()=>[l(D,{class:"btn-soft",onClick:w.addBackBottleRow},{default:a((()=>[r(" + 添加回瓶 ")])),_:1},8,["onClick"])])),_:1}),l(I,{class:"summary-chip-column"},{default:a((()=>[l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[r("本次回瓶净重合计：")])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[r(d(w.totalBackNet)+" kg",1)])),_:1})])),_:1}),w.totalBackNetDetail?(t(),s(I,{key:0,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[r(d(w.totalBackNetDetail),1)])),_:1})])),_:1})):c("",!0),l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[r("按单价结算：")])),_:1}),l(B,{class:o(["summary-value",{"summary-positive":w.backAmount<0,"summary-negative":w.backAmount>0}])},{default:a((()=>[r(d(w.backAmountAbs)+" 元 ",1)])),_:1},8,["class"]),l(B,{class:"summary-tip"},{default:a((()=>[r(d(w.backAmountDirectionText),1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})):c("",!0),l(I,{class:"card-row"},{default:a((()=>["bottle"===w.bizMode?(t(),s(I,{key:0,class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[r("存瓶号")])),_:1}),l(B,{class:"card-sub"},{default:a((()=>[r("记录当前留在客户处的瓶子，可添加多行")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[w.remainingDeposits.length?(t(),s(I,{key:0,class:"deposit-inventory"},{default:a((()=>[l(B,{class:"inventory-label"},{default:a((()=>[r("客户存瓶：")])),_:1}),l(I,{class:"inventory-list"},{default:a((()=>[(t(!0),i(n,null,u(w.remainingDeposits,(e=>(t(),s(I,{key:e,class:"inventory-chip"},{default:a((()=>[r(d(e),1)])),_:2},1024)))),128))])),_:1})])),_:1})):c("",!0),(t(!0),i(n,null,u(k.depositBottles,((e,o)=>(t(),s(I,{key:"dep-"+o,class:"bottle-row"},{default:a((()=>[l(I,{class:"row-header"},{default:a((()=>[l(I,{class:"row-header-left"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("存瓶号")])),_:1})])),_:1}),k.depositBottles.length>1?(t(),s(I,{key:0,class:"row-header-right"},{default:a((()=>[l(B,{class:"delete-text",onClick:e=>w.removeDepositBottleRow(o)},{default:a((()=>[r("删除")])),_:2},1032,["onClick"])])),_:2},1024)):c("",!0)])),_:2},1024),l(I,{class:"form-item"},{default:a((()=>[l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",modelValue:e.number,"onUpdate:modelValue":t=>e.number=t,placeholder:"例如 207",onInput:e=>w.onDepositBottleInput(o,e),onBlur:e=>w.onDepositBottleBlur(o)},null,8,["modelValue","onUpdate:modelValue","onInput","onBlur"])])),_:2},1024),e.suggestions&&e.suggestions.length?(t(),s(I,{key:0,class:"bottle-suggest"},{default:a((()=>[(t(!0),i(n,null,u(e.suggestions,(e=>(t(),s(I,{key:e._id,class:"suggest-item",onClick:p((t=>w.onSelectDepositBottle(o,e)),["stop"])},{default:a((()=>[l(B,{class:"suggest-no"},{default:a((()=>[r(d(e.number),1)])),_:2},1024),l(B,{class:"suggest-sub"},{default:a((()=>[r(" 皮重 "+d(null!=e.tare_weight?e.tare_weight:"-")+"kg · "+d(k.statusTextMap[e.status]||"未知状态"),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:2},1024)):c("",!0)])),_:2},1024),l(I,{class:"row-divider"})])),_:2},1024)))),128)),l(I,{class:"btn-row-inline"},{default:a((()=>[l(D,{class:"btn-soft",onClick:w.addDepositBottleRow},{default:a((()=>[r(" + 添加存瓶 ")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})):c("",!0),w.isFlowPriceMode?(t(),s(A,{key:1,totalOutNet:w.flowTheoryOutNet,totalBackNet:w.flowTheoryBackNet,ratio:k.flowTheoryRatio,onUpdateRatio:w.onUpdateFlowRatio},null,8,["totalOutNet","totalBackNet","ratio","onUpdateRatio"])):c("",!0),"truck"===w.bizMode?(t(),s(I,{key:2,class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[r("整车信息")])),_:1}),l(B,{class:"card-sub"},{default:a((()=>[r("记录整车毛重 / 皮重 / 净重，用于整车结算")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[l(I,{class:"form-row"},{default:a((()=>[l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("毛重 (吨)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"整车毛重（吨）",modelValue:w.truckGrossTon,"onUpdate:modelValue":b[1]||(b[1]=e=>w.truckGrossTon=e),onBlur:w.onTruckWeightBlur},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("皮重 (吨)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"车辆皮重（吨）",modelValue:w.truckTareTon,"onUpdate:modelValue":b[2]||(b[2]=e=>w.truckTareTon=e),onBlur:w.onTruckWeightBlur},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("净重 (吨)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"若不填按 毛重-皮重 自动算（吨）",modelValue:w.truckNetTon,"onUpdate:modelValue":b[3]||(b[3]=e=>w.truckNetTon=e)},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),l(I,{class:"summary-chip"},{default:a((()=>[l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[r("整车净重：")])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[r(d((w.truckNetNumber/1e3).toFixed(2))+" 吨 ",1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})):c("",!0),w.isFlowPriceMode?(t(),s(M,{key:4,unitPrice:k.header.unit_price,prevIndex:k.flowSettle.prev,currIndex:k.flowSettle.curr,amountReceived:k.flowSettle.amount_received,paymentStatus:k.flowSettle.payment_status,remark:k.flowSettle.remark,paymentStatusOptions:k.paymentStatusOptions,onInput:w.onFlowSettleChange},null,8,["unitPrice","prevIndex","currIndex","amountReceived","paymentStatus","remark","paymentStatusOptions","onInput"])):(t(),s(I,{key:3,class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[r("结算与其他")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[l(I,{class:"form-row"},{default:a((()=>[l(I,{class:"form-item col-half"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("实收金额")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"本次实际收了多少，可为 0",modelValue:k.header.amount_received,"onUpdate:modelValue":b[4]||(b[4]=e=>k.header.amount_received=e)},null,8,["modelValue"])])),_:1})])),_:1}),l(I,{class:"form-item col-half"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("付款状态")])),_:1}),l(T,{mode:"selector",range:k.paymentStatusOptions,value:k.paymentStatusIndex,onChange:w.onPaymentStatusChange},{default:a((()=>[l(I,{class:"input-wrapper"},{default:a((()=>[l(I,{class:"picker"},{default:a((()=>[l(B,null,{default:a((()=>[r(d(w.paymentStatusLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1}),l(I,{class:"summary-chip-column"},{default:a((()=>[l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[r(d("truck"===w.bizMode?"整车应收：":"本次出瓶应收："),1)])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[r(d(w.outAmount)+" 元",1)])),_:1})])),_:1}),w.outAmountDetail?(t(),s(I,{key:0,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[r(d(w.outAmountDetail),1)])),_:1})])),_:1})):c("",!0),l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[r("回瓶结算调整：")])),_:1}),l(B,{class:o(["summary-value",{"summary-positive":w.backAmount<0,"summary-negative":w.backAmount>0}])},{default:a((()=>[r(d(w.backAmountDisplayForSummary)+" 元 ",1)])),_:1},8,["class"])])),_:1}),w.backAmountDetail?(t(),s(I,{key:1,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[r(d(w.backAmountDetail),1)])),_:1})])),_:1})):c("",!0),l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[r(d("truck"===w.bizMode?"整车净重：":"出瓶与回瓶总净重："),1)])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[r(d(w.totalInOutNet)+" kg",1)])),_:1})])),_:1}),w.totalInOutNetDetail?(t(),s(I,{key:2,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[r(d(w.totalInOutNetDetail),1)])),_:1})])),_:1})):c("",!0),l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label-strong"},{default:a((()=>[r("理论应收合计：")])),_:1}),l(B,{class:"summary-value-strong"},{default:a((()=>[r(d(w.shouldReceive)+" 元",1)])),_:1})])),_:1}),w.shouldReceiveDetail?(t(),s(I,{key:3,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[r(d(w.shouldReceiveDetail),1)])),_:1})])),_:1})):c("",!0)])),_:1}),l(I,{class:"form-item"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[r("备注")])),_:1}),l(V,{class:"textarea",placeholder:"例如：欠对方7公斤（2月13日清）",modelValue:k.header.remark,"onUpdate:modelValue":b[5]||(b[5]=e=>k.header.remark=e)},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}))])),_:1}),l(I,{class:"btn-row-bottom"},{default:a((()=>[l(D,{class:"btn-soft",onClick:w.resetForm},{default:a((()=>[r("重置")])),_:1},8,["onClick"]),l(D,{class:"btn-primary",type:"primary",loading:k.submitting,onClick:w.handleSubmit},{default:a((()=>[r(" 保存销售记录 ")])),_:1},8,["loading","onClick"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-cac7b137"]]);export{T as default};
