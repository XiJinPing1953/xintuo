import{j as e,s as t,r as a,t as l,k as s,q as i,c as o,w as n,i as c,o as d,d as r,e as u,p as m,l as f,u as h,v as _,F as p,f as g,g as k,I as v,D as y}from"./index-C85BGToL.js";import{B as b}from"./BackToDashboardBar.BBeceW6P.js";import{g as w}from"./auth.yulpUJA0.js";import{_ as C}from"./_plugin-vue_export-helper.BCo6x5W8.js";const T=C({components:{BackToDashboardBar:b},data:()=>({userInfo:{},keyword:"",loading:!1,vehicles:[],total:0,showEdit:!1,saving:!1,form:{_id:"",plate_no:"",name:"",remark:""}}),computed:{isAdmin(){const e=this.userInfo&&this.userInfo.role;return!e||"admin"===e}},onLoad(){this.userInfo=w()||{},this.loadList()},methods:{getToken:()=>e("crm_token")||e("token")||"",async loadList(){const e=this.getToken();if(!e)return t({title:"请先登录",icon:"none"}),void setTimeout((()=>{a({url:"/pages/login/login"})}),1200);this.loading=!0;try{const s=(await l.callFunction({name:"crm-vehicle",data:{action:"list",token:e,data:{keyword:this.keyword,page:1,pageSize:200}}})).result||{};if(401===s.code)return t({title:s.msg||"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>{a({url:"/pages/login/login"})}),1200);if(0!==s.code)return void t({title:s.msg||"加载失败",icon:"none"});this.vehicles=s.data||s.list||[],this.total=s.total||this.vehicles.length}catch(s){console.error("crm-vehicle list error:",s),t({title:"请求出错",icon:"none"})}finally{this.loading=!1}},openEdit(e){if(!this.isAdmin)return t({title:"当前账号无权限编辑车辆",icon:"none"});this.form=e?{_id:e._id,plate_no:e.plate_no||"",name:e.name||"",remark:e.remark||""}:{_id:"",plate_no:"",name:"",remark:""},this.showEdit=!0},closeEdit(){this.saving||(this.showEdit=!1)},async submitEdit(){if(this.saving)return;if(!this.isAdmin)return t({title:"当前账号无权限保存车辆信息",icon:"none"});const e=(this.form.plate_no||"").trim();if(!e)return t({title:"请填写车牌号",icon:"none"});const s=this.getToken();if(!s)return t({title:"请先登录",icon:"none"}),void setTimeout((()=>{a({url:"/pages/login/login"})}),1200);this.saving=!0;const i={plate_no:e,name:(this.form.name||"").trim(),remark:(this.form.remark||"").trim()};let o="create";this.form._id&&(o="update",i.id=this.form._id);try{const e=(await l.callFunction({name:"crm-vehicle",data:{action:o,token:s,data:i}})).result||{};if(401===e.code)return t({title:e.msg||"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>{a({url:"/pages/login/login"})}),1200);if(0!==e.code)return void t({title:e.msg||"保存失败",icon:"none"});t({title:"保存成功",icon:"success"}),this.showEdit=!1,this.loadList()}catch(n){console.error("crm-vehicle save error:",n),t({title:"保存失败",icon:"none"})}finally{this.saving=!1}},confirmRemove(e){if(!this.isAdmin)return t({title:"当前账号无权限删除车辆",icon:"none"});s({title:"删除车辆",content:`确定删除车辆【${e.plate_no||e.name||"未命名"}】吗？\n（仅删除车辆档案，历史销售记录中的车牌号不会被修改）`,success:async s=>{if(!s.confirm)return;const i=this.getToken();if(!i)return t({title:"请先登录",icon:"none"}),void setTimeout((()=>{a({url:"/pages/login/login"})}),1200);try{const s=(await l.callFunction({name:"crm-vehicle",data:{action:"remove",token:i,data:{id:e._id}}})).result||{};if(401===s.code)return t({title:s.msg||"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>{a({url:"/pages/login/login"})}),1200);if(0!==s.code)return void t({title:s.msg||"删除失败",icon:"none"});t({title:"已删除",icon:"success"}),this.loadList()}catch(o){console.error("crm-vehicle remove error:",o),t({title:"删除失败",icon:"none"})}}})}}},[["render",function(e,t,a,l,s,b){const w=i("BackToDashboardBar"),C=g,T=c,x=k,E=v,V=y;return d(),o(T,{class:"vehicle-page"},{default:n((()=>[r(T,{class:"vehicle-inner"},{default:n((()=>[r(w,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),r(T,{class:"page-header"},{default:n((()=>[r(T,{class:"page-header-left"},{default:n((()=>[r(T,{class:"page-icon"},{default:n((()=>[r(C,{class:"page-icon-text"},{default:n((()=>[u("车")])),_:1})])),_:1}),r(T,{class:"page-header-text"},{default:n((()=>[r(C,{class:"page-title"},{default:n((()=>[u("车辆管理")])),_:1}),r(C,{class:"page-sub"},{default:n((()=>[u("维护送气车辆、车牌号与备注信息")])),_:1})])),_:1})])),_:1}),r(T,{class:"page-header-right"},{default:n((()=>[b.isAdmin?(d(),o(x,{key:0,class:"btn-primary",onClick:t[0]||(t[0]=e=>b.openEdit(null))},{default:n((()=>[u(" + 新增车辆 ")])),_:1})):m("",!0)])),_:1})])),_:1}),r(T,{class:"card"},{default:n((()=>[r(T,{class:"card-body"},{default:n((()=>[r(T,{class:"filter-row"},{default:n((()=>[r(T,{class:"filter-item"},{default:n((()=>[r(T,{class:"input-wrapper"},{default:n((()=>[r(E,{class:"input",modelValue:s.keyword,"onUpdate:modelValue":t[1]||(t[1]=e=>s.keyword=e),placeholder:"按车牌号 / 车辆名称搜索","confirm-type":"search",onConfirm:b.loadList},null,8,["modelValue","onConfirm"])])),_:1})])),_:1}),r(T,{class:"filter-item filter-btn"},{default:n((()=>[r(x,{class:"btn-soft",onClick:b.loadList},{default:n((()=>[u("搜索")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})])),_:1}),r(T,{class:"card"},{default:n((()=>[r(T,{class:"card-header"},{default:n((()=>[r(C,{class:"card-title"},{default:n((()=>[u("车辆列表")])),_:1}),r(C,{class:"card-sub"},{default:n((()=>[u(" 共 "+f(s.total)+" 辆 ",1)])),_:1})])),_:1}),r(T,{class:"card-body"},{default:n((()=>[s.loading?(d(),o(T,{key:0,class:"list-empty"},{default:n((()=>[r(C,{class:"empty-text"},{default:n((()=>[u("加载中…")])),_:1})])),_:1})):0===s.vehicles.length?(d(),o(T,{key:1,class:"list-empty"},{default:n((()=>[b.isAdmin?(d(),o(C,{key:0,class:"empty-text"},{default:n((()=>[u(" 暂无车辆数据，可以点击右上角「新增车辆」 ")])),_:1})):(d(),o(C,{key:1,class:"empty-text"},{default:n((()=>[u(" 暂无车辆数据，当前账号仅能查看车辆信息，如需维护车辆，请联系管理员 ")])),_:1}))])),_:1})):(d(),o(T,{key:2,class:"vehicle-list"},{default:n((()=>[(d(!0),h(p,null,_(s.vehicles,(e=>(d(),o(T,{key:e._id,class:"vehicle-item"},{default:n((()=>[r(T,{class:"vehicle-main"},{default:n((()=>[r(T,{class:"plate-tag"},{default:n((()=>[r(C,{class:"plate-text"},{default:n((()=>[u(f(e.plate_no||"未填车牌"),1)])),_:2},1024)])),_:2},1024),r(T,{class:"vehicle-info"},{default:n((()=>[r(T,{class:"vehicle-name-row"},{default:n((()=>[r(C,{class:"vehicle-name"},{default:n((()=>[u(f(e.name||"未命名车辆"),1)])),_:2},1024)])),_:2},1024),r(T,{class:"vehicle-sub-row"},{default:n((()=>[r(C,{class:"vehicle-sub"},{default:n((()=>[u(f(e.remark||"暂无备注"),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024),b.isAdmin?(d(),o(T,{key:0,class:"vehicle-actions"},{default:n((()=>[r(C,{class:"action-link",onClick:t=>b.openEdit(e)},{default:n((()=>[u("编辑")])),_:2},1032,["onClick"]),r(C,{class:"action-link danger",onClick:t=>b.confirmRemove(e)},{default:n((()=>[u(" 删除 ")])),_:2},1032,["onClick"])])),_:2},1024)):m("",!0)])),_:2},1024)))),128))])),_:1}))])),_:1})])),_:1}),s.showEdit?(d(),o(T,{key:0,class:"edit-mask"},{default:n((()=>[r(T,{class:"edit-dialog"},{default:n((()=>[r(T,{class:"edit-header"},{default:n((()=>[r(C,{class:"edit-title"},{default:n((()=>[u(f(s.form._id?"编辑车辆":"新增车辆"),1)])),_:1})])),_:1}),r(T,{class:"edit-body"},{default:n((()=>[r(T,{class:"form-item"},{default:n((()=>[r(C,{class:"label"},{default:n((()=>[u("* 车牌号")])),_:1}),r(T,{class:"input-wrapper"},{default:n((()=>[r(E,{class:"input",modelValue:s.form.plate_no,"onUpdate:modelValue":t[2]||(t[2]=e=>s.form.plate_no=e),placeholder:"例如 浙A12345"},null,8,["modelValue"])])),_:1})])),_:1}),r(T,{class:"form-item"},{default:n((()=>[r(C,{class:"label"},{default:n((()=>[u("车辆名称")])),_:1}),r(T,{class:"input-wrapper"},{default:n((()=>[r(E,{class:"input",modelValue:s.form.name,"onUpdate:modelValue":t[3]||(t[3]=e=>s.form.name=e),placeholder:"例如 蓝牌轻卡 / 厢式货车"},null,8,["modelValue"])])),_:1})])),_:1}),r(T,{class:"form-item"},{default:n((()=>[r(C,{class:"label"},{default:n((()=>[u("备注")])),_:1}),r(V,{class:"textarea",modelValue:s.form.remark,"onUpdate:modelValue":t[4]||(t[4]=e=>s.form.remark=e),placeholder:"可记录车辆吨位、使用范围等信息"},null,8,["modelValue"])])),_:1})])),_:1}),r(T,{class:"edit-footer"},{default:n((()=>[r(x,{class:"btn-soft",onClick:b.closeEdit,disabled:s.saving},{default:n((()=>[u(" 取消 ")])),_:1},8,["onClick","disabled"]),r(x,{class:"btn-primary",onClick:b.submitEdit,disabled:s.saving},{default:n((()=>[u(f(s.saving?"保存中…":"保存"),1)])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})])),_:1})):m("",!0)])),_:1})])),_:1})}],["__scopeId","data-v-87365f11"]]);export{T as default};
