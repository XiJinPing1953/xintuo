import{t,s as a,n as e,q as s,c as o,w as l,i as u,o as r,d as n,e as m,u as d,v as i,F as c,p as _,l as f,f as y,I as h,x as g,g as D}from"./index-C85BGToL.js";import{B as p}from"./BackToDashboardBar.BBeceW6P.js";import{d as C}from"./auth.yulpUJA0.js";import{_ as k}from"./_plugin-vue_export-helper.BCo6x5W8.js";const b=k({components:{BackToDashboardBar:p},data:()=>({customers:[],customerKeyword:"",customerId:"",customerName:"",showCustomerDropdown:!1,startDate:"",endDate:"",summary:{out_net_total:"0.00",back_net_total:"0.00",net_total:"0.00",amount_total:"0.00",amount_received_total:"0.00",unpaid_total:"0.00",record_count:0},loadingSummary:!1}),computed:{filteredCustomers(){const t=(this.customerKeyword||"").trim();if(!t)return[];const a=t.toLowerCase();return(this.customers||[]).filter((t=>-1!==(t.name||"").toLowerCase().indexOf(a))).slice(0,20)}},onLoad(){this.initDateRange(),this.loadCustomers(),this.$nextTick((()=>{this.loadSummaryByRange()}))},methods:{getToken:()=>C(),initDateRange(){const t=new Date,a=new Date;a.setMonth(a.getMonth()-1);const e=t=>`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;this.startDate=e(a),this.endDate=e(t)},async loadCustomers(){try{const e=this.getToken(),s=(await t.callFunction({name:"crm-customer",data:{action:"list",token:e,data:{}}})).result||{};if(0!==s.code)return void a({title:s.msg||"加载客户失败",icon:"none"});this.customers=s.data||[]}catch(e){console.error("loadCustomers error",e),a({title:"加载客户失败",icon:"none"})}},onCustomerInput(t){this.customerKeyword=t.detail.value,this.showCustomerDropdown=!!this.customerKeyword},onCustomerConfirm(){1===this.filteredCustomers.length?this.onSelectCustomer(this.filteredCustomers[0]):this.showCustomerDropdown=!0},onSelectCustomer(t){this.customerId=t._id,this.customerName=t.name,this.customerKeyword=t.name,this.showCustomerDropdown=!1,this.loadSummaryByRange()},onStartDateChange(t){this.startDate=t.detail.value,this.endDate&&this.loadSummaryByRange()},onEndDateChange(t){this.endDate=t.detail.value,this.startDate&&this.loadSummaryByRange()},async loadSummaryByRange(){if(this.startDate&&this.endDate){this.loadingSummary=!0;try{const e=this.getToken(),s=(await t.callFunction({name:"crm-bill",data:{action:"customerSummaryByRange",token:e,data:{customer_id:this.customerId||"",customer_name:this.customerName||"",date_from:this.startDate,date_to:this.endDate}}})).result||{};if(0!==s.code)return a({title:s.msg||"加载账单失败",icon:"none"}),void this.resetSummary();const o=s.data||{},l=t=>Number(t||0).toFixed(2);this.summary={out_net_total:l(o.out_net_total),back_net_total:l(o.back_net_total),net_total:l(o.net_total),amount_total:l(o.amount_total),amount_received_total:l(o.amount_received_total),unpaid_total:l(o.unpaid_total),record_count:o.record_count||0}}catch(e){console.error("loadSummaryByRange error",e),a({title:"加载账单失败",icon:"none"}),this.resetSummary()}finally{this.loadingSummary=!1}}else this.resetSummary()},resetSummary(){this.summary={out_net_total:"0.00",back_net_total:"0.00",net_total:"0.00",amount_total:"0.00",amount_received_total:"0.00",unpaid_total:"0.00",record_count:0}},resetFilter(){this.customerKeyword="",this.customerId="",this.customerName="",this.showCustomerDropdown=!1,this.initDateRange(),this.loadSummaryByRange()},goDailyDetail(){this.customerId||this.customerName?this.startDate&&this.endDate?e({url:`/pages/bill/monthly-detail?customer_id=${this.customerId||""}&customer_name=${encodeURIComponent(this.customerName||"")}&date_from=${this.startDate}&date_to=${this.endDate}`}):a({title:"请选择时间范围",icon:"none"}):a({title:"请选择一个客户再看明细（汇总已经是全部客户了）",icon:"none"})}}},[["render",function(t,a,e,p,C,k){const b=s("BackToDashboardBar"),w=y,S=h,v=u,I=g,B=D;return r(),o(v,{class:"page"},{default:l((()=>[n(v,{class:"inner"},{default:l((()=>[n(b,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),n(v,{class:"top-bar"},{default:l((()=>[n(v,{class:"field customer-field"},{default:l((()=>[n(w,{class:"label"},{default:l((()=>[m("客户")])),_:1}),n(v,{class:"input-wrapper"},{default:l((()=>[n(S,{class:"input",modelValue:C.customerKeyword,"onUpdate:modelValue":a[0]||(a[0]=t=>C.customerKeyword=t),placeholder:"输入客户名称，支持联想搜索（不填=全部客户）","confirm-type":"search",onInput:k.onCustomerInput,onConfirm:k.onCustomerConfirm},null,8,["modelValue","onInput","onConfirm"])])),_:1}),C.showCustomerDropdown?(r(),o(v,{key:0,class:"suggest-panel"},{default:l((()=>[k.filteredCustomers.length?(r(),o(v,{key:0,class:"suggest-list"},{default:l((()=>[(r(!0),d(c,null,i(k.filteredCustomers,(t=>(r(),o(v,{key:t._id,class:"suggest-item",onClick:a=>k.onSelectCustomer(t)},{default:l((()=>[n(w,{class:"suggest-name"},{default:l((()=>[m(f(t.name),1)])),_:2},1024),t.address?(r(),o(w,{key:0,class:"suggest-sub"},{default:l((()=>[m(f(t.address),1)])),_:2},1024)):_("",!0)])),_:2},1032,["onClick"])))),128))])),_:1})):(r(),o(v,{key:1,class:"suggest-empty"},{default:l((()=>[n(w,null,{default:l((()=>[m("没有匹配的客户")])),_:1})])),_:1}))])),_:1})):_("",!0)])),_:1}),n(v,{class:"field date-range-field"},{default:l((()=>[n(w,{class:"label"},{default:l((()=>[m("时间范围")])),_:1}),n(v,{class:"date-range-wrapper"},{default:l((()=>[n(I,{mode:"date",value:C.startDate,onChange:k.onStartDateChange},{default:l((()=>[n(v,{class:"date-input"},{default:l((()=>[n(w,null,{default:l((()=>[m(f(C.startDate||"开始日期"),1)])),_:1})])),_:1})])),_:1},8,["value","onChange"]),n(w,{class:"range-sep"},{default:l((()=>[m("至")])),_:1}),n(I,{mode:"date",value:C.endDate,onChange:k.onEndDateChange},{default:l((()=>[n(v,{class:"date-input"},{default:l((()=>[n(w,null,{default:l((()=>[m(f(C.endDate||"结束日期"),1)])),_:1})])),_:1})])),_:1},8,["value","onChange"])])),_:1})])),_:1})])),_:1}),n(v,{class:"summary-grid"},{default:l((()=>[n(v,{class:"summary-card",onClick:k.goDailyDetail},{default:l((()=>[n(w,{class:"summary-label"},{default:l((()=>[m("出瓶净重合计")])),_:1}),n(v,{class:"summary-main"},{default:l((()=>[n(w,{class:"summary-value"},{default:l((()=>[m(f(C.summary.out_net_total),1)])),_:1}),n(w,{class:"summary-unit"},{default:l((()=>[m("kg")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:k.goDailyDetail},{default:l((()=>[n(w,{class:"summary-label"},{default:l((()=>[m("回瓶净重合计")])),_:1}),n(v,{class:"summary-main"},{default:l((()=>[n(w,{class:"summary-value"},{default:l((()=>[m(f(C.summary.back_net_total),1)])),_:1}),n(w,{class:"summary-unit"},{default:l((()=>[m("kg")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:k.goDailyDetail},{default:l((()=>[n(w,{class:"summary-label"},{default:l((()=>[m("净出气量")])),_:1}),n(v,{class:"summary-main"},{default:l((()=>[n(w,{class:"summary-value"},{default:l((()=>[m(f(C.summary.net_total),1)])),_:1}),n(w,{class:"summary-unit"},{default:l((()=>[m("kg")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:k.goDailyDetail},{default:l((()=>[n(w,{class:"summary-label"},{default:l((()=>[m("应收合计")])),_:1}),n(v,{class:"summary-main"},{default:l((()=>[n(w,{class:"summary-value"},{default:l((()=>[m(f(C.summary.amount_total),1)])),_:1}),n(w,{class:"summary-unit"},{default:l((()=>[m("元")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:k.goDailyDetail},{default:l((()=>[n(w,{class:"summary-label"},{default:l((()=>[m("实收合计")])),_:1}),n(v,{class:"summary-main"},{default:l((()=>[n(w,{class:"summary-value"},{default:l((()=>[m(f(C.summary.amount_received_total),1)])),_:1}),n(w,{class:"summary-unit"},{default:l((()=>[m("元")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:k.goDailyDetail},{default:l((()=>[n(w,{class:"summary-label"},{default:l((()=>[m("未收（挂账）")])),_:1}),n(v,{class:"summary-main"},{default:l((()=>[n(w,{class:"summary-value unpaid"},{default:l((()=>[m(f(C.summary.unpaid_total),1)])),_:1}),n(w,{class:"summary-unit unpaid"},{default:l((()=>[m("元")])),_:1})])),_:1})])),_:1},8,["onClick"])])),_:1}),C.summary.record_count>0?(r(),o(v,{key:0,class:"footer-note"},{default:l((()=>[n(w,{class:"note-text"},{default:l((()=>[m(" 当前范围内共 "),n(w,{class:"note-strong"},{default:l((()=>[m(f(C.summary.record_count),1)])),_:1}),m(" 条销售记录。 "),Number(C.summary.unpaid_total)>0?(r(),o(w,{key:0},{default:l((()=>[m(" 其中仍有 "),n(w,{class:"note-strong"},{default:l((()=>[m(f(C.summary.unpaid_total),1)])),_:1}),m(" 元挂账未收。 ")])),_:1})):_("",!0)])),_:1})])),_:1})):C.startDate&&C.endDate&&!C.loadingSummary?(r(),o(v,{key:1,class:"footer-note footer-note-empty"},{default:l((()=>[n(w,{class:"note-text"},{default:l((()=>[m(" 当前时间范围内 "),C.customerId||C.customerName?_("",!0):(r(),o(w,{key:0},{default:l((()=>[m("（全部客户）")])),_:1})),m(" 暂无任何销售记录。 ")])),_:1}),n(w,{class:"note-sub"},{default:l((()=>[m(" 可以调整时间范围， "),C.customerId||C.customerName?_("",!0):(r(),o(w,{key:0},{default:l((()=>[m("或选择具体客户后")])),_:1})),m(" 再试一次。 ")])),_:1})])),_:1})):C.startDate&&C.endDate?_("",!0):(r(),o(v,{key:2,class:"footer-note footer-note-empty"},{default:l((()=>[n(w,{class:"note-text"},{default:l((()=>[m(" 请先选择一个时间范围，再查看对账汇总。 ")])),_:1})])),_:1})),n(v,{class:"bottom-actions"},{default:l((()=>[n(B,{class:"btn-soft",onClick:k.resetFilter},{default:l((()=>[m("重置")])),_:1},8,["onClick"]),n(B,{class:"btn-primary",onClick:k.goDailyDetail,disabled:!C.customerId||!C.startDate||!C.endDate},{default:l((()=>[m(" 查看明细 ")])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-a4825e9f"]]);export{b as default};
