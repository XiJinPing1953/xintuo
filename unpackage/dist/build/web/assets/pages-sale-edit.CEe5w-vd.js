import{o as e,c as t,w as a,d as l,e as s,m as r,u as o,v as u,F as i,p as n,l as d,f as c,i as m,I as h,x as _,A as f,D as p,s as g,t as b,B as y,C as k,r as v,k as w,q as N,g as S}from"./index-C85BGToL.js";import{e as x,b as B,d as I}from"./auth.yulpUJA0.js";import{B as C}from"./BackToDashboardBar.BBeceW6P.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";const V=F({components:{BackToDashboardBar:C,SaleBasicInfoCard:F({name:"SaleBasicInfoCard",model:{prop:"value",event:"input"},props:{value:{type:Object,required:!0},customers:{type:Array,default:()=>[]},deliveryList:{type:Array,default:()=>[]},vehicleList:{type:Array,default:()=>[]}},data:()=>({localMode:"bottle",customerKeyword:"",customerSuggests:[],deliveryKeyword1:"",deliverySuggests1:[],deliveryKeyword2:"",deliverySuggests2:[],vehicleKeyword:"",vehicleSuggests:[],priceUnitOptions:["元/kg","元/瓶","元/立方米"],priceUnitIndex:0}),computed:{header(){return this.value||{}}},watch:{value:{immediate:!0,handler(e){const t=e||{};this.customerKeyword=t.customer_name||"",this.deliveryKeyword1=t.delivery_man_1||"",this.deliveryKeyword2=t.delivery_man_2||"",this.vehicleKeyword=t.car_no||"";const a=t.price_unit||"kg",l={kg:0,bottle:1,cbm:2,m3:2};this.priceUnitIndex=null!=l[a]?l[a]:0;let s=t.biz_mode||"bottle";"bottle"!==s&&"truck"!==s&&(s="bottle"),this.localMode=s}}},methods:{updateHeader(e){const t={...this.value||{},...e};this.$emit("input",t)},onModeClick(e){if(this.localMode===e)return;this.localMode=e;const t={biz_mode:e};"truck"===e?this.header.price_unit&&"m3"!==this.header.price_unit||(t.price_unit="kg",this.priceUnitIndex=0):"bottle"===e&&"m3"===this.header.price_unit&&(t.price_unit="kg",this.priceUnitIndex=0),this.updateHeader(t),this.$emit("mode-change",e)},onCustomerInput(e){const t=e.detail.value.trim();if(this.customerKeyword=t,this.updateHeader({customer_name:t,customer_id:""}),!t)return void(this.customerSuggests=[]);const a=(this.customers||[]).filter((e=>!(!e||!e.name)&&-1!==e.name.indexOf(t)));this.customerSuggests=a.slice(0,20)},onSelectCustomer(e){e&&(this.customerKeyword=e.name,this.customerSuggests=[],this.updateHeader({customer_id:e._id,customer_name:e.name}))},onVehicleInput(e){const t=e.detail.value.trim();if(this.vehicleKeyword=t,this.updateHeader({car_no:t,vehicle_id:""}),!t)return void(this.vehicleSuggests=[]);const a=(this.vehicleList||[]).filter((e=>{if(!e)return!1;return-1!==(e.car_no||e.plate_no||e.plateNo||"").indexOf(t)}));this.vehicleSuggests=a.slice(0,20)},onSelectVehicle(e){if(!e)return;const t=e.car_no||e.plate_no||e.plateNo||"";this.vehicleKeyword=t,this.vehicleSuggests=[],this.updateHeader({vehicle_id:e._id||"",car_no:t})},onDelivery1Input(e){const t=e.detail.value.trim();if(this.deliveryKeyword1=t,this.updateHeader({delivery_man_1:t}),!t)return void(this.deliverySuggests1=[]);const a=(this.deliveryList||[]).filter((e=>!(!e||!e.name)&&-1!==e.name.indexOf(t)));this.deliverySuggests1=a.slice(0,20)},onSelectDelivery1(e){e&&(this.deliveryKeyword1=e.name,this.deliverySuggests1=[],this.updateHeader({delivery_man_1:e.name}))},onDelivery2Input(e){const t=e.detail.value.trim();if(this.deliveryKeyword2=t,this.updateHeader({delivery_man_2:t}),!t)return void(this.deliverySuggests2=[]);const a=(this.deliveryList||[]).filter((e=>!(!e||!e.name)&&-1!==e.name.indexOf(t)));this.deliverySuggests2=a.slice(0,20)},onSelectDelivery2(e){e&&(this.deliveryKeyword2=e.name,this.deliverySuggests2=[],this.updateHeader({delivery_man_2:e.name}))},onDateChange(e){this.updateHeader({date:e.detail.value})},onUnitPriceInput(e){this.updateHeader({unit_price:e.detail.value})},onPriceUnitChange(e){const t=Number(e.detail.value);this.priceUnitIndex=t;let a="kg";1===t&&(a="bottle"),2===t&&(a="m3"),this.updateHeader({price_unit:a})}}},[["render",function(p,g,b,y,k,v){const w=c,N=m,S=h,x=_;return e(),t(N,{class:"card card-basic"},{default:a((()=>[l(N,{class:"card-header"},{default:a((()=>[l(w,{class:"card-title"},{default:a((()=>[s("基础信息")])),_:1})])),_:1}),l(N,{class:"card-body"},{default:a((()=>[l(N,{class:"mode-switch-bar"},{default:a((()=>[l(N,{class:r(["mode-pill","bottle"===k.localMode?"mode-pill-active":""]),onClick:g[0]||(g[0]=e=>v.onModeClick("bottle"))},{default:a((()=>[l(w,{class:r(["mode-pill-text","bottle"===k.localMode?"mode-pill-text-active":""])},{default:a((()=>[s(" 瓶装模式 ")])),_:1},8,["class"])])),_:1},8,["class"]),l(N,{class:r(["mode-pill","truck"===k.localMode?"mode-pill-active":""]),onClick:g[1]||(g[1]=e=>v.onModeClick("truck"))},{default:a((()=>[l(w,{class:r(["mode-pill-text","truck"===k.localMode?"mode-pill-text-active":""])},{default:a((()=>[s(" 整车模式 ")])),_:1},8,["class"])])),_:1},8,["class"])])),_:1}),l(N,{class:"form-row"},{default:a((()=>[l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[s("* 客户")])),_:1}),l(N,{class:"input-wrapper"},{default:a((()=>[l(S,{class:"input",value:k.customerKeyword,placeholder:"请输入客户名搜索",onInput:v.onCustomerInput},null,8,["value","onInput"])])),_:1}),k.customerSuggests.length?(e(),t(N,{key:0,class:"sbic-suggest"},{default:a((()=>[(e(!0),o(i,null,u(k.customerSuggests,(r=>(e(),t(N,{key:r._id,class:"sbic-suggest-item",onClick:f((e=>v.onSelectCustomer(r)),["stop"])},{default:a((()=>[l(w,{class:"sbic-suggest-main"},{default:a((()=>[s(d(r.name),1)])),_:2},1024),l(w,{class:"sbic-suggest-sub"},{default:a((()=>[s(d(r.contact||""),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):n("",!0)])),_:1}),l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[s("* 日期")])),_:1}),l(x,{mode:"date",value:v.header.date,onChange:v.onDateChange},{default:a((()=>[l(N,{class:"input-wrapper"},{default:a((()=>[l(N,{class:"picker"},{default:a((()=>[l(w,null,{default:a((()=>[s(d(v.header.date||"请选择日期"),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["value","onChange"])])),_:1}),l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[s("车辆")])),_:1}),l(N,{class:"input-wrapper"},{default:a((()=>[l(S,{class:"input",value:k.vehicleKeyword,placeholder:"车牌模糊搜索",onInput:v.onVehicleInput},null,8,["value","onInput"])])),_:1}),k.vehicleSuggests.length?(e(),t(N,{key:0,class:"sbic-suggest"},{default:a((()=>[(e(!0),o(i,null,u(k.vehicleSuggests,(r=>(e(),t(N,{key:r._id,class:"sbic-suggest-item",onClick:f((e=>v.onSelectVehicle(r)),["stop"])},{default:a((()=>[l(w,{class:"sbic-suggest-main"},{default:a((()=>[s(d(r.plate_no||r.car_no||r.plateNo),1)])),_:2},1024),l(w,{class:"sbic-suggest-sub"},{default:a((()=>[s(d(r.name||""),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):n("",!0)])),_:1})])),_:1}),l(N,{class:"form-row"},{default:a((()=>[l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[s("配送员 1")])),_:1}),l(N,{class:"input-wrapper"},{default:a((()=>[l(S,{class:"input",value:k.deliveryKeyword1,placeholder:"输入姓名搜索",onInput:v.onDelivery1Input},null,8,["value","onInput"])])),_:1}),k.deliverySuggests1.length?(e(),t(N,{key:0,class:"sbic-suggest"},{default:a((()=>[(e(!0),o(i,null,u(k.deliverySuggests1,(r=>(e(),t(N,{key:r._id,class:"sbic-suggest-item",onClick:f((e=>v.onSelectDelivery1(r)),["stop"])},{default:a((()=>[l(w,{class:"sbic-suggest-main"},{default:a((()=>[s(d(r.name),1)])),_:2},1024),l(w,{class:"sbic-suggest-sub"},{default:a((()=>[s(d(r.phone||""),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):n("",!0)])),_:1}),l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[s("配送员 2（可空）")])),_:1}),l(N,{class:"input-wrapper"},{default:a((()=>[l(S,{class:"input",value:k.deliveryKeyword2,placeholder:"输入姓名搜索",onInput:v.onDelivery2Input},null,8,["value","onInput"])])),_:1}),k.deliverySuggests2.length?(e(),t(N,{key:0,class:"sbic-suggest"},{default:a((()=>[(e(!0),o(i,null,u(k.deliverySuggests2,(r=>(e(),t(N,{key:r._id,class:"sbic-suggest-item",onClick:f((e=>v.onSelectDelivery2(r)),["stop"])},{default:a((()=>[l(w,{class:"sbic-suggest-main"},{default:a((()=>[s(d(r.name),1)])),_:2},1024),l(w,{class:"sbic-suggest-sub"},{default:a((()=>[s(d(r.phone||""),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):n("",!0)])),_:1}),l(N,{class:"form-item col-third"},{default:a((()=>[l(w,{class:"label"},{default:a((()=>[s("单价 & 计价单位")])),_:1}),l(N,{class:"dual-input"},{default:a((()=>[l(N,{class:"input-wrapper dual-left"},{default:a((()=>[l(S,{class:"input",type:"number",placeholder:"单价",value:v.header.unit_price,onInput:v.onUnitPriceInput},null,8,["value","onInput"])])),_:1}),l(x,{mode:"selector",class:"dual-right",range:k.priceUnitOptions,value:k.priceUnitIndex,onChange:v.onPriceUnitChange},{default:a((()=>[l(N,{class:"input-wrapper"},{default:a((()=>[l(N,{class:"picker"},{default:a((()=>[l(w,null,{default:a((()=>[s(d(k.priceUnitOptions[k.priceUnitIndex]),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-a69bc68d"]]),FlowSettlementCard:F({name:"FlowSettlementCard",props:{unitPrice:{type:[Number,String],default:0},prevIndex:{type:[Number,String],default:""},currIndex:{type:[Number,String],default:""},amountReceived:{type:[Number,String],default:""},paymentStatus:{type:String,default:"挂账"},remark:{type:String,default:""},paymentStatusOptions:{type:Array,default:()=>["挂账","已付","部分已付","冲减"]}},data(){return{prev:String(this.prevIndex||""),curr:String(this.currIndex||""),localAmountReceived:String(this.amountReceived||""),localPaymentStatus:this.paymentStatus||"挂账",localRemark:this.remark||""}},watch:{prevIndex(e){this.prev=String(e||"")},currIndex(e){this.curr=String(e||"")},amountReceived(e){this.localAmountReceived=String(e||"")},paymentStatus(e){this.localPaymentStatus=e||"挂账"},remark(e){this.localRemark=e||""}},computed:{volumeNumber(){const e=Number(this.prev),t=Number(this.curr);return isNaN(e)||isNaN(t)||t<e?0:t-e},volumeText(){return this.volumeNumber.toFixed(4)},volumeFormula(){return this.volumeNumber?`${this.curr||0} - ${this.prev||0} = ${this.volumeText}m³`:""},amountNumber(){const e=this.volumeNumber,t=Number(this.unitPrice);return!e||isNaN(t)?0:e*t},amountText(){return this.amountNumber.toFixed(2)},amountFormula(){const e=Number(this.unitPrice);return!this.volumeNumber||isNaN(e)?"":`应收金额 = 用气量 × 单价 = ${this.volumeText}m³ × ${e}元/m³ = ${this.amountText}元`},paymentStatusIndex(){const e=this.paymentStatusOptions.indexOf(this.localPaymentStatus);return e>=0?e:0},paymentStatusLabel(){return this.paymentStatusOptions[this.paymentStatusIndex]||"挂账"}},methods:{onPaymentStatusChange(e){const t=Number(e.detail.value);this.localPaymentStatus=this.paymentStatusOptions[t]||"挂账",this.emitChange()},emitChange(){const e={prev:this.prev,curr:this.curr,volume:this.volumeText,amount:this.amountText,amount_received:this.localAmountReceived,payment_status:this.localPaymentStatus,remark:this.localRemark};this.$emit("input",e),this.$emit("update",e)}}},[["render",function(r,o,u,i,f,g){const b=c,y=m,k=h,v=_,w=p;return e(),t(y,{class:"card flow-settle-card"},{default:a((()=>[l(y,{class:"card-header"},{default:a((()=>[l(b,{class:"card-title"},{default:a((()=>[s("流量结算")])),_:1}),l(b,{class:"card-sub"},{default:a((()=>[s("单位为 元/m³ 时自动启用此卡片")])),_:1})])),_:1}),l(y,{class:"card-body"},{default:a((()=>[l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[s("上次表数 (m³)")])),_:1}),l(y,{class:"input-wrapper"},{default:a((()=>[l(k,{type:"number",class:"input",modelValue:f.prev,"onUpdate:modelValue":o[0]||(o[0]=e=>f.prev=e),onBlur:g.emitChange},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[s("本次表数 (m³)")])),_:1}),l(y,{class:"input-wrapper"},{default:a((()=>[l(k,{type:"number",class:"input",modelValue:f.curr,"onUpdate:modelValue":o[1]||(o[1]=e=>f.curr=e),onBlur:g.emitChange},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(y,{class:"summary-chip"},{default:a((()=>[l(y,{class:"summary-line"},{default:a((()=>[l(b,{class:"summary-label"},{default:a((()=>[s("本次用气量：")])),_:1}),l(b,{class:"summary-value-strong"},{default:a((()=>[s(d(g.volumeText)+" m³",1)])),_:1})])),_:1}),g.volumeFormula?(e(),t(y,{key:0,class:"summary-line"},{default:a((()=>[l(b,{class:"summary-formula"},{default:a((()=>[s(d(g.volumeFormula),1)])),_:1})])),_:1})):n("",!0)])),_:1}),l(y,{class:"summary-chip"},{default:a((()=>[l(y,{class:"summary-line"},{default:a((()=>[l(b,{class:"summary-label-strong"},{default:a((()=>[s("应收金额：")])),_:1}),l(b,{class:"summary-value-strong"},{default:a((()=>[s(d(g.amountText)+" 元",1)])),_:1})])),_:1}),g.amountFormula?(e(),t(y,{key:0,class:"summary-line"},{default:a((()=>[l(b,{class:"summary-formula"},{default:a((()=>[s(d(g.amountFormula),1)])),_:1})])),_:1})):n("",!0)])),_:1}),l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[s("实收金额 (元)")])),_:1}),l(y,{class:"input-wrapper"},{default:a((()=>[l(k,{type:"number",class:"input",modelValue:f.localAmountReceived,"onUpdate:modelValue":o[2]||(o[2]=e=>f.localAmountReceived=e),onBlur:g.emitChange,placeholder:"本次实际收了多少，可为 0"},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[s("付款状态")])),_:1}),l(v,{mode:"selector",range:u.paymentStatusOptions,value:g.paymentStatusIndex,onChange:g.onPaymentStatusChange},{default:a((()=>[l(y,{class:"input-wrapper"},{default:a((()=>[l(y,{class:"picker"},{default:a((()=>[l(b,null,{default:a((()=>[s(d(g.paymentStatusLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1}),l(y,{class:"form-item"},{default:a((()=>[l(b,{class:"label"},{default:a((()=>[s("备注")])),_:1}),l(w,{class:"textarea",modelValue:f.localRemark,"onUpdate:modelValue":o[3]||(o[3]=e=>f.localRemark=e),onBlur:g.emitChange,placeholder:"例如：只抄表未送气；或补录某日流量结算"},null,8,["modelValue","onBlur"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-f3d0af82"]]),FlowTheoryCard:F({name:"FlowTheoryCard",props:{totalOutNet:{type:[Number,String],default:0},totalBackNet:{type:[Number,String],default:0},ratio:{type:[Number,String],default:1.37}},data(){return{ratioInput:this.ratio}},watch:{ratio(e){this.ratioInput=e}},computed:{outKgNumber(){const e=Number(this.totalOutNet);return isNaN(e)?0:e},backKgNumber(){const e=Number(this.totalBackNet);return isNaN(e)?0:e},actualKgNumber(){return this.outKgNumber-this.backKgNumber},outKgText(){return this.outKgNumber.toFixed(2)},backKgText(){return this.backKgNumber.toFixed(2)},actualKgText(){return this.actualKgNumber.toFixed(2)},actualFormula(){return this.outKgNumber||this.backKgNumber?`实际消耗 = 出瓶净重合计 - 回瓶净重合计 = ${this.outKgText}kg - ${this.backKgText}kg = ${this.actualKgText}kg`:""},ratioNumber(){const e=Number(this.ratioInput);return isNaN(e)||e<=0?0:e},theoryVolumeNumber(){return this.ratioNumber?this.actualKgNumber*this.ratioNumber:0},theoryVolumeText(){return this.theoryVolumeNumber.toFixed(2)},theoryFormula(){return this.theoryVolumeNumber&&this.ratioNumber?`理论用气量 = 实际消耗 × 换算系数 = ${this.actualKgText}kg × ${this.ratioNumber}m³/kg = ${this.theoryVolumeText}m³`:""}},methods:{onRatioInput(e){const t=e.detail.value;this.ratioInput=t;const a=Number(t);this.$emit("update-ratio",isNaN(a)?0:a)}}},[["render",function(r,o,u,i,_,f){const p=c,g=m,b=h;return e(),t(g,{class:"card flow-theory-card"},{default:a((()=>[l(g,{class:"card-header"},{default:a((()=>[l(p,{class:"card-title"},{default:a((()=>[s("称重推算理论流量")])),_:1}),l(p,{class:"card-sub"},{default:a((()=>[s(" 从瓶子 / 罐车称重看本次实际消耗多少公斤，并换算成立方米 ")])),_:1})])),_:1}),l(g,{class:"card-body"},{default:a((()=>[l(g,{class:"summary-chip"},{default:a((()=>[l(g,{class:"summary-line"},{default:a((()=>[l(p,{class:"summary-label"},{default:a((()=>[s("出瓶净重合计：")])),_:1}),l(p,{class:"summary-value"},{default:a((()=>[s(d(f.outKgText)+" kg",1)])),_:1})])),_:1}),l(g,{class:"summary-line"},{default:a((()=>[l(p,{class:"summary-label"},{default:a((()=>[s("回瓶净重合计：")])),_:1}),l(p,{class:"summary-value"},{default:a((()=>[s(d(f.backKgText)+" kg",1)])),_:1})])),_:1}),l(g,{class:"summary-line"},{default:a((()=>[l(p,{class:"summary-label"},{default:a((()=>[s("实际消耗：")])),_:1}),l(p,{class:"summary-value-strong"},{default:a((()=>[s(d(f.actualKgText)+" kg",1)])),_:1})])),_:1}),f.actualFormula?(e(),t(g,{key:0,class:"summary-line"},{default:a((()=>[l(p,{class:"summary-formula"},{default:a((()=>[s(d(f.actualFormula),1)])),_:1})])),_:1})):n("",!0)])),_:1}),l(g,{class:"form-row"},{default:a((()=>[l(g,{class:"form-item col-half"},{default:a((()=>[l(p,{class:"label"},{default:a((()=>[s("换算系数 (m³/kg)")])),_:1}),l(g,{class:"input-wrapper"},{default:a((()=>[l(b,{class:"input",type:"number",value:_.ratioInput,placeholder:"例如 1.37",onInput:f.onRatioInput},null,8,["value","onInput"])])),_:1})])),_:1})])),_:1}),l(g,{class:"summary-chip"},{default:a((()=>[l(g,{class:"summary-line"},{default:a((()=>[l(p,{class:"summary-label"},{default:a((()=>[s("理论用气量：")])),_:1}),l(p,{class:"summary-value-strong"},{default:a((()=>[s(d(f.theoryVolumeText)+" m³",1)])),_:1})])),_:1}),f.theoryFormula?(e(),t(g,{key:0,class:"summary-line"},{default:a((()=>[l(p,{class:"summary-formula"},{default:a((()=>[s(d(f.theoryFormula),1)])),_:1})])),_:1})):n("",!0)])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-7b41d630"]])},data:()=>({todayText:"",statusTextMap:{in_station:"在站",at_customer:"在客户",in_transit:"途中",repairing:"维修",scrapped:"报废",lost:"丢失"},header:{date:"",customer_id:"",customer_name:"",delivery_man_1:"",delivery_man_2:"",vehicle_id:"",car_no:"",unit_price:"",price_unit:"kg",amount_received:"",payment_status:"挂账",remark:"",biz_mode:"bottle",truck_gross:"",truck_tare:"",truck_net:""},defaultRatio:1.37,flowTheoryRatio:1.37,flowSettle:{prev:"",curr:"",volume:"",amount:"",amount_received:"",payment_status:"挂账",remark:"",flow_index_prev:"",flow_index_curr:"",flow_volume:"",flow_unit_price:"",flow_amount_should:"",flow_amount_received:"",flow_payment_status:"",flow_remark:""},truckNetManual:!1,customers:[],customerIndex:-1,customerKeyword:"",customerSuggests:[],deliveryList:[],deliveryIndex1:-1,deliveryIndex2:-1,vehicleList:[],vehicleIndex:-1,priceUnitOptions:["元/kg","元/瓶","元/m³"],priceUnitIndex:0,paymentStatusOptions:["挂账","已付","部分已付","冲减"],paymentStatusIndex:0,outBottles:[{number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1}],backBottles:[{number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1}],depositBottles:[{number:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1}],submitting:!1,bottleSearchCache:{},bottleSearchPending:{},debouncedBottleSuggest:null,editId:"",isEditing:!1}),onShow(){this.loadCustomers(),this.loadDeliveryList(),this.loadVehicles(),this.syncSelectIndexesFromHeader()},computed:{pageTitle(){return this.isEditing?"编辑销售记录":"新增销售记录"},tagText(){return this.isEditing?this.header&&this.header.date?`单据日期 · ${this.header.date}`:"单据日期未填写":`今日 · ${this.todayText}`},bizMode(){return this.header.biz_mode||this.header.business_mode||"bottle"},showBottleCards(){return"bottle"===this.bizMode},isFlowPriceMode(){return"m3"===this.header.price_unit},truckNetNumber(){const e=Number(this.header.truck_net);return isNaN(e)?0:e},truckGrossTon:{get(){const e=this.header.truck_gross;if(""===e||null==e)return"";const t=Number(e);return isNaN(t)?"":t/1e3},set(e){const t=Number(e);isNaN(t)?this.header.truck_gross="":(this.header.truck_gross=String(Math.round(1e3*t)),this.updateTruckNet())}},truckTareTon:{get(){const e=this.header.truck_tare;if(""===e||null==e)return"";const t=Number(e);return isNaN(t)?"":t/1e3},set(e){const t=Number(e);isNaN(t)?this.header.truck_tare="":(this.header.truck_tare=String(Math.round(1e3*t)),this.updateTruckNet())}},truckNetTon:{get(){const e=this.header.truck_net;if(""===e||null==e)return"";const t=Number(e);return isNaN(t)?"":t/1e3},set(e){this.truckNetManual=!0;const t=Number(e);isNaN(t)?this.header.truck_net="":this.header.truck_net=String(Math.round(1e3*t))}},backAmountAbs(){const e=this.backAmount;return e?Math.abs(e).toFixed(2):"0"},backAmountDirectionText(){return this.backAmount>0?"（需退给客户）":this.backAmount<0?"（需客户补）":""},backAmountDisplayForSummary(){const e=this.backAmount;if(!e)return"0";const t=Math.abs(e).toFixed(2);return e>0?"-"+t:t},outAmountDetail(){const e=this.unitPriceNumber;if(!e)return"";if("truck"===this.bizMode){const t=this.truckNetNumber;return t?`${t.toFixed(2)}kg×${e.toFixed(2)}元/kg=${this.outAmount}元`:""}if("bottle"===this.header.price_unit){const t=this.outBottles.filter((e=>e.number.trim())).length;return t?`${t}瓶×${e.toFixed(2)}元/瓶=${this.outAmount}元`:""}if("kg"===this.header.price_unit){const t=Number(this.totalOutNet);return t?`${t.toFixed(2)}kg×${e.toFixed(2)}元/kg=${this.outAmount}元`:""}return""},backAmountDetail(){const e=this.unitPriceNumber;if(!e)return"";if("bottle"===this.header.price_unit||"m3"===this.header.price_unit)return"";const t=Number(this.totalBackNet);if(!t)return"";const a=Math.abs(t).toFixed(2),l=Math.abs(this.backAmount).toFixed(2),s=t>0?"减收":"加收";return`${a}kg×${e.toFixed(2)}元/kg=${l}元，${s}${l}元`},shouldReceiveDetail(){const e=Number(this.outAmount);if(!e)return"";const t=this.backAmount,a=Math.abs(t).toFixed(2),l=this.shouldReceive;return t?t>0?`${e.toFixed(2)}-${a}=${l}元`:`${e.toFixed(2)}+${a}=${l}元`:`${e.toFixed(2)}=${l}元`},customerLabel(){var e;return this.customerIndex<0?"请选择客户":(null==(e=this.customers[this.customerIndex])?void 0:e.name)||"请选择客户"},deliveryLabel1(){var e;return this.deliveryIndex1<0?"请选择配送员":(null==(e=this.deliveryList[this.deliveryIndex1])?void 0:e.name)||"请选择配送员"},deliveryLabel2(){var e;return this.deliveryIndex2<0?"（可空）":(null==(e=this.deliveryList[this.deliveryIndex2])?void 0:e.name)||"（可空）"},vehicleLabel(){if(this.vehicleIndex<0)return"请选择车辆";const e=this.vehicleList[this.vehicleIndex];return e?e.name?`${e.plate_no} - ${e.name}`:e.plate_no:"请选择车辆"},priceUnitLabel(){return this.priceUnitOptions[this.priceUnitIndex]},paymentStatusLabel(){return this.paymentStatusOptions[this.paymentStatusIndex]},totalOutNet(){let e=0;return this.outBottles.forEach((t=>{const a=Number(t.net);isNaN(a)||(e+=a)})),e.toFixed(2)},totalBackNet(){let e=0;return this.backBottles.forEach((t=>{const a=Number(t.net);isNaN(a)||(e+=a)})),e.toFixed(2)},totalOutNetDetail(){const e=this.outBottles.map((e=>Number(e.net))).filter((e=>!isNaN(e)&&0!==e));if(!e.length)return"";let t="";e.forEach(((e,a)=>{const l=Math.abs(e),s=(l%1==0?l.toString():l.toFixed(2))+"kg";t+=0===a?(e<0?"-":"")+s:(e<0?"-":"+")+s}));const a=Number(this.totalOutNet),l=Math.abs(a),s=(l%1==0?l.toString():l.toFixed(2))+"kg";return t+="="+(a<0?"-":"")+s,t},totalBackNetDetail(){const e=this.backBottles.map((e=>Number(e.net))).filter((e=>!isNaN(e)&&0!==e));if(!e.length)return"";let t="";e.forEach(((e,a)=>{const l=Math.abs(e),s=(l%1==0?l.toString():l.toFixed(2))+"kg";t+=0===a?(e<0?"-":"")+s:(e<0?"-":"+")+s}));const a=Number(this.totalBackNet),l=Math.abs(a),s=(l%1==0?l.toString():l.toFixed(2))+"kg";return t+="="+(a<0?"-":"")+s,t},totalInOutNet(){if("truck"===this.bizMode)return this.truckNetNumber.toFixed(2);const e=Number(this.totalOutNet),t=Number(this.totalBackNet);return((isNaN(e)?0:e)-(isNaN(t)?0:t)).toFixed(2)},totalInOutNetDetail(){if("truck"===this.bizMode){const e=this.truckNetNumber;if(!e)return"";const t=(e=>{const t=Math.abs(e);return t%1==0?t.toString():t.toFixed(2)})(e);return`${t}kg=${t}kg`}const e=Number(this.totalOutNet),t=Number(this.totalBackNet),a=isNaN(e)?0:e,l=isNaN(t)?0:t;if(!a&&!l)return"";const s=e=>{const t=Math.abs(e);return t%1==0?t.toString():t.toFixed(2)},r=s(a),o=s(l),u=s(a-l);return l>0?`${r}kg-${o}kg=${u}kg`:l<0?`${r}kg+${o}kg=${u}kg`:`${r}kg=${u}kg`},unitPriceNumber(){const e=Number(this.header.unit_price);return isNaN(e)?0:e},outAmount(){const e=this.unitPriceNumber;if(!e)return"0";if("truck"===this.bizMode)return(this.truckNetNumber*e).toFixed(2);if("bottle"===this.header.price_unit){return(this.outBottles.filter((e=>e.number.trim())).length*e).toFixed(2)}return"kg"===this.header.price_unit?(Number(this.totalOutNet)*e).toFixed(2):"0"},backAmount(){const e=this.unitPriceNumber;if(!e)return 0;if("bottle"===this.header.price_unit||"m3"===this.header.price_unit)return 0;const t=Number(this.totalBackNet);return Number((t*e).toFixed(2))},shouldReceive(){return(Number(this.outAmount)-Number(this.backAmount)).toFixed(2)},flowTheoryOutNet(){return"truck"===this.bizMode?this.truckNetNumber:Number(this.totalOutNet)||0},flowTheoryBackNet(){return"truck"===this.bizMode?0:Number(this.totalBackNet)||0}},watch:{"header.customer_id"(e){this.isFlowPriceMode&&e&&this.loadLastFlowIndexForCustomer(e)},"header.payment_status":{immediate:!0,handler(e){const t=this.paymentStatusOptions.indexOf(e);this.paymentStatusIndex=t>=0?t:0}},"header.price_unit":{immediate:!0,handler(e){this.priceUnitIndex="kg"===e?0:"bottle"===e?1:"m3"===e?2:0,"m3"===e&&this.header.customer_id&&this.loadLastFlowIndexForCustomer(this.header.customer_id)}}},onLoad(e){if(!x())return g({title:"请先登录",icon:"none",duration:1500}),void setTimeout((()=>{"function"==typeof B&&B()}),800);const t=e&&(e.id||e.sale_id);t&&(this.editId=t,this.isEditing=!0);const a=new Date,l=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0"),r=String(a.getDate()).padStart(2,"0");this.header.date=`${l}-${s}-${r}`,this.todayText=`${s} 月 ${r} 日`,this.flowTheoryRatio=this.defaultRatio,this.loadCustomers(),this.loadDeliveryList(),this.loadVehicles(),this.debouncedBottleSuggest=function(e,t=200){let a=null;return function(...l){clearTimeout(a),a=setTimeout((()=>{e.apply(this,l)}),t)}}(this.doBottleSuggest,200),this.isEditing&&this.editId&&this.loadSaleForEdit(this.editId)},methods:{handleAuthError(e){const t=e&&e.result&&e.result.code,a=e&&e.result&&e.result.msg||"";return(401===t||"UNAUTHORIZED"===t||"NO_LOGIN"===t||"AUTH_FAILED"===t||-1!==a.indexOf("未登录")||-1!==a.indexOf("登录已过期"))&&(g({title:"登录已过期，请重新登录",icon:"none",duration:1500}),setTimeout((()=>{"function"==typeof B&&B()}),800),!0)},async loadSaleForEdit(e){var t;if(!e)return;const a=I();try{const l=await b.callFunction({name:"crm-sale",data:{action:"get",token:a,data:{id:e}}});if(this.handleAuthError(l))return;if(!l.result||0!==l.result.code||!l.result.data)return void g({title:(null==(t=l.result)?void 0:t.msg)||"未找到销售记录",icon:"none"});const s=l.result.data;let r=s.delivery_man_1||s.delivery1||"",o=s.delivery_man_2||s.delivery2||"";if((!r||!o)&&s.delivery_man){const e=String(s.delivery_man).split(/[\/、,，]/).map((e=>e.trim())).filter(Boolean);r||(r=e[0]||""),o||(o=e[1]||"")}this.header={date:s.date||"",customer_id:s.customer_id||s.customerId||"",customer_name:s.customer_name||s.customerName||"",delivery_man_1:r,delivery_man_2:o,vehicle_id:s.vehicle_id||s.vehicleId||"",car_no:s.car_no||"",unit_price:null!=s.unit_price?String(s.unit_price):"",price_unit:(s.price_unit||s.priceUnit||"kg").toLowerCase(),amount_received:null!=s.amount_received?String(s.amount_received):"",payment_status:s.payment_status||"挂账",remark:s.remark||"",biz_mode:s.biz_mode||s.bizMode||"bottle",truck_gross:null!=s.truck_gross?String(s.truck_gross):"",truck_tare:null!=s.truck_tare?String(s.truck_tare):"",truck_net:null!=s.truck_net?String(s.truck_net):""},"number"==typeof s.flow_theory_ratio&&(this.flowTheoryRatio=s.flow_theory_ratio);const u=s.out_items||s.outItems||[];Array.isArray(u)&&u.length?this.outBottles=u.map((e=>({number:e.bottle_no||e.bottleInput||"",gross:null!=e.gross?String(e.gross):"",tare:null!=e.tare?String(e.tare):"",net:null!=e.net?String(e.net):"",bottleId:e.bottle_id||e.bottleId||null,exists:!0,suggestions:[],fromSelect:!1,netManual:!0}))):s.bottle_no&&(this.outBottles=[{number:s.bottle_no,gross:null!=s.gross_weight_out?String(s.gross_weight_out):"",tare:null!=s.tare_weight_out?String(s.tare_weight_out):"",net:null!=s.net_weight_out?String(s.net_weight_out):"",bottleId:s.bottle_id||null,exists:!0,suggestions:[],fromSelect:!1,netManual:!0}]);const i=s.back_items||s.backItems||[];Array.isArray(i)&&i.length?this.backBottles=i.map((e=>({number:e.bottle_no||e.bottleInput||"",gross:null!=e.gross?String(e.gross):"",tare:null!=e.tare?String(e.tare):"",net:null!=e.net?String(e.net):"",bottleId:e.bottle_id||e.bottleId||null,exists:!0,suggestions:[],fromSelect:!1,netManual:!0}))):s.return_bottle_no&&(this.backBottles=[{number:s.return_bottle_no,gross:null!=s.gross_weight_back?String(s.gross_weight_back):"",tare:null!=s.tare_weight_back?String(s.tare_weight_back):"",net:null!=s.net_weight_back?String(s.net_weight_back):"",bottleId:s.return_bottle_id||null,exists:!0,suggestions:[],fromSelect:!1,netManual:!0}]);const n=s.deposit_bottles_raw||s.depositBottlesRaw||"";if(n){const e=String(n).split(/[\/\s,，]+/).map((e=>e.trim())).filter(Boolean);e.length&&(this.depositBottles=e.map((e=>({number:e,bottleId:null,exists:null,suggestions:[],fromSelect:!1}))))}"m3"===(s.price_unit||s.priceUnit)&&(this.flowSettle={prev:null!=s.flow_index_prev?String(s.flow_index_prev):"",curr:null!=s.flow_index_curr?String(s.flow_index_curr):"",volume:null!=s.flow_volume_m3?String(s.flow_volume_m3):"",amount:null!=s.flow_amount_should?String(s.flow_amount_should):"",amount_received:null!=s.flow_amount_received?String(s.flow_amount_received):"",payment_status:s.flow_payment_status||"挂账",remark:s.flow_remark||"",flow_index_prev:s.flow_index_prev,flow_index_curr:s.flow_index_curr,flow_volume:s.flow_volume_m3,flow_unit_price:s.flow_unit_price||s.unit_price||"",flow_amount_should:s.flow_amount_should,flow_amount_received:s.flow_amount_received,flow_payment_status:s.flow_payment_status||"挂账",flow_remark:s.flow_remark||""}),this.syncSelectIndexesFromHeader()}catch(l){console.error("loadSaleForEdit error",l),g({title:"加载销售记录失败",icon:"none"})}},syncSelectIndexesFromHeader(){if(this.header.customer_id&&Array.isArray(this.customers)){const e=this.customers.findIndex((e=>e._id===this.header.customer_id));this.customerIndex=e}if(Array.isArray(this.deliveryList)){if(this.header.delivery_man_1){const e=this.deliveryList.findIndex((e=>e.name===this.header.delivery_man_1));this.deliveryIndex1=e}if(this.header.delivery_man_2){const e=this.deliveryList.findIndex((e=>e.name===this.header.delivery_man_2));this.deliveryIndex2=e}}if(this.header.vehicle_id&&Array.isArray(this.vehicleList)){const e=this.vehicleList.findIndex((e=>e._id===this.header.vehicle_id));this.vehicleIndex=e}},onFlowSettleChange(e){const t={...this.flowSettle||{},...e||{}};t.flow_index_prev=t.prev,t.flow_index_curr=t.curr,t.flow_volume=t.volume,t.flow_amount_should=t.amount,t.flow_amount_received=t.amount_received,t.flow_payment_status=t.payment_status,t.flow_remark=t.remark,t.flow_unit_price=this.header.unit_price,this.flowSettle=t},onUpdateFlowRatio(e){this.flowTheoryRatio=e||0},goBack(){y().length>1?k():v({url:"/pages/dashboard/index"})},onCustomerChange(e){const t=Number(e.detail.value);this.customerIndex=t;const a=this.customers[t];a?(this.header.customer_id=a._id,this.header.customer_name=a.name):(this.header.customer_id="",this.header.customer_name="")},onCustomerInput(e){const t=e.detail.value.trim();if(this.customerKeyword=t,!t)return this.customerSuggests=[],this.header.customer_id="",void(this.header.customer_name="");const a=(this.customers||[]).filter((e=>!(!e||!e.name)&&-1!==e.name.indexOf(t)));this.customerSuggests=a.slice(0,20)},onSelectCustomer(e){e&&(this.header.customer_id=e._id,this.header.customer_name=e.name,this.customerKeyword=e.name,this.customerSuggests=[])},onDeliveryChange1(e){const t=Number(e.detail.value);this.deliveryIndex1=t;const a=this.deliveryList[t];this.header.delivery_man_1=a?a.name:""},onDeliveryChange2(e){const t=Number(e.detail.value);this.deliveryIndex2=t;const a=this.deliveryList[t];this.header.delivery_man_2=a?a.name:""},onVehicleChange(e){const t=Number(e.detail.value);this.vehicleIndex=t;const a=this.vehicleList[t];if(a){this.header.vehicle_id=a._id||"";const e=a.car_no||a.plate_no||a.plateNo||"";this.header.car_no=e}else this.header.vehicle_id="",this.header.car_no=""},resetForm(){const e=this.header.date,t=this.bizMode||"bottle",a=this.header.payment_status||"挂账",l=this.header.price_unit||"kg";this.header={date:e,customer_id:"",customer_name:"",delivery_man_1:"",delivery_man_2:"",vehicle_id:"",car_no:"",unit_price:"",price_unit:l,amount_received:"",payment_status:a,remark:"",biz_mode:t,truck_gross:"",truck_tare:"",truck_net:""},this.truckNetManual=!1,this.flowTheoryRatio=this.defaultRatio,this.flowSettle={prev:"",curr:"",volume:"",amount:"",amount_received:"",payment_status:"挂账",remark:"",flow_index_prev:"",flow_index_curr:"",flow_volume:"",flow_unit_price:"",flow_amount_should:"",flow_amount_received:"",flow_payment_status:"挂账",flow_remark:""},this.customerIndex=-1,this.deliveryIndex1=-1,this.deliveryIndex2=-1,this.vehicleIndex=-1,this.outBottles=[{number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1}],this.backBottles=[{number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1}],this.depositBottles=[{number:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1}]},updateTruckNet(){if(this.truckNetManual)return;const e=Number(this.header.truck_gross),t=Number(this.header.truck_tare);isNaN(e)||isNaN(t)?this.header.truck_net="":this.header.truck_net=(e-t).toFixed(2)},onTruckWeightBlur(){this.updateTruckNet()},async searchBottle(e){const t=e.trim();if(!t)return[];if(this.bottleSearchCache[t])return this.bottleSearchCache[t];if(this.bottleSearchPending[t])return this.bottleSearchPending[t];const a=I(),l=b.callFunction({name:"crm-bottle",data:{action:"search",token:a,data:{keyword:t,limit:20}}}).then((e=>{var a;const l=(null==(a=e.result)?void 0:a.data)||[];return this.$set(this.bottleSearchCache,t,l),delete this.bottleSearchPending[t],l})).catch((e=>(console.error("searchBottle error",e),delete this.bottleSearchPending[t],[])));return this.bottleSearchPending[t]=l,l},async doBottleSuggest(e,t,a){const l=await this.searchBottle(a);const s=("out"===e?this.outBottles:"back"===e?this.backBottles:this.depositBottles)[t];s&&s.number.trim()===a.trim()&&this.$set(s,"suggestions",l)},async loadCustomers(){var e;try{const t=I(),a=await b.callFunction({name:"crm-customer",data:{action:"list",token:t,data:{}}});if(this.handleAuthError(a))return;0===(null==(e=a.result)?void 0:e.code)&&(this.customers=a.result.data||[],this.syncSelectIndexesFromHeader())}catch(t){console.error("加载客户异常",t)}},async loadLastFlowIndexForCustomer(e){var t;if(e)try{const a=I(),l=await b.callFunction({name:"crm-sale",data:{action:"getLastFlowRecord",token:a,data:{customerId:e}}});if(this.handleAuthError(l))return;const s=null==(t=l.result)?void 0:t.data;if(s&&null!=s.flowIndexCurr){const e=s.flowIndexCurr;this.flowSettle.flow_index_prev=e,this.flowSettle.prev=e}else this.flowSettle.flow_index_prev="",this.flowSettle.prev=""}catch(a){console.error("loadLastFlowIndexForCustomer error",a)}},async loadDeliveryList(){var e;try{const t=I(),a=await b.callFunction({name:"crm-delivery",data:{action:"list",token:t,data:{}}});if(this.handleAuthError(a))return;0===(null==(e=a.result)?void 0:e.code)&&(this.deliveryList=a.result.data||[],this.syncSelectIndexesFromHeader())}catch(t){console.error("加载配送员异常",t)}},async loadVehicles(){var e;try{const t=I(),a=await b.callFunction({name:"crm-vehicle",data:{action:"list",token:t,data:{}}});if(this.handleAuthError(a))return;0===(null==(e=a.result)?void 0:e.code)&&(this.vehicleList=a.result.data||[],this.syncSelectIndexesFromHeader())}catch(t){console.error("加载车辆异常",t)}},onDateChange(e){this.header.date=e.detail.value},onPriceUnitChange(e){const t=Number(e.detail.value);this.priceUnitIndex=t,this.header.price_unit=0===t?"kg":1===t?"bottle":"m3"},onPaymentStatusChange(e){const t=Number(e.detail.value);this.paymentStatusIndex=t,this.header.payment_status=this.paymentStatusOptions[t]},addOutBottleRow(){this.outBottles.push({number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1})},removeOutBottleRow(e){this.outBottles.length<=1||this.outBottles.splice(e,1)},async onOutBottleInput(e,t){const a=t.detail.value.trim(),l=this.outBottles[e];l.number=a,l.fromSelect=!1,l.exists=null,l.bottleId=null,a?this.debouncedBottleSuggest("out",e,a):l.suggestions=[]},onSelectOutBottle(e,t){const a=this.outBottles[e];a.number=t.number,a.tare=null!=t.tare_weight?String(t.tare_weight):a.tare,a.bottleId=t._id,a.exists=!0,a.fromSelect=!0,a.suggestions=[],a.netManual=!1,this.updateOutNet(e)},async onOutBottleBlur(e){var t;const a=this.outBottles[e],l=a.number.trim();if(l&&(!a.suggestions.length||a.fromSelect)&&!a.fromSelect)try{const s=I(),r=null==(t=(await b.callFunction({name:"crm-bottle",data:{action:"getByNumber",token:s,data:{number:l}}})).result)?void 0:t.data;r?(a.exists=!0,a.bottleId=r._id,a.tare||null==r.tare_weight||(a.tare=String(r.tare_weight)),a.netManual=!1,this.updateOutNet(e)):(a.exists=!1,a.bottleId=null,w({title:"提示",content:`系统中不存在瓶号 ${l}。\n保存时会自动加入瓶子库，请记得填写皮重。`,showCancel:!1}))}catch(s){console.error("check bottle error",s)}},updateOutNet(e){const t=this.outBottles[e];if(t.netManual)return;const a=Number(t.gross),l=Number(t.tare);isNaN(a)||isNaN(l)||(t.net=(a-l).toFixed(2))},addBackBottleRow(){this.backBottles.push({number:"",gross:"",tare:"",net:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1,netManual:!1})},removeBackBottleRow(e){this.backBottles.length<=1||this.backBottles.splice(e,1)},async onBackBottleInput(e,t){const a=t.detail.value.trim(),l=this.backBottles[e];l.number=a,l.fromSelect=!1,l.exists=null,l.bottleId=null,a?this.debouncedBottleSuggest("back",e,a):l.suggestions=[]},onSelectBackBottle(e,t){const a=this.backBottles[e];a.number=t.number,a.tare=null!=t.tare_weight?String(t.tare_weight):a.tare,a.bottleId=t._id,a.exists=!0,a.fromSelect=!0,a.suggestions=[],a.netManual=!1,this.updateBackNet(e)},async onBackBottleBlur(e){var t;const a=this.backBottles[e],l=a.number.trim();if(l&&(!a.suggestions.length||a.fromSelect)&&!a.fromSelect)try{const s=I(),r=null==(t=(await b.callFunction({name:"crm-bottle",data:{action:"getByNumber",token:s,data:{number:l}}})).result)?void 0:t.data;r?(a.exists=!0,a.bottleId=r._id,a.tare||null==r.tare_weight||(a.tare=String(r.tare_weight)),a.netManual=!1,this.updateBackNet(e)):(a.exists=!1,a.bottleId=null,w({title:"提示",content:`系统中不存在瓶号 ${l}。\n保存时会自动加入瓶子库，请记得填写皮重。`,showCancel:!1}))}catch(s){console.error("check back bottle error",s)}},updateBackNet(e){const t=this.backBottles[e];if(t.netManual)return;const a=Number(t.gross),l=Number(t.tare);isNaN(a)||isNaN(l)?t.net="":t.net=(a-l).toFixed(2)},addDepositBottleRow(){this.depositBottles.push({number:"",bottleId:null,exists:null,suggestions:[],fromSelect:!1})},removeDepositBottleRow(e){this.depositBottles.length<=1||this.depositBottles.splice(e,1)},async onDepositBottleInput(e,t){const a=t.detail.value.trim(),l=this.depositBottles[e];l.number=a,l.fromSelect=!1,l.exists=null,l.bottleId=null,a?this.debouncedBottleSuggest("deposit",e,a):l.suggestions=[]},onSelectDepositBottle(e,t){const a=this.depositBottles[e];a.number=t.number,a.bottleId=t._id,a.exists=!0,a.fromSelect=!0,a.suggestions=[]},async onDepositBottleBlur(e){var t;const a=this.depositBottles[e],l=a.number.trim();if(l&&(!a.suggestions.length||a.fromSelect)&&!a.fromSelect)try{const e=I(),s=null==(t=(await b.callFunction({name:"crm-bottle",data:{action:"getByNumber",token:e,data:{number:l}}})).result)?void 0:t.data;s?(a.exists=!0,a.bottleId=s._id):(a.exists=!1,a.bottleId=null,w({title:"提示",content:`系统中不存在瓶号 ${l}，\n保存时会自动加入瓶子库，后续可在瓶子管理中补充皮重等信息。`,showCancel:!1}))}catch(s){console.error("check deposit bottle error",s)}},async ensureNewBottlesCreated(){const e=I(),t=[],a=(t,a)=>{const l={number:t};return"number"!=typeof a||Number.isNaN(a)||(l.tare_weight=a),b.callFunction({name:"crm-bottle",data:{action:"quickCreate",token:e,data:l}})},l=async(l,s)=>{if(!l||!l.number)return;const r=String(l.number).trim();if(!r)return;let o=null,u=!1;if(s){const e=Number(l.tare);Number.isNaN(e)||(o=e,u=!0)}if(!1!==l.exists){if(null==l.exists)try{const i=await b.callFunction({name:"crm-bottle",data:{action:"getByNumber",token:e,data:{number:r}}}),n=i.result&&i.result.data;if(n&&n._id)return l.exists=!0,void(l.bottleId=n._id);if(s&&!u)return;t.push(a(r,s?o:void 0)),l.exists=!1}catch(i){console.error("ensureNewBottlesCreated getByNumber error",i)}}else{if(s&&!u)return;t.push(a(r,s?o:void 0))}};for(const r of this.outBottles)await l(r,!0);for(const r of this.backBottles)await l(r,!0);if(Array.isArray(this.depositBottles))for(const r of this.depositBottles)await l(r,!1);if(!t.length)return!0;try{return await Promise.all(t),!0}catch(s){return console.error("ensureNewBottlesCreated quickCreate error",s),g({title:"自动创建瓶子失败",icon:"none"}),!1}},async handleSubmit(){var e,t;if(!this.header.date)return g({title:"请选择日期",icon:"none"});if(!this.header.customer_id&&!this.header.customer_name)return g({title:"请选择客户",icon:"none"});if(!(await this.ensureNewBottlesCreated()))return;const a=I();let l=this.header.unit_price;"m3"===this.header.price_unit&&this.flowSettle.flow_unit_price&&(l=this.flowSettle.flow_unit_price);let s=this.header.amount_received,r=this.header.payment_status;"m3"===this.header.price_unit&&(""!==this.flowSettle.flow_amount_received&&(s=this.flowSettle.flow_amount_received),this.flowSettle.flow_payment_status&&(r=this.flowSettle.flow_payment_status));const o={date:this.header.date,customerId:this.header.customer_id,customerName:this.header.customer_name,unitPrice:l,priceUnit:this.header.price_unit,delivery1:this.header.delivery_man_1,delivery2:this.header.delivery_man_2,vehicleId:this.header.vehicle_id,car_no:this.header.car_no,remark:this.header.remark,amountReceived:s,paymentStatus:r,paymentNote:"",bizMode:this.bizMode,truckGross:this.header.truck_gross,truckTare:this.header.truck_tare,truckNet:this.header.truck_net,flow_theory_ratio:this.flowTheoryRatio};"m3"===this.header.price_unit&&Object.assign(o,{flow_index_prev:this.flowSettle.flow_index_prev,flow_index_curr:this.flowSettle.flow_index_curr,flow_volume:this.flowSettle.flow_volume,flow_unit_price:this.flowSettle.flow_unit_price,flow_amount_should:this.flowSettle.flow_amount_should,flow_amount_received:this.flowSettle.flow_amount_received,flow_payment_status:this.flowSettle.flow_payment_status,flow_remark:this.flowSettle.flow_remark});const u={base:o,outRows:this.outBottles.map((e=>({bottleInput:e.number.trim(),gross:e.gross,tare:e.tare,net:e.net,bottleId:e.bottleId}))),backRows:this.backBottles.map((e=>({bottleInput:e.number.trim(),gross:e.gross,tare:e.tare,net:e.net,bottleId:e.bottleId}))),depositRows:this.depositBottles.map((e=>({bottleInput:e.number.trim(),bottleId:e.bottleId}))),source:"manual-v2"},i=this.isEditing?"updateV2":"createV2",n=this.isEditing?{action:i,token:a,data:{id:this.editId,...u}}:{action:i,token:a,data:u};this.submitting=!0;try{const a=await b.callFunction({name:"crm-sale",data:n});if(this.handleAuthError(a))return;0===(null==(e=a.result)?void 0:e.code)?(g({title:a.result.msg||(this.isEditing?"修改已保存":"保存成功"),icon:"success",duration:2e3}),this.isEditing?setTimeout((()=>{this.goBack()}),500):this.resetForm&&this.resetForm()):g({title:(null==(t=a.result)?void 0:t.msg)||"保存失败",icon:"none"})}catch(d){g({title:"请求异常",icon:"none"})}finally{this.submitting=!1}}}},[["render",function(g,b,y,k,v,w){const x=N("BackToDashboardBar"),B=c,I=m,C=N("SaleBasicInfoCard"),F=h,V=S,T=N("FlowTheoryCard"),M=_,O=p,A=N("FlowSettlementCard");return e(),t(I,{class:"sale-page"},{default:a((()=>[l(I,{class:"sale-inner"},{default:a((()=>[l(x,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),l(I,{class:"page-header"},{default:a((()=>[l(I,{class:"page-header-left"},{default:a((()=>[l(I,{class:"page-icon"},{default:a((()=>[l(B,{class:"page-icon-text"},{default:a((()=>[s("记")])),_:1})])),_:1}),l(I,{class:"page-header-text"},{default:a((()=>[l(B,{class:"page-title"},{default:a((()=>[s("新增销售记录")])),_:1}),l(B,{class:"page-sub"},{default:a((()=>[s(" 分别记录出瓶、回瓶、存瓶与结算信息，方便后续统计与对账 ")])),_:1})])),_:1})])),_:1}),l(I,{class:"page-header-right"},{default:a((()=>[l(I,{class:"tag-soft"},{default:a((()=>[l(B,{class:"tag-dot"}),l(B,{class:"tag-text"},{default:a((()=>[s("今日 · "+d(v.todayText),1)])),_:1})])),_:1})])),_:1})])),_:1}),l(C,{value:v.header,onInput:b[0]||(b[0]=e=>v.header=e),customers:v.customers,deliveryList:v.deliveryList,vehicleList:v.vehicleList},null,8,["value","customers","deliveryList","vehicleList"]),w.showBottleCards?(e(),t(I,{key:0,class:"card-row"},{default:a((()=>[l(I,{class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[s("出瓶")])),_:1}),l(B,{class:"card-sub"},{default:a((()=>[s("本次送出去的瓶子，可添加多行")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[(e(!0),o(i,null,u(v.outBottles,((r,c)=>(e(),t(I,{key:"out-"+c,class:"bottle-row"},{default:a((()=>[l(I,{class:"row-header"},{default:a((()=>[l(I,{class:"row-header-left"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("瓶号")])),_:1})])),_:1}),v.outBottles.length>1?(e(),t(I,{key:0,class:"row-header-right"},{default:a((()=>[l(B,{class:"delete-text",onClick:e=>w.removeOutBottleRow(c)},{default:a((()=>[s("删除")])),_:2},1032,["onClick"])])),_:2},1024)):n("",!0)])),_:2},1024),l(I,{class:"form-item"},{default:a((()=>[l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",modelValue:r.number,"onUpdate:modelValue":e=>r.number=e,placeholder:"例如 207，支持模糊搜索",onInput:e=>w.onOutBottleInput(c,e),onBlur:e=>w.onOutBottleBlur(c)},null,8,["modelValue","onUpdate:modelValue","onInput","onBlur"])])),_:2},1024),r.suggestions&&r.suggestions.length?(e(),t(I,{key:0,class:"bottle-suggest"},{default:a((()=>[(e(!0),o(i,null,u(r.suggestions,(r=>(e(),t(I,{key:r._id,class:"suggest-item",onClick:f((e=>w.onSelectOutBottle(c,r)),["stop"])},{default:a((()=>[l(B,{class:"suggest-no"},{default:a((()=>[s(d(r.number),1)])),_:2},1024),l(B,{class:"suggest-sub"},{default:a((()=>[s(" 皮重 "+d(null!=r.tare_weight?r.tare_weight:"-")+"kg · "+d(v.statusTextMap[r.status]||"未知状态"),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:2},1024)):n("",!0)])),_:2},1024),l(I,{class:"form-row"},{default:a((()=>[l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("毛重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"kg",modelValue:r.gross,"onUpdate:modelValue":e=>r.gross=e,onBlur:e=>w.updateOutNet(c)},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024)])),_:2},1024),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("皮重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"kg",modelValue:r.tare,"onUpdate:modelValue":e=>r.tare=e,onBlur:e=>w.updateOutNet(c)},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024)])),_:2},1024),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("净重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"若不填将按 毛重-皮重 自动计算",modelValue:r.net,"onUpdate:modelValue":e=>r.net=e,onInput:e=>r.netManual=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])])),_:2},1024)])),_:2},1024)])),_:2},1024),l(I,{class:"row-divider"})])),_:2},1024)))),128)),l(I,{class:"btn-row-inline"},{default:a((()=>[l(V,{class:"btn-soft",onClick:w.addOutBottleRow},{default:a((()=>[s(" + 添加出瓶 ")])),_:1},8,["onClick"])])),_:1}),l(I,{class:"summary-chip"},{default:a((()=>[l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[s("本次出瓶净重合计：")])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[s(d(w.totalOutNet)+" kg",1)])),_:1})])),_:1}),w.totalOutNetDetail?(e(),t(I,{key:0,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[s(d(w.totalOutNetDetail),1)])),_:1})])),_:1})):n("",!0)])),_:1})])),_:1})])),_:1}),l(I,{class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[s("回收瓶")])),_:1}),l(B,{class:"card-sub"},{default:a((()=>[s("本次从客户处回收的瓶子，可添加多行")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[(e(!0),o(i,null,u(v.backBottles,((r,c)=>(e(),t(I,{key:"back-"+c,class:"bottle-row"},{default:a((()=>[l(I,{class:"row-header"},{default:a((()=>[l(I,{class:"row-header-left"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("回收瓶号")])),_:1})])),_:1}),v.backBottles.length>1?(e(),t(I,{key:0,class:"row-header-right"},{default:a((()=>[l(B,{class:"delete-text",onClick:e=>w.removeBackBottleRow(c)},{default:a((()=>[s("删除")])),_:2},1032,["onClick"])])),_:2},1024)):n("",!0)])),_:2},1024),l(I,{class:"form-item"},{default:a((()=>[l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",modelValue:r.number,"onUpdate:modelValue":e=>r.number=e,placeholder:"例如 114 / 207",onInput:e=>w.onBackBottleInput(c,e),onBlur:e=>w.onBackBottleBlur(c)},null,8,["modelValue","onUpdate:modelValue","onInput","onBlur"])])),_:2},1024),r.suggestions&&r.suggestions.length?(e(),t(I,{key:0,class:"bottle-suggest"},{default:a((()=>[(e(!0),o(i,null,u(r.suggestions,(r=>(e(),t(I,{key:r._id,class:"suggest-item",onClick:f((e=>w.onSelectBackBottle(c,r)),["stop"])},{default:a((()=>[l(B,{class:"suggest-no"},{default:a((()=>[s(d(r.number),1)])),_:2},1024),l(B,{class:"suggest-sub"},{default:a((()=>[s(" 皮重 "+d(null!=r.tare_weight?r.tare_weight:"-")+"kg · "+d(v.statusTextMap[r.status]||"未知状态"),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:2},1024)):n("",!0)])),_:2},1024),l(I,{class:"form-row"},{default:a((()=>[l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("毛重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"kg",modelValue:r.gross,"onUpdate:modelValue":e=>r.gross=e,onBlur:e=>w.updateBackNet(c)},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024)])),_:2},1024),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("皮重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"kg",modelValue:r.tare,"onUpdate:modelValue":e=>r.tare=e,onBlur:e=>w.updateBackNet(c)},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024)])),_:2},1024),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("净重 (kg)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"若不填将按 毛重-皮重 自动计算，可手动改为负数/正数",modelValue:r.net,"onUpdate:modelValue":e=>r.net=e,onInput:e=>r.netManual=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])])),_:2},1024)])),_:2},1024)])),_:2},1024),l(I,{class:"row-divider"})])),_:2},1024)))),128)),l(I,{class:"btn-row-inline"},{default:a((()=>[l(V,{class:"btn-soft",onClick:w.addBackBottleRow},{default:a((()=>[s(" + 添加回瓶 ")])),_:1},8,["onClick"])])),_:1}),l(I,{class:"summary-chip-column"},{default:a((()=>[l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[s("本次回瓶净重合计：")])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[s(d(w.totalBackNet)+" kg",1)])),_:1})])),_:1}),w.totalBackNetDetail?(e(),t(I,{key:0,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[s(d(w.totalBackNetDetail),1)])),_:1})])),_:1})):n("",!0),l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[s("按单价结算：")])),_:1}),l(B,{class:r(["summary-value",{"summary-positive":w.backAmount<0,"summary-negative":w.backAmount>0}])},{default:a((()=>[s(d(w.backAmountAbs)+" 元 ",1)])),_:1},8,["class"]),l(B,{class:"summary-tip"},{default:a((()=>[s(d(w.backAmountDirectionText),1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})):n("",!0),l(I,{class:"card-row"},{default:a((()=>["bottle"===w.bizMode?(e(),t(I,{key:0,class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[s("存瓶号")])),_:1}),l(B,{class:"card-sub"},{default:a((()=>[s("记录当前留在客户处的瓶子，可添加多行")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[(e(!0),o(i,null,u(v.depositBottles,((r,c)=>(e(),t(I,{key:"dep-"+c,class:"bottle-row"},{default:a((()=>[l(I,{class:"row-header"},{default:a((()=>[l(I,{class:"row-header-left"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("存瓶号")])),_:1})])),_:1}),v.depositBottles.length>1?(e(),t(I,{key:0,class:"row-header-right"},{default:a((()=>[l(B,{class:"delete-text",onClick:e=>w.removeDepositBottleRow(c)},{default:a((()=>[s("删除")])),_:2},1032,["onClick"])])),_:2},1024)):n("",!0)])),_:2},1024),l(I,{class:"form-item"},{default:a((()=>[l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",modelValue:r.number,"onUpdate:modelValue":e=>r.number=e,placeholder:"例如 207",onInput:e=>w.onDepositBottleInput(c,e),onBlur:e=>w.onDepositBottleBlur(c)},null,8,["modelValue","onUpdate:modelValue","onInput","onBlur"])])),_:2},1024),r.suggestions&&r.suggestions.length?(e(),t(I,{key:0,class:"bottle-suggest"},{default:a((()=>[(e(!0),o(i,null,u(r.suggestions,(r=>(e(),t(I,{key:r._id,class:"suggest-item",onClick:f((e=>w.onSelectDepositBottle(c,r)),["stop"])},{default:a((()=>[l(B,{class:"suggest-no"},{default:a((()=>[s(d(r.number),1)])),_:2},1024),l(B,{class:"suggest-sub"},{default:a((()=>[s(" 皮重 "+d(null!=r.tare_weight?r.tare_weight:"-")+"kg · "+d(v.statusTextMap[r.status]||"未知状态"),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:2},1024)):n("",!0)])),_:2},1024),l(I,{class:"row-divider"})])),_:2},1024)))),128)),l(I,{class:"btn-row-inline"},{default:a((()=>[l(V,{class:"btn-soft",onClick:w.addDepositBottleRow},{default:a((()=>[s(" + 添加存瓶 ")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})):n("",!0),l(T,{totalOutNet:w.flowTheoryOutNet,totalBackNet:w.flowTheoryBackNet,ratio:v.flowTheoryRatio,onUpdateRatio:w.onUpdateFlowRatio},null,8,["totalOutNet","totalBackNet","ratio","onUpdateRatio"]),"truck"===w.bizMode?(e(),t(I,{key:1,class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[s("整车信息")])),_:1}),l(B,{class:"card-sub"},{default:a((()=>[s("记录整车毛重 / 皮重 / 净重，用于整车结算")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[l(I,{class:"form-row"},{default:a((()=>[l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("毛重 (吨)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"整车毛重（吨）",modelValue:w.truckGrossTon,"onUpdate:modelValue":b[1]||(b[1]=e=>w.truckGrossTon=e),onBlur:w.onTruckWeightBlur},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("皮重 (吨)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"车辆皮重（吨）",modelValue:w.truckTareTon,"onUpdate:modelValue":b[2]||(b[2]=e=>w.truckTareTon=e),onBlur:w.onTruckWeightBlur},null,8,["modelValue","onBlur"])])),_:1})])),_:1}),l(I,{class:"form-item col"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("净重 (吨)")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"若不填按 毛重-皮重 自动算（吨）",modelValue:w.truckNetTon,"onUpdate:modelValue":b[3]||(b[3]=e=>w.truckNetTon=e)},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),l(I,{class:"summary-chip"},{default:a((()=>[l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[s("整车净重：")])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[s(d((w.truckNetNumber/1e3).toFixed(2))+" 吨 ",1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})):n("",!0),w.isFlowPriceMode?(e(),t(A,{key:3,unitPrice:v.header.unit_price,prevIndex:v.flowSettle.prev,currIndex:v.flowSettle.curr,amountReceived:v.flowSettle.amount_received,paymentStatus:v.flowSettle.payment_status,remark:v.flowSettle.remark,paymentStatusOptions:v.paymentStatusOptions,onInput:w.onFlowSettleChange},null,8,["unitPrice","prevIndex","currIndex","amountReceived","paymentStatus","remark","paymentStatusOptions","onInput"])):(e(),t(I,{key:2,class:"card"},{default:a((()=>[l(I,{class:"card-header"},{default:a((()=>[l(B,{class:"card-title"},{default:a((()=>[s("结算与其他")])),_:1})])),_:1}),l(I,{class:"card-body"},{default:a((()=>[l(I,{class:"form-row"},{default:a((()=>[l(I,{class:"form-item col-half"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("实收金额")])),_:1}),l(I,{class:"input-wrapper"},{default:a((()=>[l(F,{class:"input",type:"number",placeholder:"本次实际收了多少，可为 0",modelValue:v.header.amount_received,"onUpdate:modelValue":b[4]||(b[4]=e=>v.header.amount_received=e)},null,8,["modelValue"])])),_:1})])),_:1}),l(I,{class:"form-item col-half"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("付款状态")])),_:1}),l(M,{mode:"selector",range:v.paymentStatusOptions,value:v.paymentStatusIndex,onChange:w.onPaymentStatusChange},{default:a((()=>[l(I,{class:"input-wrapper"},{default:a((()=>[l(I,{class:"picker"},{default:a((()=>[l(B,null,{default:a((()=>[s(d(w.paymentStatusLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1}),l(I,{class:"summary-chip-column"},{default:a((()=>[l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[s(d("truck"===w.bizMode?"整车应收：":"本次出瓶应收："),1)])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[s(d(w.outAmount)+" 元",1)])),_:1})])),_:1}),w.outAmountDetail?(e(),t(I,{key:0,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[s(d(w.outAmountDetail),1)])),_:1})])),_:1})):n("",!0),l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[s("回瓶结算调整：")])),_:1}),l(B,{class:r(["summary-value",{"summary-positive":w.backAmount<0,"summary-negative":w.backAmount>0}])},{default:a((()=>[s(d(w.backAmountDisplayForSummary)+" 元 ",1)])),_:1},8,["class"])])),_:1}),w.backAmountDetail?(e(),t(I,{key:1,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[s(d(w.backAmountDetail),1)])),_:1})])),_:1})):n("",!0),l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label"},{default:a((()=>[s(d("truck"===w.bizMode?"整车净重：":"出瓶与回瓶总净重："),1)])),_:1}),l(B,{class:"summary-value"},{default:a((()=>[s(d(w.totalInOutNet)+" kg",1)])),_:1})])),_:1}),w.totalInOutNetDetail?(e(),t(I,{key:2,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[s(d(w.totalInOutNetDetail),1)])),_:1})])),_:1})):n("",!0),l(I,{class:"summary-line"},{default:a((()=>[l(B,{class:"summary-label-strong"},{default:a((()=>[s("理论应收合计：")])),_:1}),l(B,{class:"summary-value-strong"},{default:a((()=>[s(d(w.shouldReceive)+" 元",1)])),_:1})])),_:1}),w.shouldReceiveDetail?(e(),t(I,{key:3,class:"summary-line"},{default:a((()=>[l(B,{class:"summary-formula"},{default:a((()=>[s(d(w.shouldReceiveDetail),1)])),_:1})])),_:1})):n("",!0)])),_:1}),l(I,{class:"form-item"},{default:a((()=>[l(B,{class:"label"},{default:a((()=>[s("备注")])),_:1}),l(O,{class:"textarea",placeholder:"例如：欠对方7公斤（2月13日清）",modelValue:v.header.remark,"onUpdate:modelValue":b[5]||(b[5]=e=>v.header.remark=e)},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}))])),_:1}),l(I,{class:"btn-row-bottom"},{default:a((()=>[l(V,{class:"btn-soft",onClick:w.resetForm},{default:a((()=>[s("重置")])),_:1},8,["onClick"]),l(V,{class:"btn-primary",type:"primary",loading:v.submitting,onClick:w.handleSubmit},{default:a((()=>[s(" 保存销售记录 ")])),_:1},8,["loading","onClick"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-5cd65667"]]);export{V as default};
