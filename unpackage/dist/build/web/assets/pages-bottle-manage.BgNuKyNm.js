import{s as t,n as e,l as a,v as s,c as l,w as i,i as n,o,d as r,e as u,f as d,q as c,x as _,y as h,F as g,B as f,g as m,I as p,z as b,j as k,D as w,p as x}from"./index-B6DdPhlT.js";import{_ as C,e as v,g as y,i as F,f as S}from"./_plugin-vue_export-helper.Dda_PF8M.js";import{c as B}from"./request.DMeHGM82.js";import{B as I}from"./BackToDashboardBar.0jhbkRhX.js";const N=C({components:{BackToDashboardBar:I},data:()=>({isAdmin:!1,statusTextMap:{in_station:"在站",at_customer:"在客户",repairing:"维修",scrapped:"报废",lost:"丢失",unknown:"未维护"},statusOptions:[{value:"",label:"全部状态"},{value:"in_station",label:"在站"},{value:"at_customer",label:"在客户"},{value:"repairing",label:"维修"},{value:"scrapped",label:"报废"},{value:"lost",label:"丢失"},{value:"unknown",label:"未维护"}],keyword:"",statusFilter:"",statusPickerIndex:0,list:[],page:1,pageSize:20,total:0,loading:!1,showEditDialog:!1,editMode:"create",editForm:{id:"",number:"",tare_weight:"",status:"in_station",remark:"",filling_gross_weight:"",filling_net_weight:"",last_gross_weight:"",last_net_weight:"",last_return_diff:"",next_out_gross:"",next_out_net:""},saving:!1,editStatusIndex:1,pendingBottleNumber:"",hasAutoOpenFromParam:!1}),computed:{statusFilterLabel(){const t=this.statusOptions[this.statusPickerIndex];return t?t.label:"全部状态"},editStatusLabel(){const t=this.statusOptions[this.editStatusIndex];return t?t.label:""},pageCount(){return this.total&&this.pageSize?Math.ceil(this.total/this.pageSize):0}},onLoad(t){if(!v())return;const e=y()||{};this.isAdmin=F(e),t&&t.number&&(this.keyword=t.number,this.pendingBottleNumber=t.number),this.fetchList(!0)},methods:{async callBottle(t,e={}){const a=await B("crm-bottle",{action:t,data:e});return 401===a.code?null:a},effectiveLastBackNet(t){const e=null!=t.last_back_net_weight?Number(t.last_back_net_weight):null;return null==e||Number.isNaN(e)?"—":e.toFixed(2)+" kg"},isReturnAnomaly(t){const e=Number(t.last_back_net_weight);return!Number.isNaN(e)&&Math.abs(e)>5},onStatusChange(t){const e=Number(t.detail.value);this.statusPickerIndex=e,this.statusFilter=this.statusOptions[e].value},resetFilter(){this.keyword="",this.statusFilter="",this.statusPickerIndex=0,this.page=1,this.pendingBottleNumber="",this.hasAutoOpenFromParam=!1,this.fetchList(!0)},onSearch(){this.page=1,this.fetchList(!0)},async fetchList(e=!1){e&&(this.page=1),this.loading=!0;try{const e=await this.callBottle("list",{keyword:this.keyword,status:this.statusFilter||void 0,page:this.page,pageSize:this.pageSize});e&&0===e.code?(this.list=e.data||[],this.total=e.total||0,this.isAdmin&&this.pendingBottleNumber&&!this.hasAutoOpenFromParam&&1===this.list.length&&this.list[0].number===this.pendingBottleNumber&&(this.openEdit(this.list[0]),this.hasAutoOpenFromParam=!0)):e&&401!==e.code&&t({title:e&&e.msg||"加载失败",icon:"none"})}catch(a){console.error("fetch bottles error",a),t({title:"请求出错",icon:"none"})}finally{this.loading=!1}},changePage(t){const e=this.page+t;e<1||this.pageCount&&e>this.pageCount||(this.page=e,this.fetchList())},openCreate(){if(!this.isAdmin)return t({title:"无权限",icon:"none"});this.editMode="create",this.editForm={id:"",number:"",tare_weight:"",status:"in_station",remark:"",filling_gross_weight:"",filling_net_weight:"",last_gross_weight:"",last_net_weight:"",last_return_diff:"",next_out_gross:"",next_out_net:""},this.editStatusIndex=this.statusOptions.findIndex((t=>"in_station"===t.value)),this.editStatusIndex<0&&(this.editStatusIndex=1),this.showEditDialog=!0},openEdit(e){if(!this.isAdmin)return t({title:"无权限",icon:"none"});this.editMode="edit",this.editForm={id:e._id,number:e.number,tare_weight:null!=e.tare_weight?String(e.tare_weight):"",status:e.status||"unknown",remark:e.remark||"",filling_gross_weight:null!=e.filling_gross_weight?String(e.filling_gross_weight):"",filling_net_weight:null!=e.filling_net_weight?String(e.filling_net_weight):"",last_gross_weight:null!=e.last_gross_weight?String(e.last_gross_weight):"",last_net_weight:null!=e.last_net_weight?String(e.last_net_weight):"",last_return_diff:null!=e.last_return_diff?String(e.last_return_diff):"",next_out_gross:null!=e.next_out_gross?String(e.next_out_gross):"",next_out_net:null!=e.next_out_net?String(e.next_out_net):""};const a=this.statusOptions.findIndex((t=>t.value===this.editForm.status));this.editStatusIndex=a>=0?a:0,this.showEditDialog=!0},closeDialog(){this.saving||(this.showEditDialog=!1)},onBottleNumberInput(t){let e=(t.detail.value||"").replace(/\s+/g,"");e=e.toUpperCase().replace(/[^A-Z0-9-]/g,""),this.editForm.number=e.slice(0,20)},normalizeBottleNumber(){const t=(this.editForm.number||"").trim().toUpperCase();if(!t)return"";return/^[A-Z0-9-]{2,20}$/.test(t)?t:null},normalizeWeight(e,a){const s=null!=e?String(e).trim():"";if(!s)return null;const l=Number(s);return!Number.isFinite(l)||l<0?(t({title:`${a}需为非负数字`,icon:"none"}),!1):Number(l.toFixed(3))},onEditStatusChange(t){const e=Number(t.detail.value);this.editStatusIndex=e,this.editForm.status=this.statusOptions[e].value||"unknown"},async saveBottle(){if(!this.isAdmin)return t({title:"无权限",icon:"none"});const e=this.normalizeBottleNumber();if(""===e)return t({title:"瓶号不能为空",icon:"none"});if(null===e)return t({title:"瓶号仅支持字母、数字或 -，请检查",icon:"none"});const a=this.normalizeWeight(this.editForm.tare_weight,"皮重");if(!1===a)return;if(!S())return;const s={number:e,tare_weight:a,status:this.editForm.status,remark:(this.editForm.remark||"").trim()};this.saving=!0;try{const e="create"===this.editMode?await this.callBottle("create",s):await this.callBottle("update",{id:this.editForm.id,...s});e&&0===e.code?(t({title:"create"===this.editMode?"新增成功":"保存成功",icon:"success"}),this.showEditDialog=!1,this.fetchList()):e&&401!==e.code&&t({title:e&&e.msg||"操作失败",icon:"none"})}catch(l){console.error("save bottle error",l),t({title:"请求出错",icon:"none"})}finally{this.saving=!1}},goDetail(t){t&&t.number&&e({url:`/pages/bottle/detail?number=${encodeURIComponent(t.number)}`})},removeItem(e){if(!this.isAdmin)return t({title:"无权限",icon:"none"});a({title:"确认删除",content:`确认删除瓶号 ${e.number} 吗？`,success:async a=>{if(a.confirm)try{const a=await this.callBottle("remove",{id:e._id});a&&0===a.code?(t({title:"已删除",icon:"success"}),1===this.list.length&&this.page>1&&(this.page-=1),this.fetchList()):a&&401!==a.code&&t({title:a&&a.msg||"删除失败",icon:"none"})}catch(s){console.error("remove bottle error",s),t({title:"请求出错",icon:"none"})}}})}}},[["render",function(t,e,a,C,v,y){const F=s("BackToDashboardBar"),S=m,B=n,I=p,N=b,A=k,D=w;return o(),l(B,{class:"bottle-page"},{default:i((()=>[r(B,{class:"bottle-inner"},{default:i((()=>[r(F),r(B,{class:"page-header"},{default:i((()=>[r(B,{class:"page-header-left"},{default:i((()=>[r(B,{class:"page-icon"},{default:i((()=>[r(S,{class:"page-icon-text"},{default:i((()=>[u("瓶")])),_:1})])),_:1}),r(B,{class:"page-header-text"},{default:i((()=>[r(S,{class:"page-title"},{default:i((()=>[u("瓶子管理")])),_:1}),r(S,{class:"page-sub"},{default:i((()=>[u(" 维护瓶子的皮重、状态与备注，支持按瓶号快速搜索 ")])),_:1})])),_:1})])),_:1}),r(B,{class:"page-header-right"},{default:i((()=>[r(B,{class:"tag-soft"},{default:i((()=>[r(S,{class:"tag-dot"}),r(S,{class:"tag-text"},{default:i((()=>[u("共 "+d(v.total)+" 只瓶子",1)])),_:1})])),_:1})])),_:1})])),_:1}),r(B,{class:"card"},{default:i((()=>[r(B,{class:"card-header"},{default:i((()=>[r(S,{class:"card-title"},{default:i((()=>[u("筛选")])),_:1})])),_:1}),r(B,{class:"card-body"},{default:i((()=>[r(B,{class:"form-row"},{default:i((()=>[r(B,{class:"form-item col-half"},{default:i((()=>[r(S,{class:"label"},{default:i((()=>[u("瓶号关键字")])),_:1}),r(B,{class:"input-wrapper"},{default:i((()=>[r(I,{class:"input",placeholder:"例如：J2 / 20，支持前缀匹配",modelValue:v.keyword,"onUpdate:modelValue":e[0]||(e[0]=t=>v.keyword=t),onConfirm:y.onSearch},null,8,["modelValue","onConfirm"])])),_:1})])),_:1}),r(B,{class:"form-item col-half"},{default:i((()=>[r(S,{class:"label"},{default:i((()=>[u("状态")])),_:1}),r(N,{mode:"selector",range:v.statusOptions,"range-key":"label",value:v.statusPickerIndex,onChange:y.onStatusChange},{default:i((()=>[r(B,{class:"input-wrapper"},{default:i((()=>[r(B,{class:"picker"},{default:i((()=>[r(S,null,{default:i((()=>[u(d(y.statusFilterLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1}),r(B,{class:"btn-row-inline"},{default:i((()=>[r(A,{class:"btn-soft",onClick:y.resetFilter},{default:i((()=>[u("重置")])),_:1},8,["onClick"]),r(A,{class:"btn-primary",onClick:y.onSearch},{default:i((()=>[u("查询")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1}),r(B,{class:"card"},{default:i((()=>[r(B,{class:"card-header"},{default:i((()=>[r(S,{class:"card-title"},{default:i((()=>[u("瓶子列表")])),_:1}),r(B,{class:"card-header-right"},{default:i((()=>[v.isAdmin?(o(),l(A,{key:0,class:"btn-soft",onClick:y.openCreate},{default:i((()=>[u(" + 新增瓶子 ")])),_:1},8,["onClick"])):c("",!0)])),_:1})])),_:1}),r(B,{class:"card-body"},{default:i((()=>[v.loading?(o(),l(B,{key:0,class:"list-empty"},{default:i((()=>[r(S,{class:"empty-text"},{default:i((()=>[u("加载中...")])),_:1})])),_:1})):v.list.length?(o(),l(B,{key:2},{default:i((()=>[(o(!0),_(g,null,h(v.list,(t=>(o(),l(B,{key:t._id,class:"bottle-item",onClick:e=>y.goDetail(t)},{default:i((()=>[r(B,{class:"bottle-main"},{default:i((()=>[r(B,{class:"bottle-line"},{default:i((()=>[r(S,{class:"bottle-no"},{default:i((()=>[u("瓶号："+d(t.number),1)])),_:2},1024),r(B,{class:x(["status-pill","status-"+(t.status||"unknown")])},{default:i((()=>[r(S,{class:"status-dot"}),r(S,{class:"status-text"},{default:i((()=>[u(d(v.statusTextMap[t.status]||"未维护"),1)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1024),r(B,{class:"bottle-line"},{default:i((()=>[r(S,{class:"bottle-meta"},{default:i((()=>[u(" 铭牌皮重： "+d(null!=t.tare_weight?t.tare_weight+" kg":"—"),1)])),_:2},1024),r(S,{class:x(["bottle-meta",{"danger-text":y.isReturnAnomaly(t)}])},{default:i((()=>[u(" 上次回瓶净重："+d(y.effectiveLastBackNet(t)),1)])),_:2},1032,["class"])])),_:2},1024),r(B,{class:"bottle-line"},{default:i((()=>[r(S,{class:"bottle-meta"},{default:i((()=>[u(" 最近灌装： "+d(t.last_fill_date?t.last_fill_date+" · "+(null!=t.last_fill_net?t.last_fill_net+" kg":"—"):"—"),1)])),_:2},1024),r(S,{class:"bottle-meta"},{default:i((()=>[u(" 上次客户："+d(t.last_customer_name||"—"),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),v.isAdmin?(o(),l(B,{key:0,class:"bottle-actions",onClick:e[1]||(e[1]=f((()=>{}),["stop"]))},{default:i((()=>[r(A,{class:"btn-mini",onClick:e=>y.openEdit(t)},{default:i((()=>[u("编辑")])),_:2},1032,["onClick"]),r(A,{class:"btn-mini btn-danger",onClick:e=>y.removeItem(t)},{default:i((()=>[u(" 删除 ")])),_:2},1032,["onClick"])])),_:2},1024)):c("",!0)])),_:2},1032,["onClick"])))),128)),r(B,{class:"pagination"},{default:i((()=>[r(A,{class:"btn-mini",disabled:v.page<=1,onClick:e[2]||(e[2]=t=>y.changePage(-1))},{default:i((()=>[u(" 上一页 ")])),_:1},8,["disabled"]),r(S,{class:"page-info"},{default:i((()=>[u(" 第 "+d(v.page)+" / "+d(y.pageCount||1)+" 页 ",1)])),_:1}),r(A,{class:"btn-mini",disabled:v.page>=y.pageCount,onClick:e[3]||(e[3]=t=>y.changePage(1))},{default:i((()=>[u(" 下一页 ")])),_:1},8,["disabled"])])),_:1})])),_:1})):(o(),l(B,{key:1,class:"list-empty"},{default:i((()=>[r(S,{class:"empty-text"},{default:i((()=>[u("暂无数据")])),_:1})])),_:1}))])),_:1})])),_:1}),v.showEditDialog?(o(),l(B,{key:0,class:"dialog-mask",onClick:f(y.closeDialog,["self"])},{default:i((()=>[r(B,{class:"dialog-body"},{default:i((()=>[r(B,{class:"dialog-header"},{default:i((()=>[r(S,{class:"dialog-title"},{default:i((()=>[u(d("create"===v.editMode?"新增瓶子":"编辑瓶子"),1)])),_:1})])),_:1}),r(B,{class:"dialog-content"},{default:i((()=>[r(B,{class:"form-item"},{default:i((()=>[r(S,{class:"label"},{default:i((()=>[u("* 瓶号")])),_:1}),r(B,{class:"input-wrapper"},{default:i((()=>[r(I,{class:"input",placeholder:"例如：201 / J201",value:v.editForm.number,maxlength:"20",onInput:y.onBottleNumberInput},null,8,["value","onInput"])])),_:1})])),_:1}),r(B,{class:"form-row"},{default:i((()=>[r(B,{class:"form-item col-half"},{default:i((()=>[r(S,{class:"label"},{default:i((()=>[u("皮重 (kg)")])),_:1}),r(B,{class:"input-wrapper"},{default:i((()=>[r(I,{class:"input",type:"number",placeholder:"可空",modelValue:v.editForm.tare_weight,"onUpdate:modelValue":e[4]||(e[4]=t=>v.editForm.tare_weight=t)},null,8,["modelValue"])])),_:1})])),_:1}),r(B,{class:"form-item col-half"},{default:i((()=>[r(S,{class:"label"},{default:i((()=>[u("状态")])),_:1}),r(N,{mode:"selector",range:v.statusOptions,"range-key":"label",value:v.editStatusIndex,onChange:y.onEditStatusChange},{default:i((()=>[r(B,{class:"input-wrapper"},{default:i((()=>[r(B,{class:"picker"},{default:i((()=>[r(S,null,{default:i((()=>[u(d(y.editStatusLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1}),r(B,{class:"form-item"},{default:i((()=>[r(S,{class:"label"},{default:i((()=>[u("备注")])),_:1}),r(D,{class:"textarea",placeholder:"例如：瓶身有划痕，优先安排维修",modelValue:v.editForm.remark,"onUpdate:modelValue":e[5]||(e[5]=t=>v.editForm.remark=t)},null,8,["modelValue"])])),_:1})])),_:1}),r(B,{class:"dialog-footer"},{default:i((()=>[r(A,{class:"btn-soft",onClick:y.closeDialog},{default:i((()=>[u("取消")])),_:1},8,["onClick"]),r(A,{class:"btn-primary",loading:v.saving,onClick:y.saveBottle},{default:i((()=>[u(" 保存 ")])),_:1},8,["loading","onClick"])])),_:1})])),_:1})])),_:1},8,["onClick"])):c("",!0)])),_:1})])),_:1})}],["__scopeId","data-v-e2bbd502"]]);export{N as default};
