import{y as e,j as t,t as a,k as s,z as i,r as l,s as o,n as c,q as n,c as r,w as d,i as u,o as f,d as h,e as m,p as _,m as g,u as k,v as p,F as y,f as w,g as v,I as C,l as A,A as b}from"./index-C85BGToL.js";import{B as L}from"./BackToDashboardBar.BBeceW6P.js";import{g as B}from"./auth.yulpUJA0.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";const F=x({components:{BackToDashboardBar:L},data:()=>({keyword:"",filterActive:"all",customers:[],loading:!1,finished:!1,page:1,pageSize:30,userInfo:{}}),computed:{isAdmin(){return"admin"===(this.userInfo&&this.userInfo.role)}},onLoad(){this.userInfo=B()||{},this.fetchList(!0)},onShow(){this.userInfo=B()||{},this.fetchList(!0)},onPullDownRefresh(){this.fetchList(!0).finally((()=>{e()}))},onReachBottom(){this.loadMore()},methods:{getToken:()=>t("crm_token")||t("token")||"",async fetchList(e=!1){if(!this.loading&&(e&&(this.page=1,this.customers=[],this.finished=!1),!this.finished)){this.loading=!0;try{const t=this.getToken(),c=(await a.callFunction({name:"crm-customer",data:{action:"list",token:t,data:{keyword:this.keyword,is_active:"all"===this.filterActive?void 0:"active"===this.filterActive,page:this.page,pageSize:this.pageSize}}})).result||{};if(401===c.code)return void s({title:"提示",content:c.msg||"登录已过期，请重新登录",showCancel:!1,success:()=>{i(),l({url:"/pages/login/login"})}});if(0!==c.code)return void o({title:c.msg||"加载失败",icon:"none"});const n=c.data||[];this.customers=e?n:this.customers.concat(n),n.length<this.pageSize?this.finished=!0:this.page+=1}catch(t){console.error("加载客户列表异常",t),o({title:"请求出错",icon:"none"})}finally{this.loading=!1}}},onSearch(){this.fetchList(!0)},clearKeyword(){this.keyword="",this.fetchList(!0)},onFilterChange(e){this.filterActive!==e&&(this.filterActive=e,this.fetchList(!0))},loadMore(){this.fetchList(!1)},onRowClick(e){this.isAdmin&&this.goEdit(e)},goCreate(){if(!this.isAdmin)return o({title:"当前账号无权限新增客户",icon:"none"});c({url:"/pages/customer/edit"})},goEdit(e){if(!this.isAdmin)return o({title:"当前账号无权限编辑客户",icon:"none"});c({url:"/pages/customer/edit?id="+e._id})},async onRemove(e){if(!this.isAdmin)return o({title:"当前账号无权限删除客户",icon:"none"});s({title:"确认删除",content:`确定要删除客户「${e.name||""}」吗？\n删除后不可恢复，请谨慎操作。`,success:async t=>{if(t.confirm)try{const t=this.getToken(),s=(await a.callFunction({name:"crm-customer",data:{action:"remove",token:t,data:{id:e._id}}})).result||{};if(0!==s.code)return o({title:s.msg||"删除失败",icon:"none"});o({title:"已删除",icon:"success"}),this.customers=this.customers.filter((t=>t._id!==e._id))}catch(s){console.error("删除客户失败",s),o({title:"删除失败",icon:"none"})}}})}}},[["render",function(e,t,a,s,i,l){const o=n("BackToDashboardBar"),c=w,L=u,B=v,x=C;return f(),r(L,{class:"page"},{default:d((()=>[h(L,{class:"page-inner"},{default:d((()=>[h(o,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),h(L,{class:"page-header"},{default:d((()=>[h(L,{class:"page-header-left"},{default:d((()=>[h(L,{class:"page-icon"},{default:d((()=>[h(c,{class:"page-icon-text"},{default:d((()=>[m("客")])),_:1})])),_:1}),h(L,{class:"page-header-text"},{default:d((()=>[h(c,{class:"page-title"},{default:d((()=>[m("客户管理")])),_:1}),h(c,{class:"page-sub"},{default:d((()=>[m("维护客户档案、默认单价与联系信息")])),_:1})])),_:1})])),_:1}),h(L,{class:"page-header-right"},{default:d((()=>[l.isAdmin?(f(),r(B,{key:0,class:"btn-primary",onClick:l.goCreate},{default:d((()=>[m("+ 新增客户")])),_:1},8,["onClick"])):_("",!0)])),_:1})])),_:1}),h(L,{class:"card"},{default:d((()=>[h(L,{class:"filter-row"},{default:d((()=>[h(L,{class:"search-wrapper"},{default:d((()=>[h(x,{class:"search-input",modelValue:i.keyword,"onUpdate:modelValue":t[0]||(t[0]=e=>i.keyword=e),placeholder:"按客户名 / 联系人 / 电话搜索","confirm-type":"search",onConfirm:l.onSearch},null,8,["modelValue","onConfirm"]),i.keyword?(f(),r(L,{key:0,class:"search-clear",onClick:l.clearKeyword},{default:d((()=>[m("×")])),_:1},8,["onClick"])):_("",!0)])),_:1}),h(L,{class:"segmented"},{default:d((()=>[h(L,{class:g(["seg-item",{active:"all"===i.filterActive}]),onClick:t[1]||(t[1]=e=>l.onFilterChange("all"))},{default:d((()=>[m(" 全部 ")])),_:1},8,["class"]),h(L,{class:g(["seg-item",{active:"active"===i.filterActive}]),onClick:t[2]||(t[2]=e=>l.onFilterChange("active"))},{default:d((()=>[m(" 启用 ")])),_:1},8,["class"]),h(L,{class:g(["seg-item",{active:"inactive"===i.filterActive}]),onClick:t[3]||(t[3]=e=>l.onFilterChange("inactive"))},{default:d((()=>[m(" 停用 ")])),_:1},8,["class"])])),_:1})])),_:1})])),_:1}),h(L,{class:"card"},{default:d((()=>[i.loading&&0===i.customers.length?(f(),r(L,{key:0,class:"empty"},{default:d((()=>[h(c,{class:"empty-main"},{default:d((()=>[m("加载中…")])),_:1})])),_:1})):i.loading||0!==i.customers.length?(f(),r(L,{key:2},{default:d((()=>[(f(!0),k(y,null,p(i.customers,(e=>(f(),r(L,{key:e._id,class:"customer-row",onClick:t=>l.onRowClick(e)},{default:d((()=>[h(L,{class:"row-main"},{default:d((()=>[h(L,{class:"row-title-line"},{default:d((()=>[h(c,{class:"row-name"},{default:d((()=>[m(A(e.name||"未命名客户"),1)])),_:2},1024),h(L,{class:g(["status-tag",{inactive:!1===e.is_active}])},{default:d((()=>[!1===e.is_active?(f(),r(c,{key:0},{default:d((()=>[m("停用")])),_:1})):(f(),r(c,{key:1},{default:d((()=>[m("启用")])),_:1}))])),_:2},1032,["class"])])),_:2},1024),h(L,{class:"row-meta"},{default:d((()=>[e.contact?(f(),r(c,{key:0,class:"row-meta-item"},{default:d((()=>[m(" 联系人："+A(e.contact),1)])),_:2},1024)):_("",!0),e.phone?(f(),r(c,{key:1,class:"row-meta-item"},{default:d((()=>[m(" 电话："+A(e.phone),1)])),_:2},1024)):_("",!0)])),_:2},1024),h(L,{class:"row-meta"},{default:d((()=>[e.address?(f(),r(c,{key:0,class:"row-meta-item"},{default:d((()=>[m(" 地址："+A(e.address),1)])),_:2},1024)):_("",!0)])),_:2},1024),h(L,{class:"row-meta"},{default:d((()=>[null!=e.default_unit_price?(f(),r(c,{key:0,class:"row-meta-item strong"},{default:d((()=>[m(" 默认单价："+A(e.default_unit_price)+" 元 / "+A("bottle"===e.default_price_unit?"瓶":"kg"),1)])),_:2},1024)):_("",!0)])),_:2},1024),e.remark?(f(),r(L,{key:0,class:"row-remark"},{default:d((()=>[m(" 备注："+A(e.remark),1)])),_:2},1024)):_("",!0)])),_:2},1024),l.isAdmin?(f(),r(L,{key:0,class:"row-actions",onClick:t[4]||(t[4]=b((()=>{}),["stop"]))},{default:d((()=>[h(B,{class:"btn-mini",onClick:t=>l.goEdit(e)},{default:d((()=>[m("编辑")])),_:2},1032,["onClick"]),h(B,{class:"btn-mini danger",onClick:t=>l.onRemove(e)},{default:d((()=>[m("删除")])),_:2},1032,["onClick"])])),_:2},1024)):_("",!0)])),_:2},1032,["onClick"])))),128)),h(L,{class:"list-footer"},{default:d((()=>[i.finished?(f(),r(c,{key:0},{default:d((()=>[m("没有更多了")])),_:1})):i.loading?(f(),r(c,{key:1},{default:d((()=>[m("加载中…")])),_:1})):(f(),r(c,{key:2,onClick:l.loadMore,class:"load-more"},{default:d((()=>[m("加载更多")])),_:1},8,["onClick"]))])),_:1})])),_:1})):(f(),r(L,{key:1,class:"empty"},{default:d((()=>[h(c,{class:"empty-main"},{default:d((()=>[m("暂无客户")])),_:1}),h(c,{class:"empty-sub"},{default:d((()=>[m("点击右上角“新增客户”开始建立客户档案")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-63b4b81b"]]);export{F as default};
