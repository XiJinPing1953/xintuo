import{s as t,l as e,v as a,c as l,w as s,i,o,d as r,e as n,p as d,f as c,q as u,x as f,y as m,F as h,g,z as _,I as b,j as p,D as y,B as w}from"./index-B6DdPhlT.js";import{B as k}from"./BackToDashboardBar.0jhbkRhX.js";import{_ as S,e as v,g as B,i as R}from"./_plugin-vue_export-helper.Dda_PF8M.js";import{c as F}from"./request.DMeHGM82.js";const x=S({components:{BackToDashboardBar:k},data:()=>({userInfo:{},isAdmin:!1,deliveryList:[],operatorSuggestions:[],showOperatorDropdown:!1,filterPreset:"month",dateRange:{start:"",end:""},bottleFilter:"",loadingSummary:!1,summary:{inbound_total:0,inbound_load_total:0,inbound_loss_total:0,fill_total:0,sale_total:0},loadingList:!1,fillingList:[],form:{bottle_no:"",date:"",tare_fill:"",gross_fill:"",operator:"",remark:""},submitting:!1,diffThreshold:5,statusTextMap:{in_station:"在站",at_customer:"在客户",repairing:"维修",scrapped:"报废",lost:"丢失",unknown:"未知"},bottleSuggestions:[],bottleSearchCache:{},bottleSearchPending:{},debouncedBottleSuggest:null,bottleExists:null,lastBottleInfo:null,isEditing:!1,editingId:null}),computed:{netFillRaw(){const t=Number(this.form.tare_fill),e=Number(this.form.gross_fill);return isNaN(t)||isNaN(e)?0:+(e-t)},netFillText(){return this.netFillRaw.toFixed(2)},diffInboundFillRaw(){const{inbound_total:t,fill_total:e}=this.summary;return+(Number(t||0)-Number(e||0))},diffFillSaleRaw(){const{fill_total:t,sale_total:e}=this.summary;return+(Number(t||0)-Number(e||0))},diffInboundSaleRaw(){const{inbound_total:t,sale_total:e}=this.summary;return+(Number(t||0)-Number(e||0))},loadToInboundLossRaw(){const{inbound_loss_total:t,inbound_load_total:e,inbound_total:a}=this.summary;return null!=t?+Number(t||0):+(Number(e||0)-Number(a||0))},inventoryEstimateRaw(){const{inbound_total:t,sale_total:e}=this.summary;return+(Number(t||0)-Number(e||0))},showTareWarning(){if(!this.lastBottleInfo)return!1;const t=Number(this.lastBottleInfo.tare_weight),e=Number(this.form.tare_fill);return!isNaN(t)&&!isNaN(e)&&Math.abs(e-t)>=3},effectiveLastBackNet(){const t=this.lastBottleInfo;return t?null!=t.last_back_net_weight?Number(t.last_back_net_weight):null!=t.last_net_weight?Number(t.last_net_weight):null:null},deliveryNames(){return(this.deliveryList||[]).map((t=>t.name||t.real_name||t.phone||"")).filter(Boolean)}},onLoad(){v()&&(this.userInfo=B()||{},this.isAdmin=R(this.userInfo),this.resetForm(),this.loadDeliveryList(),this.initMonthRange(),this.fetchAll(),this.debouncedBottleSuggest=function(t,e=200){let a=null;return function(...l){clearTimeout(a),a=setTimeout((()=>{t.apply(this,l)}),e)}}(this.doBottleSuggest,200))},onShow(){v()},methods:{async callFilling(t,e={}){const a=await F("crm-filling",{action:t,data:e});return 401===a.code?null:a},async loadDeliveryList(){try{const t=await F("crm-delivery",{action:"list",data:{}});if(!t||0!==t.code)return;this.deliveryList=Array.isArray(t.data)?t.data:[],this.syncOperatorPicker()}catch(t){console.error("load delivery list error",t)}},bottleStatusText(t){return this.statusTextMap[t]||"未知状态"},syncOperatorPicker(){this.updateOperatorSuggestions(this.form.operator)},onOperatorInput(t){const e=t.detail&&"string"==typeof t.detail.value?t.detail.value:"";this.form.operator=e,this.updateOperatorSuggestions(e)},onOperatorFocus(){this.showOperatorDropdown=!0,this.updateOperatorSuggestions(this.form.operator)},onOperatorBlur(){setTimeout((()=>{this.showOperatorDropdown=!1}),120)},selectOperator(t){const e=t&&(t.name||t.real_name||t.phone)||"";this.form.operator=e,this.showOperatorDropdown=!1},updateOperatorSuggestions(t=""){const e=Array.isArray(this.deliveryList)?this.deliveryList:[],a=(t||"").trim().toLowerCase(),l=e.map((t=>({...t,display:(t.name||t.real_name||t.phone||"").trim()}))).filter((t=>t.display)).filter((t=>!a||t.display.toLowerCase().includes(a))).slice(0,8);this.operatorSuggestions=l,this.showOperatorDropdown=this.isAdmin&&l.length>0},formatDate:t=>`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`,todayStr(){return this.formatDate(new Date)},formatKg(t){const e=Number(t);return isNaN(e)?"0.00":e.toFixed(2)},changePreset(t){this.filterPreset===t&&"custom"!==t||(this.filterPreset=t,"today"===t?(this.initTodayRange(),this.fetchAll()):"week"===t?(this.initWeekRange(),this.fetchAll()):"month"===t?(this.initMonthRange(),this.fetchAll()):"custom"===t&&this.dateRange.start&&this.dateRange.end&&this.fetchAll())},onDateChange(t,e){const a=t.detail.value;this.dateRange[e]=a,this.dateRange.start&&this.dateRange.end&&this.fetchAll()},initTodayRange(){const t=new Date,e=this.formatDate(t);this.dateRange.start=e,this.dateRange.end=e},initWeekRange(){const t=new Date,e=t.getDay()||7,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()-e+1);this.dateRange.start=this.formatDate(a),this.dateRange.end=this.formatDate(t)},initMonthRange(){const t=new Date,e=new Date(t.getFullYear(),t.getMonth(),1);this.dateRange.start=this.formatDate(e),this.dateRange.end=this.formatDate(t)},fetchAll(){this.fetchSummary(),this.fetchList()},async fetchSummary(){if(this.dateRange.start&&this.dateRange.end){this.loadingSummary=!0;try{const t=await this.callFilling("summary",{start_date:this.dateRange.start,end_date:this.dateRange.end});t&&0===t.code&&t.data&&(this.summary=Object.assign({},this.summary,t.data||{}))}catch(t){console.error("fetchSummary exception:",t)}finally{this.loadingSummary=!1}}},async fetchList(){if(this.dateRange.start&&this.dateRange.end){this.loadingList=!0;try{const t=await this.callFilling("list",{page:1,pageSize:100,start_date:this.dateRange.start,end_date:this.dateRange.end,bottle_no:this.bottleFilter||void 0});t&&0===t.code&&Array.isArray(t.data)?this.fillingList=t.data:t&&401!==t.code&&(console.warn("fetchList error:",t.msg),this.fillingList=[])}catch(t){console.error("fetchList exception:",t),this.fillingList=[]}finally{this.loadingList=!1}}},clearBottleFilter(){this.bottleFilter="",this.fetchList(!0)},async searchBottle(t){const e=(t||"").trim();if(!e)return[];if(this.bottleSearchCache[e])return this.bottleSearchCache[e];if(this.bottleSearchPending[e])return this.bottleSearchPending[e];const a=F("crm-bottle",{action:"search",data:{keyword:e,limit:20}}).then((t=>{if(t&&401===t.code)return[];const a=t&&t.data||[];return this.$set(this.bottleSearchCache,e,a),delete this.bottleSearchPending[e],a})).catch((t=>(console.error("searchBottle error",t),delete this.bottleSearchPending[e],[])));return this.bottleSearchPending[e]=a,a},async doBottleSuggest(t){const e=await this.searchBottle(t);(this.form.bottle_no||"").trim()===(t||"").trim()&&(this.bottleSuggestions=e)},onBottleInput(t){const e=(t.detail.value||"").trim();this.form.bottle_no=e,this.bottleExists=null,this.lastBottleInfo=null,e?this.debouncedBottleSuggest&&this.debouncedBottleSuggest(e):this.bottleSuggestions=[]},async onSelectBottle(t){if(t){this.form.bottle_no=t.number||"",null!=t.tare_weight&&""===this.form.tare_fill&&(this.form.tare_fill=String(t.tare_weight)),this.bottleExists=!0,this.bottleSuggestions=[];try{const e=await F("crm-bottle",{action:"detail",data:{number:t.number}}),a=e&&e.data;if(e&&401===e.code)return;a&&(this.lastBottleInfo=a)}catch(e){console.error("load bottle detail after select error",e)}}},async onBottleBlur(){const t=(this.form.bottle_no||"").trim();if(t&&(!this.bottleSuggestions||!this.bottleSuggestions.length))try{const e=await F("crm-bottle",{action:"getByNumber",data:{number:t}});if(e&&401===e.code)return;const a=e&&e.data;e&&0===e.code&&a?(this.bottleExists=!0,this.form.tare_fill||null==a.tare_weight||(this.form.tare_fill=String(a.tare_weight)),this.lastBottleInfo=a):(this.bottleExists=!1,this.lastBottleInfo=null)}catch(e){console.error("onBottleBlur getByNumber error",e)}},startEdit(e){this.isAdmin?e&&e._id&&(this.isEditing=!0,this.editingId=e._id,this.form={bottle_no:e.bottle_no||"",date:e.date||this.todayStr(),tare_fill:null!=e.tare_fill?String(e.tare_fill):"",gross_fill:null!=e.gross_fill?String(e.gross_fill):"",operator:e.operator||"",remark:e.remark||""},this.bottleSuggestions=[],this.bottleExists=!0,this.lastBottleInfo=null):t({title:"无权限，仅管理员可编辑",icon:"none"})},exitEditMode(){this.isEditing=!1,this.editingId=null,this.resetForm()},onSubmitClick(){this.isAdmin?this.isEditing?this.submitEdit():this.submitForm():t({title:"无权限，仅管理员可录入灌装记录",icon:"none"})},async submitForm(){if(!this.form.bottle_no)return void t({title:"请填写瓶号",icon:"none"});const a=Number(this.form.tare_fill),l=Number(this.form.gross_fill);if(isNaN(a)||isNaN(l))return void t({title:"请正确填写皮重和毛重",icon:"none"});if(l<=a)return void t({title:"毛重要大于皮重",icon:"none"});this.submitting=!0;const s=(this.form.bottle_no||"").trim();try{let o=this.bottleExists;if(null==o)try{const t=await F("crm-bottle",{action:"getByNumber",data:{number:s}});if(t&&401===t.code)return void(this.submitting=!1);const e=t&&t.data;o=!(!t||0!==t.code||!e)}catch(i){console.error("submitForm getByNumber error",i)}if(o){const e=await this.doCreateFilling(a,l);return 0===e.code?(t({title:"已保存",icon:"success"}),this.resetForm(),this.fetchAll()):t({title:e.msg||"保存失败",icon:"none"}),void(this.submitting=!1)}e({title:"瓶号未建档",content:`瓶号 ${s} 在瓶子档案中不存在。\n是否根据本次灌装皮重 ${a}kg 自动创建瓶子并保存灌装记录？`,cancelText:"只保存灌装",confirmText:"创建并保存",success:async e=>{if(e.confirm){try{const e=await F("crm-bottle",{action:"quickCreate",data:{number:s,tare_weight:a,remark:"由灌装页面自动建档"}});if(!e||401===e.code)return;if(0!==e.code)return t({title:e.msg||"建档失败",icon:"none"}),void(this.submitting=!1)}catch(i){return console.error("quickCreate from filling error",i),t({title:"建档失败",icon:"none"}),void(this.submitting=!1)}const e=await this.doCreateFilling(a,l);0===e.code?(t({title:"已建档并保存",icon:"success"}),this.resetForm(),this.fetchAll()):t({title:e.msg||"保存失败",icon:"none"})}else if(e.cancel){const e=await this.doCreateFilling(a,l);0===e.code?(t({title:"已保存",icon:"success"}),this.resetForm(),this.fetchAll()):t({title:e.msg||"保存失败",icon:"none"})}this.submitting=!1},fail:()=>{this.submitting=!1}})}catch(i){console.error("submitForm exception:",i),t({title:"请求出错",icon:"none"}),this.submitting=!1}},async submitEdit(){if(!this.editingId)return void t({title:"无效的编辑记录",icon:"none"});const e=(this.form.bottle_no||"").trim();if(!e)return void t({title:"瓶号不能为空",icon:"none"});const a=Number(this.form.tare_fill),l=Number(this.form.gross_fill);if(isNaN(a)||isNaN(l))return void t({title:"请正确填写皮重和毛重",icon:"none"});if(l<=a)return void t({title:"毛重要大于皮重",icon:"none"});const s=this.form.date||this.todayStr(),i=l-a;this.submitting=!0;try{const o=await this.callFilling("update",{id:this.editingId,bottle_no:e,date:s,tare_fill:a,gross_fill:l,net_fill:i,operator:this.form.operator||"",remark:this.form.remark||""});o&&0===o.code?(t({title:"修改已保存",icon:"success"}),this.exitEditMode(),this.fetchAll()):o&&401!==o.code&&t({title:o.msg||"保存失败",icon:"none"})}catch(o){console.error("submitEdit exception:",o),t({title:"请求出错",icon:"none"})}finally{this.submitting=!1}},async doCreateFilling(t,e){const a=e-t;return await this.callFilling("create",{bottle_no:this.form.bottle_no,date:this.form.date||this.todayStr(),tare_fill:t,gross_fill:e,net_fill:a,operator:this.form.operator||this.userInfo&&this.userInfo.username||"",remark:this.form.remark||""})||{}},async confirmDelete(a){a&&a._id&&e({title:"删除灌装记录",content:"确定要删除这条灌装记录吗？删除后不可恢复。",confirmText:"删除",confirmColor:"#d9534f",success:async e=>{if(!e.confirm)return;const l=await this.callFilling("remove",{id:a._id});l&&0===l.code?(t({title:"已删除",icon:"success"}),this.fetchList()):l&&401!==l.code&&t({title:l.msg||"删除失败",icon:"none"})}})},resetForm(){this.form={bottle_no:"",date:this.todayStr(),tare_fill:"",gross_fill:"",operator:this.userInfo&&this.userInfo.real_name||this.userInfo&&this.userInfo.username||"",remark:""},this.bottleSuggestions=[],this.bottleExists=null,this.lastBottleInfo=null,this.syncOperatorPicker()},async exportFilling(){if(this.dateRange.start&&this.dateRange.end)try{const e=await this.callFilling("export",{start_date:this.dateRange.start,end_date:this.dateRange.end});if(!e||401===e.code)return;const a=e.data||[];if(!a.length)return void t({title:"当前时间段无数据",icon:"none"});const l=["日期","瓶号","灌装前皮重(kg)","灌装后毛重(kg)","灌装净重(kg)","操作员","备注","铭牌皮重(kg)","上次客户","上次出瓶日期","上次回瓶日期","上次回瓶毛重(kg)","上次回瓶净重(kg)","上次回瓶差值(kg)","本次皮重-上次回瓶毛重(kg)","本次皮重-铭牌皮重(kg)"],s=a.map((t=>[t.date||"",t.bottle_no||"",null!=t.tare_fill?t.tare_fill:"",null!=t.gross_fill?t.gross_fill:"",null!=t.net_fill?t.net_fill:"",t.operator||"",(t.remark||"").replace(/\r?\n/g," "),null!=t.tare_weight?t.tare_weight:"",t.last_customer_name||"",t.last_out_date||"",t.last_back_date||"",null!=t.last_gross_weight?t.last_gross_weight:"",null!=t.last_net_weight?t.last_net_weight:"",null!=t.last_return_diff?t.last_return_diff:"",null!=t.diff_tare_vs_last_gross?t.diff_tare_vs_last_gross:"",null!=t.diff_tare_vs_tare_weight?t.diff_tare_vs_tare_weight:""].map((t=>{const e=String(t);return-1!==e.indexOf(",")||-1!==e.indexOf('"')?'"'+e.replace(/"/g,'""')+'"':e})).join(","))),i=[l.join(","),...s].join("\n"),o=`灌装记录导出_${this.dateRange.start}_${this.dateRange.end}.csv`,r=new Blob([i],{type:"text/csv;charset=utf-8;"}),n=window.URL.createObjectURL(r),d=document.createElement("a");d.href=n,d.download=o,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(n),t({title:"导出成功",icon:"success"})}catch(e){console.error("exportFilling exception:",e),t({title:"导出失败",icon:"none"})}else t({title:"请先选择导出时间范围",icon:"none"})}}},[["render",function(t,e,k,S,v,B){const R=a("BackToDashboardBar"),F=g,x=i,I=_,N=b,C=p,L=y;return o(),l(x,{class:"filling-page"},{default:s((()=>[r(x,{class:"filling-inner"},{default:s((()=>[r(R,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),r(x,{class:"page-header"},{default:s((()=>[r(x,{class:"page-header-left"},{default:s((()=>[r(x,{class:"page-icon"},{default:s((()=>[r(F,{class:"page-icon-text"},{default:s((()=>[n("灌")])),_:1})])),_:1}),r(x,{class:"page-header-text"},{default:s((()=>[r(F,{class:"page-title"},{default:s((()=>[n("灌装管理")])),_:1}),r(F,{class:"page-sub"},{default:s((()=>[n(" 记录站上每一瓶的灌装数据，对比进站、销售，追踪气量损耗 ")])),_:1})])),_:1})])),_:1})])),_:1}),r(x,{class:"card card-summary"},{default:s((()=>[r(x,{class:"filter-row"},{default:s((()=>[r(x,{class:"filter-tabs"},{default:s((()=>[r(x,{class:d(["filter-tab",{active:"today"===v.filterPreset}]),onClick:e[0]||(e[0]=t=>B.changePreset("today"))},{default:s((()=>[n(" 今日 ")])),_:1},8,["class"]),r(x,{class:d(["filter-tab",{active:"week"===v.filterPreset}]),onClick:e[1]||(e[1]=t=>B.changePreset("week"))},{default:s((()=>[n(" 本周 ")])),_:1},8,["class"]),r(x,{class:d(["filter-tab",{active:"month"===v.filterPreset}]),onClick:e[2]||(e[2]=t=>B.changePreset("month"))},{default:s((()=>[n(" 本月 ")])),_:1},8,["class"]),r(x,{class:d(["filter-tab",{active:"custom"===v.filterPreset}]),onClick:e[3]||(e[3]=t=>B.changePreset("custom"))},{default:s((()=>[n(" 自定义 ")])),_:1},8,["class"])])),_:1}),"custom"===v.filterPreset?(o(),l(x,{key:0,class:"filter-dates"},{default:s((()=>[r(I,{mode:"date",value:v.dateRange.start,onChange:e[4]||(e[4]=t=>B.onDateChange(t,"start"))},{default:s((()=>[r(x,{class:"date-input"},{default:s((()=>[r(F,{class:"date-label"},{default:s((()=>[n("开始")])),_:1}),r(F,{class:"date-value"},{default:s((()=>[n(c(v.dateRange.start||"选择日期"),1)])),_:1})])),_:1})])),_:1},8,["value"]),r(F,{class:"date-sep"},{default:s((()=>[n("-")])),_:1}),r(I,{mode:"date",value:v.dateRange.end,onChange:e[5]||(e[5]=t=>B.onDateChange(t,"end"))},{default:s((()=>[r(x,{class:"date-input"},{default:s((()=>[r(F,{class:"date-label"},{default:s((()=>[n("结束")])),_:1}),r(F,{class:"date-value"},{default:s((()=>[n(c(v.dateRange.end||"选择日期"),1)])),_:1})])),_:1})])),_:1},8,["value"])])),_:1})):u("",!0),r(x,{class:"bottle-filter"},{default:s((()=>[r(F,{class:"bottle-filter-label"},{default:s((()=>[n("瓶号筛选")])),_:1}),r(N,{class:"bottle-filter-input",placeholder:"输入瓶号，支持模糊匹配",modelValue:v.bottleFilter,"onUpdate:modelValue":e[6]||(e[6]=t=>v.bottleFilter=t),modelModifiers:{trim:!0},onConfirm:e[7]||(e[7]=t=>B.fetchList(!0))},null,8,["modelValue"]),r(C,{class:"btn-soft",size:"mini",onClick:e[8]||(e[8]=t=>B.fetchList(!0))},{default:s((()=>[n("筛选")])),_:1}),v.bottleFilter?(o(),l(C,{key:0,class:"btn-link",size:"mini",onClick:B.clearBottleFilter},{default:s((()=>[n(" 清空 ")])),_:1},8,["onClick"])):u("",!0)])),_:1})])),_:1}),v.loadingSummary?(o(),l(x,{key:1,class:"summary-row loading"},{default:s((()=>[r(F,{class:"loading-text"},{default:s((()=>[n("正在统计灌装与损耗数据...")])),_:1})])),_:1})):(o(),l(x,{key:0,class:"summary-row"},{default:s((()=>[r(x,{class:"summary-card"},{default:s((()=>[r(x,{class:"summary-label"},{default:s((()=>[n("进站总量")])),_:1}),r(x,{class:"summary-value-row"},{default:s((()=>[r(F,{class:"summary-value"},{default:s((()=>[n(c(B.formatKg(v.summary.inbound_total)),1)])),_:1}),r(F,{class:"summary-unit"},{default:s((()=>[n("kg")])),_:1})])),_:1}),r(F,{class:"summary-tip"},{default:s((()=>[n("期间所有入库天然气净重合计")])),_:1})])),_:1}),r(x,{class:"summary-card"},{default:s((()=>[r(x,{class:"summary-label"},{default:s((()=>[n("灌装总量")])),_:1}),r(x,{class:"summary-value-row"},{default:s((()=>[r(F,{class:"summary-value"},{default:s((()=>[n(c(B.formatKg(v.summary.fill_total)),1)])),_:1}),r(F,{class:"summary-unit"},{default:s((()=>[n("kg")])),_:1})])),_:1}),r(F,{class:"summary-tip"},{default:s((()=>[n("所有灌装记录净重合计")])),_:1})])),_:1}),r(x,{class:"summary-card"},{default:s((()=>[r(x,{class:"summary-label"},{default:s((()=>[n("销售出站总量")])),_:1}),r(x,{class:"summary-value-row"},{default:s((()=>[r(F,{class:"summary-value"},{default:s((()=>[n(c(B.formatKg(v.summary.sale_total)),1)])),_:1}),r(F,{class:"summary-unit"},{default:s((()=>[n("kg")])),_:1})])),_:1}),r(F,{class:"summary-tip"},{default:s((()=>[n("对应期间销售出瓶净重合计")])),_:1})])),_:1})])),_:1})),v.loadingSummary?u("",!0):(o(),l(x,{key:2,class:"diff-row"},{default:s((()=>[r(x,{class:"diff-item"},{default:s((()=>[r(F,{class:"diff-label"},{default:s((()=>[n("进站 → 灌装 差值")])),_:1}),r(F,{class:d(["diff-value",{danger:Math.abs(B.diffInboundFillRaw)>v.diffThreshold}])},{default:s((()=>[n(c(B.formatKg(B.diffInboundFillRaw))+" kg ",1)])),_:1},8,["class"])])),_:1}),r(x,{class:"diff-item"},{default:s((()=>[r(F,{class:"diff-label"},{default:s((()=>[n("灌装 → 销售 差值")])),_:1}),r(F,{class:d(["diff-value",{danger:Math.abs(B.diffFillSaleRaw)>v.diffThreshold}])},{default:s((()=>[n(c(B.formatKg(B.diffFillSaleRaw))+" kg ",1)])),_:1},8,["class"])])),_:1}),r(x,{class:"diff-item"},{default:s((()=>[r(F,{class:"diff-label"},{default:s((()=>[n("进站 → 销售 总差值")])),_:1}),r(F,{class:d(["diff-value",{danger:Math.abs(B.diffInboundSaleRaw)>v.diffThreshold}])},{default:s((()=>[n(c(B.formatKg(B.diffInboundSaleRaw))+" kg ",1)])),_:1},8,["class"])])),_:1})])),_:1})),v.loadingSummary?u("",!0):(o(),l(x,{key:3,class:"loss-row"},{default:s((()=>[r(x,{class:"loss-item"},{default:s((()=>[r(F,{class:"loss-label"},{default:s((()=>[n("装车 → 进站 亏损")])),_:1}),r(F,{class:"loss-value"},{default:s((()=>[n(c(B.formatKg(B.loadToInboundLossRaw))+" kg",1)])),_:1})])),_:1}),r(x,{class:"loss-item"},{default:s((()=>[r(F,{class:"loss-label"},{default:s((()=>[n("进站 → 灌装 亏损")])),_:1}),r(F,{class:"loss-value"},{default:s((()=>[n(c(B.formatKg(B.diffInboundFillRaw))+" kg",1)])),_:1})])),_:1}),r(x,{class:"loss-item"},{default:s((()=>[r(F,{class:"loss-label"},{default:s((()=>[n("灌装 → 销售 亏损")])),_:1}),r(F,{class:"loss-value"},{default:s((()=>[n(c(B.formatKg(B.diffFillSaleRaw))+" kg",1)])),_:1})])),_:1}),r(x,{class:"loss-item"},{default:s((()=>[r(F,{class:"loss-label"},{default:s((()=>[n("月末库存（估算）")])),_:1}),r(F,{class:"loss-value"},{default:s((()=>[n(c(B.formatKg(B.inventoryEstimateRaw))+" kg",1)])),_:1})])),_:1})])),_:1}))])),_:1}),r(x,{class:"layout-main"},{default:s((()=>[r(x,{class:"col-left"},{default:s((()=>[r(x,{class:d(["card",{"card-disabled":!v.isAdmin}])},{default:s((()=>[r(x,{class:"card-header"},{default:s((()=>[r(F,{class:"card-title"},{default:s((()=>[n(c(v.isEditing?"编辑灌装记录":"新增灌装记录"),1)])),_:1}),v.isAdmin?u("",!0):(o(),l(F,{key:0,style:{color:"#d9534f","font-size":"24rpx","margin-top":"4rpx"}},{default:s((()=>[n(" （仅管理员可录入） ")])),_:1})),v.isAdmin&&v.isEditing?(o(),l(F,{key:1,style:{color:"#6b7280","font-size":"22rpx","margin-top":"4rpx"}},{default:s((()=>[n(" 正在编辑，修改后点击下方“提交灌装记录”保存 ")])),_:1})):u("",!0)])),_:1}),r(x,{class:"form-body"},{default:s((()=>[r(x,{class:"form-row"},{default:s((()=>[r(F,{class:"form-label"},{default:s((()=>[n("灌装日期")])),_:1}),r(I,{mode:"date",value:v.form.date,onChange:e[9]||(e[9]=t=>v.form.date=t.detail.value)},{default:s((()=>[r(x,{class:"picker-display"},{default:s((()=>[r(F,null,{default:s((()=>[n(c(v.form.date||"选择日期"),1)])),_:1})])),_:1})])),_:1},8,["value"])])),_:1}),r(x,{class:"form-row"},{default:s((()=>[r(F,{class:"form-label"},{default:s((()=>[n("瓶号")])),_:1}),r(x,{class:"input-with-suggest"},{default:s((()=>[r(N,{class:"form-input",disabled:!v.isAdmin,modelValue:v.form.bottle_no,"onUpdate:modelValue":e[10]||(e[10]=t=>v.form.bottle_no=t),modelModifiers:{trim:!0},placeholder:"请输入瓶号，如 217，支持模糊搜索",onInput:B.onBottleInput,onBlur:B.onBottleBlur},null,8,["disabled","modelValue","onInput","onBlur"]),v.isAdmin&&v.bottleSuggestions&&v.bottleSuggestions.length?(o(),l(x,{key:0,class:"bottle-suggest"},{default:s((()=>[(o(!0),f(h,null,m(v.bottleSuggestions,(t=>(o(),l(x,{key:t._id||t.number,class:"suggest-item",onClick:w((e=>B.onSelectBottle(t)),["stop"])},{default:s((()=>[r(F,{class:"suggest-no"},{default:s((()=>[n(c(t.number),1)])),_:2},1024),r(F,{class:"suggest-sub"},{default:s((()=>[n(" 皮重 "+c(null!=t.tare_weight?t.tare_weight:"-")+"kg · "+c(B.bottleStatusText(t.status)),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):u("",!0)])),_:1})])),_:1}),v.lastBottleInfo?(o(),l(x,{key:0,class:"last-bottle-info"},{default:s((()=>[r(F,{class:"last-info-text"},{default:s((()=>[n(" 上次客户："+c(v.lastBottleInfo.last_customer_name||"—")+"； 上次回瓶净重： "+c(null!=B.effectiveLastBackNet?B.formatKg(B.effectiveLastBackNet):"-")+"kg； 本次灌装皮重参考： "+c(null!=v.lastBottleInfo.last_gross_weight?B.formatKg(v.lastBottleInfo.last_gross_weight):"-")+"kg； 瓶子铭牌皮重： "+c(null!=v.lastBottleInfo.tare_weight?B.formatKg(v.lastBottleInfo.tare_weight):"-")+"kg ",1)])),_:1}),B.showTareWarning?(o(),l(x,{key:0,style:{color:"#d9534f","font-size":"26rpx","margin-top":"4rpx"}},{default:s((()=>[n(" ⚠ 与铭牌皮重差异较大，请核实瓶子是否称重异常 ")])),_:1})):u("",!0)])),_:1})):u("",!0),r(x,{class:"form-row"},{default:s((()=>[r(F,{class:"form-label"},{default:s((()=>[n("灌装后毛重 (kg)")])),_:1}),r(N,{class:"form-input",disabled:!v.isAdmin,modelValue:v.form.gross_fill,"onUpdate:modelValue":e[11]||(e[11]=t=>v.form.gross_fill=t),type:"digit",placeholder:"灌装后称的毛重"},null,8,["disabled","modelValue"])])),_:1}),r(x,{class:"form-row"},{default:s((()=>[r(F,{class:"form-label"},{default:s((()=>[n("灌装前皮重 (kg)")])),_:1}),r(N,{class:"form-input",disabled:!v.isAdmin,modelValue:v.form.tare_fill,"onUpdate:modelValue":e[12]||(e[12]=t=>v.form.tare_fill=t),type:"digit",placeholder:"站上称的空瓶重量"},null,8,["disabled","modelValue"])])),_:1}),r(x,{class:"form-row"},{default:s((()=>[r(F,{class:"form-label"},{default:s((()=>[n("灌装净重 (kg)")])),_:1}),r(x,{class:"form-static"},{default:s((()=>[r(F,{class:d({"net-value":!0,danger:B.netFillRaw<=0})},{default:s((()=>[n(c(B.netFillText),1)])),_:1},8,["class"]),B.netFillRaw<=0?(o(),l(F,{key:0,class:"form-hint"},{default:s((()=>[n(" 净重≤0，请检查皮重/毛重是否录反 ")])),_:1})):u("",!0)])),_:1})])),_:1}),r(x,{class:"form-row operator-row"},{default:s((()=>[r(F,{class:"form-label"},{default:s((()=>[n("操作员")])),_:1}),r(x,{class:"operator-autocomplete"},{default:s((()=>[r(N,{class:"form-input",disabled:!v.isAdmin,modelValue:v.form.operator,"onUpdate:modelValue":e[13]||(e[13]=t=>v.form.operator=t),modelModifiers:{trim:!0},placeholder:"输入并选择配送员",onInput:B.onOperatorInput,onFocus:B.onOperatorFocus,onBlur:B.onOperatorBlur},null,8,["disabled","modelValue","onInput","onFocus","onBlur"]),v.showOperatorDropdown?(o(),l(x,{key:0,class:"operator-suggestions"},{default:s((()=>[(o(!0),f(h,null,m(v.operatorSuggestions,(t=>(o(),l(x,{key:t._id||t.display,class:"suggestion-item",onClick:e=>B.selectOperator(t)},{default:s((()=>[n(c(t.display),1)])),_:2},1032,["onClick"])))),128)),v.operatorSuggestions.length?u("",!0):(o(),l(x,{key:0,class:"suggestion-empty"},{default:s((()=>[n(" 未找到匹配的配送员 ")])),_:1}))])),_:1})):u("",!0)])),_:1})])),_:1}),r(x,{class:"form-row"},{default:s((()=>[r(F,{class:"form-label"},{default:s((()=>[n("备注")])),_:1}),r(L,{class:"form-textarea",disabled:!v.isAdmin,modelValue:v.form.remark,"onUpdate:modelValue":e[14]||(e[14]=t=>v.form.remark=t),modelModifiers:{trim:!0},"auto-height":"",placeholder:"可记录本次灌装的特殊情况、批次等信息"},null,8,["disabled","modelValue"])])),_:1}),r(x,{class:"form-actions"},{default:s((()=>[r(C,{class:"btn-primary",loading:v.submitting,disabled:!v.isAdmin,onClick:B.onSubmitClick},{default:s((()=>[n(" 提交灌装记录 ")])),_:1},8,["loading","disabled","onClick"]),v.isAdmin&&v.isEditing?(o(),l(C,{key:0,class:"btn-secondary",style:{"margin-left":"12rpx"},onClick:B.exitEditMode},{default:s((()=>[n(" 取消编辑 ")])),_:1},8,["onClick"])):u("",!0)])),_:1})])),_:1})])),_:1},8,["class"])])),_:1}),r(x,{class:"col-right"},{default:s((()=>[r(x,{class:"card"},{default:s((()=>[r(x,{class:"card-header card-header-with-actions"},{default:s((()=>[r(x,{class:"card-header-main"},{default:s((()=>[r(F,{class:"card-title"},{default:s((()=>[n("灌装记录")])),_:1}),r(F,{class:"card-sub"},{default:s((()=>[n(" 显示当前时间段内的灌装记录，默认按时间倒序 ")])),_:1})])),_:1}),r(C,{class:"btn-secondary btn-export",onClick:B.exportFilling},{default:s((()=>[n(" 导出 ")])),_:1},8,["onClick"])])),_:1}),v.loadingList?(o(),l(x,{key:0,class:"list-empty"},{default:s((()=>[r(F,{class:"empty-text"},{default:s((()=>[n("正在加载灌装记录...")])),_:1})])),_:1})):v.fillingList.length?(o(),l(x,{key:2,class:"filling-list"},{default:s((()=>[r(x,{class:"list-header"},{default:s((()=>[r(F,{class:"col-time"},{default:s((()=>[n("日期")])),_:1}),r(F,{class:"col-bottle"},{default:s((()=>[n("瓶号")])),_:1}),r(F,{class:"col-num"},{default:s((()=>[n("皮重")])),_:1}),r(F,{class:"col-num"},{default:s((()=>[n("毛重")])),_:1}),r(F,{class:"col-num"},{default:s((()=>[n("净重")])),_:1}),r(F,{class:"col-operator"},{default:s((()=>[n("操作员")])),_:1}),v.isAdmin?(o(),l(F,{key:0,class:"col-operator"},{default:s((()=>[n("操作")])),_:1})):u("",!0)])),_:1}),(o(!0),f(h,null,m(v.fillingList,(t=>(o(),l(x,{key:t._id,class:"list-row"},{default:s((()=>[r(F,{class:"col-time"},{default:s((()=>[n(c(t.date||"--"),1)])),_:2},1024),r(F,{class:"col-bottle"},{default:s((()=>[n(c(t.bottle_no||"--"),1)])),_:2},1024),r(F,{class:"col-num"},{default:s((()=>[n(c(B.formatKg(t.tare_fill)),1)])),_:2},1024),r(F,{class:"col-num"},{default:s((()=>[n(c(B.formatKg(t.gross_fill)),1)])),_:2},1024),r(F,{class:"col-num"},{default:s((()=>[n(c(B.formatKg(t.net_fill)),1)])),_:2},1024),r(F,{class:"col-operator"},{default:s((()=>[n(c(t.operator||"-"),1)])),_:2},1024),v.isAdmin?(o(),l(x,{key:0,class:"edit-btn-cell"},{default:s((()=>[r(C,{class:"btn-edit",onClick:e=>B.startEdit(t)},{default:s((()=>[n("编辑")])),_:2},1032,["onClick"]),r(C,{class:"btn-danger",onClick:e=>B.confirmDelete(t)},{default:s((()=>[n("删除")])),_:2},1032,["onClick"])])),_:2},1024)):u("",!0)])),_:2},1024)))),128))])),_:1})):(o(),l(x,{key:1,class:"list-empty"},{default:s((()=>[r(F,{class:"empty-text"},{default:s((()=>[n(" 当前时间段内暂无灌装记录。 ")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-ee8550e9"]]);export{x as default};
