import{s as e,a as t,t as a,h as l,C as s,u as i,r as n,c as r,w as o,i as c,o as d,d as u,e as m,f,g as p,j as _,I as h,D as g,z as v,E as k}from"./index-B6DdPhlT.js";import{_ as V,e as b,f as x}from"./_plugin-vue_export-helper.Dda_PF8M.js";const U=V({data:()=>({isEdit:!1,id:"",saving:!1,form:{name:"",short_name:"",contact:"",phone:"",address:"",default_unit_price:"",default_price_unit:"kg",remark:"",is_active:!0},priceUnitOptions:["按公斤计价","按瓶计价","按立方米计价"],priceUnitValues:["kg","bottle","m3"],priceUnitIndex:0}),computed:{priceUnitLabel(){return this.priceUnitOptions[this.priceUnitIndex]}},onLoad(e){b()&&e&&e.id&&(this.isEdit=!0,this.id=e.id,this.loadDetail())},methods:{getToken(){const t=x();return t||(e({title:"登录已过期，请重新登录",icon:"none"}),b(),"")},async loadDetail(){const s=this.getToken();if(s)try{t({title:"加载中…",mask:!0});const i=(await a.callFunction({name:"crm-customer",data:{action:"get",token:s,data:{id:this.id}}})).result||{};if(401===i.code)return e({title:i.msg||"登录已过期，请重新登录",icon:"none"}),void b();if(0!==i.code)return void e({title:i.msg||"加载失败",icon:"none"});const n=i.data||{};this.form={name:n.name||"",short_name:n.short_name||"",contact:n.contact||"",phone:null!=n.phone?String(n.phone):"",address:n.address||"",default_unit_price:null!=n.default_unit_price?String(n.default_unit_price):"",default_price_unit:n.default_price_unit||"kg",remark:n.remark||"",is_active:"boolean"!=typeof n.is_active||n.is_active};const r=this.priceUnitValues.indexOf(this.form.default_price_unit);this.priceUnitIndex=r>=0?r:0}catch(i){console.error("crm-customer get error:",i),e({title:"加载失败，请稍后重试",icon:"none"})}finally{l()}},onPriceUnitChange(e){const t=Number(e.detail.value||0);this.priceUnitIndex=t,this.form.default_price_unit=this.priceUnitValues[t]},onActiveChange(e){this.form.is_active=!!e.detail.value},onPhoneInput(e){let t=(e.detail.value||"").replace(/[^\d-]/g,"");t=t.replace(/-+/g,"-"),t.length>20&&(t=t.slice(0,20)),this.form.phone=t},normalizeAndValidatePhone(){const e=String(this.form.phone||"").trim();if(!e)return"";const t=e.replace(/\s+/g,""),a=t.replace(/\D/g,""),l=/^1[3-9]\d{9}$/.test(a),s=t.match(/^(\d{3,4})-?(\d{5,8})$/);return l||!!s?l?a:`${s[1]}-${s[2]}`:null},async handleSave(){if(this.saving)return;const t=(this.form.name||"").trim();if(!t)return e({title:"请填写客户名称",icon:"none"});const l=this.normalizeAndValidatePhone();if(null===l)return e({title:"联系电话格式不正确，请检查",icon:"none"});const s=this.getToken();if(!s)return;let i=null;if(""!==this.form.default_unit_price){const e=Number(this.form.default_unit_price);isNaN(e)||(i=e)}const n={name:t,short_name:(this.form.short_name||"").trim(),contact:(this.form.contact||"").trim(),phone:l,address:(this.form.address||"").trim(),default_unit_price:i,default_price_unit:this.form.default_price_unit||"kg",remark:(this.form.remark||"").trim(),is_active:!!this.form.is_active};this.isEdit&&(n.id=this.id),this.saving=!0;try{const t=this.isEdit?"update":"create",l=(await a.callFunction({name:"crm-customer",data:{action:t,token:s,data:n}})).result||{};if(401===l.code)return e({title:l.msg||"登录已过期，请重新登录",icon:"none"}),void b();if(0!==l.code)return void e({title:l.msg||"保存失败",icon:"none"});e({title:"保存成功",icon:"success"}),setTimeout((()=>{this.goBack()}),500)}catch(r){console.error("crm-customer save error:",r),e({title:"保存失败，请稍后重试",icon:"none"})}finally{this.saving=!1}},goBack(){s().length>1?i():n({url:"/pages/customer/list"})}}},[["render",function(e,t,a,l,s,i){const n=p,V=c,b=_,x=h,U=g,C=v,w=k;return d(),r(V,{class:"page"},{default:o((()=>[u(V,{class:"inner"},{default:o((()=>[u(V,{class:"page-header"},{default:o((()=>[u(V,{class:"page-header-left"},{default:o((()=>[u(V,{class:"page-icon"},{default:o((()=>[u(n,{class:"page-icon-text"},{default:o((()=>[m("客")])),_:1})])),_:1}),u(V,{class:"page-header-text"},{default:o((()=>[u(n,{class:"page-title"},{default:o((()=>[m(f(s.isEdit?"编辑客户":"新增客户"),1)])),_:1}),u(n,{class:"page-sub"},{default:o((()=>[m(" 维护客户名称、地址、默认单价与计价方式 ")])),_:1})])),_:1})])),_:1}),u(V,{class:"page-header-right"},{default:o((()=>[u(b,{class:"btn-soft",onClick:i.goBack},{default:o((()=>[m("返回")])),_:1},8,["onClick"])])),_:1})])),_:1}),u(V,{class:"card"},{default:o((()=>[u(V,{class:"form-item"},{default:o((()=>[u(n,{class:"label"},{default:o((()=>[m("客户名称")])),_:1}),u(V,{class:"input-wrapper"},{default:o((()=>[u(x,{class:"input",modelValue:s.form.name,"onUpdate:modelValue":t[0]||(t[0]=e=>s.form.name=e),placeholder:"请输入客户全名（对账单显示用）",maxlength:"50"},null,8,["modelValue"])])),_:1})])),_:1}),u(V,{class:"form-item"},{default:o((()=>[u(n,{class:"label"},{default:o((()=>[m("简称（选填）")])),_:1}),u(V,{class:"input-wrapper"},{default:o((()=>[u(x,{class:"input",modelValue:s.form.short_name,"onUpdate:modelValue":t[1]||(t[1]=e=>s.form.short_name=e),placeholder:"例如：新拓 A 栋，可选",maxlength:"30"},null,8,["modelValue"])])),_:1})])),_:1}),u(V,{class:"form-item"},{default:o((()=>[u(n,{class:"label"},{default:o((()=>[m("联系人（选填）")])),_:1}),u(V,{class:"input-wrapper"},{default:o((()=>[u(x,{class:"input",modelValue:s.form.contact,"onUpdate:modelValue":t[2]||(t[2]=e=>s.form.contact=e),placeholder:"联系人姓名，可选",maxlength:"20"},null,8,["modelValue"])])),_:1})])),_:1}),u(V,{class:"form-item"},{default:o((()=>[u(n,{class:"label"},{default:o((()=>[m("联系电话（选填）")])),_:1}),u(V,{class:"input-wrapper"},{default:o((()=>[u(x,{class:"input",value:s.form.phone,placeholder:"手机或座机，可选",maxlength:"20",type:"text",onInput:i.onPhoneInput},null,8,["value","onInput"])])),_:1})])),_:1}),u(V,{class:"form-item"},{default:o((()=>[u(n,{class:"label"},{default:o((()=>[m("地址（选填）")])),_:1}),u(V,{class:"textarea-wrapper"},{default:o((()=>[u(U,{class:"textarea",modelValue:s.form.address,"onUpdate:modelValue":t[3]||(t[3]=e=>s.form.address=e),placeholder:"详细送气地址，可选","auto-height":""},null,8,["modelValue"])])),_:1})])),_:1}),u(V,{class:"form-row"},{default:o((()=>[u(V,{class:"form-item half"},{default:o((()=>[u(n,{class:"label"},{default:o((()=>[m("默认单价")])),_:1}),u(V,{class:"input-wrapper"},{default:o((()=>[u(x,{class:"input",modelValue:s.form.default_unit_price,"onUpdate:modelValue":t[4]||(t[4]=e=>s.form.default_unit_price=e),placeholder:"例如：6.8",type:"digit"},null,8,["modelValue"])])),_:1})])),_:1}),u(V,{class:"form-item half"},{default:o((()=>[u(n,{class:"label"},{default:o((()=>[m("计价方式")])),_:1}),u(C,{mode:"selector",range:s.priceUnitOptions,value:s.priceUnitIndex,onChange:i.onPriceUnitChange},{default:o((()=>[u(V,{class:"input-wrapper picker-wrapper"},{default:o((()=>[u(V,{class:"picker"},{default:o((()=>[u(n,null,{default:o((()=>[m(f(i.priceUnitLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1}),u(V,{class:"form-item status-item"},{default:o((()=>[u(n,{class:"label"},{default:o((()=>[m("状态")])),_:1}),u(V,{class:"status-right"},{default:o((()=>[u(n,{class:"status-text"},{default:o((()=>[m(f(s.form.is_active?"启用中（正常往来）":"停用（暂不往来）"),1)])),_:1}),u(w,{checked:s.form.is_active,onChange:i.onActiveChange},null,8,["checked","onChange"])])),_:1})])),_:1}),u(V,{class:"form-item"},{default:o((()=>[u(n,{class:"label"},{default:o((()=>[m("备注")])),_:1}),u(V,{class:"textarea-wrapper"},{default:o((()=>[u(U,{class:"textarea",modelValue:s.form.remark,"onUpdate:modelValue":t[5]||(t[5]=e=>s.form.remark=e),placeholder:"可填写结算方式、特殊价格约定等","auto-height":""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),u(V,{class:"bottom-actions"},{default:o((()=>[u(b,{class:"btn-soft",onClick:i.goBack},{default:o((()=>[m("取消")])),_:1},8,["onClick"]),u(b,{class:"btn-primary",onClick:i.handleSave,disabled:s.saving},{default:o((()=>[m(f(s.saving?"保存中…":"保存"),1)])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-a244f57d"]]);export{U as default};
