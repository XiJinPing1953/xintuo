import{A as e,s as t,t as s,n as a,l as i,v as l,c as o,w as n,i as c,o as r,d,e as u,q as g,x as f,y as h,F as m,p as _,g as k,j as p,I as y,f as w,B as v}from"./index-B6DdPhlT.js";import{B as C}from"./BackToDashboardBar.0jhbkRhX.js";import{_ as b,i as A,g as L,e as S,f as T,h as B,j as I}from"./_plugin-vue_export-helper.Dda_PF8M.js";const x=b({components:{BackToDashboardBar:C},data:()=>({keyword:"",filterActive:"all",customers:[],loading:!1,finished:!1,page:1,pageSize:30,suggestions:[],suggestTimer:null,suggestLoading:!1,userInfo:{}}),computed:{isAdmin(){return A(this.userInfo)}},onLoad(){this.userInfo=L()||{},S()&&this.fetchList(!0)},onShow(){this.userInfo=L()||{},S()&&this.fetchList(!0)},onPullDownRefresh(){this.fetchList(!0).finally((()=>{e()}))},onReachBottom(){this.loadMore()},methods:{getValidToken(){const e=T(),s=B();return!e||I(s)?(t({title:"登录已过期，请重新登录",icon:"none"}),S(),""):e},async fetchList(e=!1){if(!this.loading&&(e&&(this.page=1,this.customers=[],this.finished=!1),!this.finished)){this.loading=!0;try{const a=this.getValidToken(),i=(await s.callFunction({name:"crm-customer",data:{action:"list",token:a,data:{keyword:this.keyword,is_active:"all"===this.filterActive?void 0:"active"===this.filterActive,page:this.page,pageSize:this.pageSize}}})).result||{};if(401===i.code)return S();if(0!==i.code)return void t({title:i.msg||"加载失败",icon:"none"});const l=i.data||[];this.customers=e?l:this.customers.concat(l),l.length<this.pageSize?this.finished=!0:this.page+=1}catch(a){console.error("加载客户列表异常",a),t({title:"请求出错",icon:"none"})}finally{this.loading=!1}}},onSearch(){this.fetchList(!0)},onKeywordInput(e){this.keyword=e.detail.value,this.suggestTimer&&clearTimeout(this.suggestTimer),this.suggestTimer=setTimeout((()=>{this.fetchSuggest()}),200)},clearKeyword(){this.keyword="",this.suggestions=[],this.fetchList(!0)},onSelectSuggestion(e){this.keyword=e.name||"",this.suggestions=[],this.fetchList(!0)},async fetchSuggest(){const e=(this.keyword||"").trim();if(!e)return void(this.suggestions=[]);const t=this.getValidToken();if(t){this.suggestLoading=!0;try{const a=(await s.callFunction({name:"crm-customer",data:{action:"suggest",token:t,data:{keyword:e,limit:15}}})).result||{};0===a.code&&(this.suggestions=a.data||[])}catch(a){console.error("fetchSuggest error",a)}finally{this.suggestLoading=!1}}},onFilterChange(e){this.filterActive!==e&&(this.filterActive=e,this.fetchList(!0))},getPriceUnitLabel:e=>"bottle"===e?"瓶":"m3"===e?"m³":"kg",loadMore(){this.fetchList(!1)},onRowClick(e){this.isAdmin&&this.goEdit(e)},goCreate(){if(!this.isAdmin)return t({title:"当前账号无权限新增客户",icon:"none"});a({url:"/pages/customer/edit"})},goEdit(e){if(!this.isAdmin)return t({title:"当前账号无权限编辑客户",icon:"none"});a({url:"/pages/customer/edit?id="+e._id})},async onRemove(e){if(!this.isAdmin)return t({title:"当前账号无权限删除客户",icon:"none"});i({title:"确认删除",content:`确定要删除客户「${e.name||""}」吗？\n删除后不可恢复，请谨慎操作。`,success:async a=>{if(a.confirm)try{const a=this.getValidToken(),i=(await s.callFunction({name:"crm-customer",data:{action:"remove",token:a,data:{id:e._id}}})).result||{};if(0!==i.code)return t({title:i.msg||"删除失败",icon:"none"});t({title:"已删除",icon:"success"}),this.customers=this.customers.filter((t=>t._id!==e._id))}catch(i){console.error("删除客户失败",i),t({title:"删除失败",icon:"none"})}}})}}},[["render",function(e,t,s,a,i,C){const b=l("BackToDashboardBar"),A=k,L=c,S=p,T=y;return r(),o(L,{class:"page"},{default:n((()=>[d(L,{class:"page-inner"},{default:n((()=>[d(b,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),d(L,{class:"page-header"},{default:n((()=>[d(L,{class:"page-header-left"},{default:n((()=>[d(L,{class:"page-icon"},{default:n((()=>[d(A,{class:"page-icon-text"},{default:n((()=>[u("客")])),_:1})])),_:1}),d(L,{class:"page-header-text"},{default:n((()=>[d(A,{class:"page-title"},{default:n((()=>[u("客户管理")])),_:1}),d(A,{class:"page-sub"},{default:n((()=>[u("维护客户档案、默认单价与联系信息")])),_:1})])),_:1})])),_:1}),d(L,{class:"page-header-right"},{default:n((()=>[C.isAdmin?(r(),o(S,{key:0,class:"btn-primary",onClick:C.goCreate},{default:n((()=>[u("+ 新增客户")])),_:1},8,["onClick"])):g("",!0)])),_:1})])),_:1}),d(L,{class:"card"},{default:n((()=>[d(L,{class:"filter-row"},{default:n((()=>[d(L,{class:"search-wrapper"},{default:n((()=>[d(T,{class:"search-input",modelValue:i.keyword,"onUpdate:modelValue":t[0]||(t[0]=e=>i.keyword=e),placeholder:"按客户名 / 联系人 / 电话搜索","confirm-type":"search",onInput:C.onKeywordInput,onConfirm:C.onSearch},null,8,["modelValue","onInput","onConfirm"]),i.keyword?(r(),o(L,{key:0,class:"search-clear",onClick:C.clearKeyword},{default:n((()=>[u("×")])),_:1},8,["onClick"])):g("",!0),i.suggestions.length?(r(),o(L,{key:1,class:"suggest-panel"},{default:n((()=>[(r(!0),f(m,null,h(i.suggestions,(e=>(r(),o(L,{key:e._id,class:"suggest-item",onClick:t=>C.onSelectSuggestion(e)},{default:n((()=>[d(A,{class:"suggest-name"},{default:n((()=>[u(w(e.name),1)])),_:2},1024),e.contact||e.phone?(r(),o(A,{key:0,class:"suggest-sub"},{default:n((()=>[u(w([e.contact,e.phone].filter(Boolean).join(" / ")),1)])),_:2},1024)):g("",!0)])),_:2},1032,["onClick"])))),128)),i.suggestLoading?(r(),o(L,{key:0,class:"suggest-loading"},{default:n((()=>[u("查询中…")])),_:1})):g("",!0)])),_:1})):g("",!0)])),_:1}),d(L,{class:"segmented"},{default:n((()=>[d(L,{class:_(["seg-item",{active:"all"===i.filterActive}]),onClick:t[1]||(t[1]=e=>C.onFilterChange("all"))},{default:n((()=>[u(" 全部 ")])),_:1},8,["class"]),d(L,{class:_(["seg-item",{active:"active"===i.filterActive}]),onClick:t[2]||(t[2]=e=>C.onFilterChange("active"))},{default:n((()=>[u(" 启用 ")])),_:1},8,["class"]),d(L,{class:_(["seg-item",{active:"inactive"===i.filterActive}]),onClick:t[3]||(t[3]=e=>C.onFilterChange("inactive"))},{default:n((()=>[u(" 停用 ")])),_:1},8,["class"])])),_:1})])),_:1})])),_:1}),d(L,{class:"card"},{default:n((()=>[i.loading&&0===i.customers.length?(r(),o(L,{key:0,class:"empty"},{default:n((()=>[d(A,{class:"empty-main"},{default:n((()=>[u("加载中…")])),_:1})])),_:1})):i.loading||0!==i.customers.length?(r(),o(L,{key:2},{default:n((()=>[(r(!0),f(m,null,h(i.customers,(e=>(r(),o(L,{key:e._id,class:"customer-row",onClick:t=>C.onRowClick(e)},{default:n((()=>[d(L,{class:"row-main"},{default:n((()=>[d(L,{class:"row-title-line"},{default:n((()=>[d(A,{class:"row-name"},{default:n((()=>[u(w(e.name||"未命名客户"),1)])),_:2},1024),d(L,{class:_(["status-tag",{inactive:!1===e.is_active}])},{default:n((()=>[!1===e.is_active?(r(),o(A,{key:0},{default:n((()=>[u("停用")])),_:1})):(r(),o(A,{key:1},{default:n((()=>[u("启用")])),_:1}))])),_:2},1032,["class"])])),_:2},1024),d(L,{class:"row-meta"},{default:n((()=>[e.contact?(r(),o(A,{key:0,class:"row-meta-item"},{default:n((()=>[u(" 联系人："+w(e.contact),1)])),_:2},1024)):g("",!0),e.phone?(r(),o(A,{key:1,class:"row-meta-item"},{default:n((()=>[u(" 电话："+w(e.phone),1)])),_:2},1024)):g("",!0)])),_:2},1024),d(L,{class:"row-meta"},{default:n((()=>[e.address?(r(),o(A,{key:0,class:"row-meta-item"},{default:n((()=>[u(" 地址："+w(e.address),1)])),_:2},1024)):g("",!0)])),_:2},1024),d(L,{class:"row-meta"},{default:n((()=>[null!=e.default_unit_price?(r(),o(A,{key:0,class:"row-meta-item strong"},{default:n((()=>[u(" 默认单价："+w(e.default_unit_price)+" 元 / "+w(C.getPriceUnitLabel(e.default_price_unit)),1)])),_:2},1024)):g("",!0)])),_:2},1024),e.remark?(r(),o(L,{key:0,class:"row-remark"},{default:n((()=>[u(" 备注："+w(e.remark),1)])),_:2},1024)):g("",!0)])),_:2},1024),C.isAdmin?(r(),o(L,{key:0,class:"row-actions",onClick:t[4]||(t[4]=v((()=>{}),["stop"]))},{default:n((()=>[d(S,{class:"btn-mini",onClick:t=>C.goEdit(e)},{default:n((()=>[u("编辑")])),_:2},1032,["onClick"]),d(S,{class:"btn-mini danger",onClick:t=>C.onRemove(e)},{default:n((()=>[u("删除")])),_:2},1032,["onClick"])])),_:2},1024)):g("",!0)])),_:2},1032,["onClick"])))),128)),d(L,{class:"list-footer"},{default:n((()=>[i.finished?(r(),o(A,{key:0},{default:n((()=>[u("没有更多了")])),_:1})):i.loading?(r(),o(A,{key:1},{default:n((()=>[u("加载中…")])),_:1})):(r(),o(A,{key:2,onClick:C.loadMore,class:"load-more"},{default:n((()=>[u("加载更多")])),_:1},8,["onClick"]))])),_:1})])),_:1})):(r(),o(L,{key:1,class:"empty"},{default:n((()=>[d(A,{class:"empty-main"},{default:n((()=>[u("暂无客户")])),_:1}),d(A,{class:"empty-sub"},{default:n((()=>[u("点击右上角“新增客户”开始建立客户档案")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-ebb12643"]]);export{x as default};
