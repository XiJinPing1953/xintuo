import{s as t,t as e,n as a,k as s,q as l,c as i,w as n,i as o,o as r,d as u,e as d,l as c,p as _,u as h,v as g,F as f,A as m,f as p,I as b,x as k,g as w,D as x,m as C}from"./index-C85BGToL.js";import{e as y,g as v,d as F}from"./auth.yulpUJA0.js";import{B as S}from"./BackToDashboardBar.BBeceW6P.js";import{_ as I}from"./_plugin-vue_export-helper.BCo6x5W8.js";const N=I({components:{BackToDashboardBar:S},data:()=>({isAdmin:!1,statusTextMap:{in_station:"在站",at_customer:"在客户",repairing:"维修",scrapped:"报废",lost:"丢失",unknown:"未维护"},statusOptions:[{value:"",label:"全部状态"},{value:"in_station",label:"在站"},{value:"at_customer",label:"在客户"},{value:"repairing",label:"维修"},{value:"scrapped",label:"报废"},{value:"lost",label:"丢失"},{value:"unknown",label:"未维护"}],keyword:"",statusFilter:"",statusPickerIndex:0,list:[],page:1,pageSize:20,total:0,loading:!1,showEditDialog:!1,editMode:"create",editForm:{id:"",number:"",tare_weight:"",status:"in_station",remark:"",filling_gross_weight:"",filling_net_weight:"",last_gross_weight:"",last_net_weight:"",last_return_diff:"",next_out_gross:"",next_out_net:""},saving:!1,editStatusIndex:1,pendingBottleNumber:"",hasAutoOpenFromParam:!1}),computed:{statusFilterLabel(){const t=this.statusOptions[this.statusPickerIndex];return t?t.label:"全部状态"},editStatusLabel(){const t=this.statusOptions[this.editStatusIndex];return t?t.label:""},pageCount(){return this.total&&this.pageSize?Math.ceil(this.total/this.pageSize):0}},onLoad(t){if(!y())return;const e=v()||{};this.isAdmin="admin"===e.role,t&&t.number&&(this.keyword=t.number,this.pendingBottleNumber=t.number),this.fetchList(!0)},methods:{effectiveLastBackNet(t){const e=null!=t.last_back_net_weight?Number(t.last_back_net_weight):null;return null==e||Number.isNaN(e)?"—":e.toFixed(2)+" kg"},isReturnAnomaly(t){const e=Number(t.last_back_net_weight);return!Number.isNaN(e)&&Math.abs(e)>5},onStatusChange(t){const e=Number(t.detail.value);this.statusPickerIndex=e,this.statusFilter=this.statusOptions[e].value},resetFilter(){this.keyword="",this.statusFilter="",this.statusPickerIndex=0,this.page=1,this.pendingBottleNumber="",this.hasAutoOpenFromParam=!1,this.fetchList(!0)},onSearch(){this.page=1,this.fetchList(!0)},async fetchList(a=!1){a&&(this.page=1);const s=F();if(s){this.loading=!0;try{const a=await e.callFunction({name:"crm-bottle",data:{action:"list",token:s,data:{keyword:this.keyword,status:this.statusFilter||void 0,page:this.page,pageSize:this.pageSize}}});a.result&&0===a.result.code?(this.list=a.result.data||[],this.total=a.result.total||0,this.isAdmin&&this.pendingBottleNumber&&!this.hasAutoOpenFromParam&&1===this.list.length&&this.list[0].number===this.pendingBottleNumber&&(this.openEdit(this.list[0]),this.hasAutoOpenFromParam=!0)):t({title:a.result&&a.result.msg||"加载失败",icon:"none"})}catch(l){console.error("fetch bottles error",l),t({title:"请求出错",icon:"none"})}finally{this.loading=!1}}else t({title:"未登录",icon:"none"})},changePage(t){const e=this.page+t;e<1||this.pageCount&&e>this.pageCount||(this.page=e,this.fetchList())},openCreate(){if(!this.isAdmin)return t({title:"无权限",icon:"none"});this.editMode="create",this.editForm={id:"",number:"",tare_weight:"",status:"in_station",remark:"",filling_gross_weight:"",filling_net_weight:"",last_gross_weight:"",last_net_weight:"",last_return_diff:"",next_out_gross:"",next_out_net:""},this.editStatusIndex=this.statusOptions.findIndex((t=>"in_station"===t.value)),this.editStatusIndex<0&&(this.editStatusIndex=1),this.showEditDialog=!0},openEdit(e){if(!this.isAdmin)return t({title:"无权限",icon:"none"});this.editMode="edit",this.editForm={id:e._id,number:e.number,tare_weight:null!=e.tare_weight?String(e.tare_weight):"",status:e.status||"unknown",remark:e.remark||"",filling_gross_weight:null!=e.filling_gross_weight?String(e.filling_gross_weight):"",filling_net_weight:null!=e.filling_net_weight?String(e.filling_net_weight):"",last_gross_weight:null!=e.last_gross_weight?String(e.last_gross_weight):"",last_net_weight:null!=e.last_net_weight?String(e.last_net_weight):"",last_return_diff:null!=e.last_return_diff?String(e.last_return_diff):"",next_out_gross:null!=e.next_out_gross?String(e.next_out_gross):"",next_out_net:null!=e.next_out_net?String(e.next_out_net):""};const a=this.statusOptions.findIndex((t=>t.value===this.editForm.status));this.editStatusIndex=a>=0?a:0,this.showEditDialog=!0},closeDialog(){this.saving||(this.showEditDialog=!1)},onEditStatusChange(t){const e=Number(t.detail.value);this.editStatusIndex=e,this.editForm.status=this.statusOptions[e].value||"unknown"},async saveBottle(){if(!this.isAdmin)return t({title:"无权限",icon:"none"});const a=(this.editForm.number||"").trim();if(!a)return t({title:"瓶号不能为空",icon:"none"});const s=F();if(!s)return t({title:"未登录",icon:"none"});const l={number:a,tare_weight:this.editForm.tare_weight,status:this.editForm.status,remark:this.editForm.remark};this.saving=!0;try{let a;a="create"===this.editMode?await e.callFunction({name:"crm-bottle",data:{action:"create",token:s,data:l}}):await e.callFunction({name:"crm-bottle",data:{action:"update",token:s,data:Object.assign({id:this.editForm.id},l)}}),a.result&&0===a.result.code?(t({title:"create"===this.editMode?"新增成功":"保存成功",icon:"success"}),this.showEditDialog=!1,this.fetchList()):t({title:a.result&&a.result.msg||"操作失败",icon:"none"})}catch(i){console.error("save bottle error",i),t({title:"请求出错",icon:"none"})}finally{this.saving=!1}},goDetail(t){t&&t.number&&a({url:`/pages/bottle/detail?number=${encodeURIComponent(t.number)}`})},removeItem(a){if(!this.isAdmin)return t({title:"无权限",icon:"none"});const l=F();l?s({title:"确认删除",content:`确认删除瓶号 ${a.number} 吗？`,success:async s=>{if(s.confirm)try{const s=await e.callFunction({name:"crm-bottle",data:{action:"remove",token:l,data:{id:a._id}}});s.result&&0===s.result.code?(t({title:"已删除",icon:"success"}),1===this.list.length&&this.page>1&&(this.page-=1),this.fetchList()):t({title:s.result&&s.result.msg||"删除失败",icon:"none"})}catch(i){console.error("remove bottle error",i),t({title:"请求出错",icon:"none"})}}}):t({title:"未登录",icon:"none"})}}},[["render",function(t,e,a,s,y,v){const F=l("BackToDashboardBar"),S=p,I=o,N=b,A=k,B=w,D=x;return r(),i(I,{class:"bottle-page"},{default:n((()=>[u(I,{class:"bottle-inner"},{default:n((()=>[u(F),u(I,{class:"page-header"},{default:n((()=>[u(I,{class:"page-header-left"},{default:n((()=>[u(I,{class:"page-icon"},{default:n((()=>[u(S,{class:"page-icon-text"},{default:n((()=>[d("瓶")])),_:1})])),_:1}),u(I,{class:"page-header-text"},{default:n((()=>[u(S,{class:"page-title"},{default:n((()=>[d("瓶子管理")])),_:1}),u(S,{class:"page-sub"},{default:n((()=>[d(" 维护瓶子的皮重、状态与备注，支持按瓶号快速搜索 ")])),_:1})])),_:1})])),_:1}),u(I,{class:"page-header-right"},{default:n((()=>[u(I,{class:"tag-soft"},{default:n((()=>[u(S,{class:"tag-dot"}),u(S,{class:"tag-text"},{default:n((()=>[d("共 "+c(y.total)+" 只瓶子",1)])),_:1})])),_:1})])),_:1})])),_:1}),u(I,{class:"card"},{default:n((()=>[u(I,{class:"card-header"},{default:n((()=>[u(S,{class:"card-title"},{default:n((()=>[d("筛选")])),_:1})])),_:1}),u(I,{class:"card-body"},{default:n((()=>[u(I,{class:"form-row"},{default:n((()=>[u(I,{class:"form-item col-half"},{default:n((()=>[u(S,{class:"label"},{default:n((()=>[d("瓶号关键字")])),_:1}),u(I,{class:"input-wrapper"},{default:n((()=>[u(N,{class:"input",placeholder:"例如：J2 / 20，支持前缀匹配",modelValue:y.keyword,"onUpdate:modelValue":e[0]||(e[0]=t=>y.keyword=t),onConfirm:v.onSearch},null,8,["modelValue","onConfirm"])])),_:1})])),_:1}),u(I,{class:"form-item col-half"},{default:n((()=>[u(S,{class:"label"},{default:n((()=>[d("状态")])),_:1}),u(A,{mode:"selector",range:y.statusOptions,"range-key":"label",value:y.statusPickerIndex,onChange:v.onStatusChange},{default:n((()=>[u(I,{class:"input-wrapper"},{default:n((()=>[u(I,{class:"picker"},{default:n((()=>[u(S,null,{default:n((()=>[d(c(v.statusFilterLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1}),u(I,{class:"btn-row-inline"},{default:n((()=>[u(B,{class:"btn-soft",onClick:v.resetFilter},{default:n((()=>[d("重置")])),_:1},8,["onClick"]),u(B,{class:"btn-primary",onClick:v.onSearch},{default:n((()=>[d("查询")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1}),u(I,{class:"card"},{default:n((()=>[u(I,{class:"card-header"},{default:n((()=>[u(S,{class:"card-title"},{default:n((()=>[d("瓶子列表")])),_:1}),u(I,{class:"card-header-right"},{default:n((()=>[y.isAdmin?(r(),i(B,{key:0,class:"btn-soft",onClick:v.openCreate},{default:n((()=>[d(" + 新增瓶子 ")])),_:1},8,["onClick"])):_("",!0)])),_:1})])),_:1}),u(I,{class:"card-body"},{default:n((()=>[y.loading?(r(),i(I,{key:0,class:"list-empty"},{default:n((()=>[u(S,{class:"empty-text"},{default:n((()=>[d("加载中...")])),_:1})])),_:1})):y.list.length?(r(),i(I,{key:2},{default:n((()=>[(r(!0),h(f,null,g(y.list,(t=>(r(),i(I,{key:t._id,class:"bottle-item",onClick:e=>v.goDetail(t)},{default:n((()=>[u(I,{class:"bottle-main"},{default:n((()=>[u(I,{class:"bottle-line"},{default:n((()=>[u(S,{class:"bottle-no"},{default:n((()=>[d("瓶号："+c(t.number),1)])),_:2},1024),u(I,{class:C(["status-pill","status-"+(t.status||"unknown")])},{default:n((()=>[u(S,{class:"status-dot"}),u(S,{class:"status-text"},{default:n((()=>[d(c(y.statusTextMap[t.status]||"未维护"),1)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1024),u(I,{class:"bottle-line"},{default:n((()=>[u(S,{class:"bottle-meta"},{default:n((()=>[d(" 铭牌皮重： "+c(null!=t.tare_weight?t.tare_weight+" kg":"—"),1)])),_:2},1024),u(S,{class:C(["bottle-meta",{"danger-text":v.isReturnAnomaly(t)}])},{default:n((()=>[d(" 上次回瓶净重："+c(v.effectiveLastBackNet(t)),1)])),_:2},1032,["class"])])),_:2},1024),u(I,{class:"bottle-line"},{default:n((()=>[u(S,{class:"bottle-meta"},{default:n((()=>[d(" 最近灌装： "+c(t.last_fill_date?t.last_fill_date+" · "+(null!=t.last_fill_net?t.last_fill_net+" kg":"—"):"—"),1)])),_:2},1024),u(S,{class:"bottle-meta"},{default:n((()=>[d(" 上次客户："+c(t.last_customer_name||"—"),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),y.isAdmin?(r(),i(I,{key:0,class:"bottle-actions",onClick:e[1]||(e[1]=m((()=>{}),["stop"]))},{default:n((()=>[u(B,{class:"btn-mini",onClick:e=>v.openEdit(t)},{default:n((()=>[d("编辑")])),_:2},1032,["onClick"]),u(B,{class:"btn-mini btn-danger",onClick:e=>v.removeItem(t)},{default:n((()=>[d(" 删除 ")])),_:2},1032,["onClick"])])),_:2},1024)):_("",!0)])),_:2},1032,["onClick"])))),128)),u(I,{class:"pagination"},{default:n((()=>[u(B,{class:"btn-mini",disabled:y.page<=1,onClick:e[2]||(e[2]=t=>v.changePage(-1))},{default:n((()=>[d(" 上一页 ")])),_:1},8,["disabled"]),u(S,{class:"page-info"},{default:n((()=>[d(" 第 "+c(y.page)+" / "+c(v.pageCount||1)+" 页 ",1)])),_:1}),u(B,{class:"btn-mini",disabled:y.page>=v.pageCount,onClick:e[3]||(e[3]=t=>v.changePage(1))},{default:n((()=>[d(" 下一页 ")])),_:1},8,["disabled"])])),_:1})])),_:1})):(r(),i(I,{key:1,class:"list-empty"},{default:n((()=>[u(S,{class:"empty-text"},{default:n((()=>[d("暂无数据")])),_:1})])),_:1}))])),_:1})])),_:1}),y.showEditDialog?(r(),i(I,{key:0,class:"dialog-mask",onClick:m(v.closeDialog,["self"])},{default:n((()=>[u(I,{class:"dialog-body"},{default:n((()=>[u(I,{class:"dialog-header"},{default:n((()=>[u(S,{class:"dialog-title"},{default:n((()=>[d(c("create"===y.editMode?"新增瓶子":"编辑瓶子"),1)])),_:1})])),_:1}),u(I,{class:"dialog-content"},{default:n((()=>[u(I,{class:"form-item"},{default:n((()=>[u(S,{class:"label"},{default:n((()=>[d("* 瓶号")])),_:1}),u(I,{class:"input-wrapper"},{default:n((()=>[u(N,{class:"input",placeholder:"例如：201 / J201",modelValue:y.editForm.number,"onUpdate:modelValue":e[4]||(e[4]=t=>y.editForm.number=t)},null,8,["modelValue"])])),_:1})])),_:1}),u(I,{class:"form-row"},{default:n((()=>[u(I,{class:"form-item col-half"},{default:n((()=>[u(S,{class:"label"},{default:n((()=>[d("皮重 (kg)")])),_:1}),u(I,{class:"input-wrapper"},{default:n((()=>[u(N,{class:"input",type:"number",placeholder:"可空",modelValue:y.editForm.tare_weight,"onUpdate:modelValue":e[5]||(e[5]=t=>y.editForm.tare_weight=t)},null,8,["modelValue"])])),_:1})])),_:1}),u(I,{class:"form-item col-half"},{default:n((()=>[u(S,{class:"label"},{default:n((()=>[d("状态")])),_:1}),u(A,{mode:"selector",range:y.statusOptions,"range-key":"label",value:y.editStatusIndex,onChange:v.onEditStatusChange},{default:n((()=>[u(I,{class:"input-wrapper"},{default:n((()=>[u(I,{class:"picker"},{default:n((()=>[u(S,null,{default:n((()=>[d(c(v.editStatusLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1}),u(I,{class:"form-item"},{default:n((()=>[u(S,{class:"label"},{default:n((()=>[d("备注")])),_:1}),u(D,{class:"textarea",placeholder:"例如：瓶身有划痕，优先安排维修",modelValue:y.editForm.remark,"onUpdate:modelValue":e[6]||(e[6]=t=>y.editForm.remark=t)},null,8,["modelValue"])])),_:1})])),_:1}),u(I,{class:"dialog-footer"},{default:n((()=>[u(B,{class:"btn-soft",onClick:v.closeDialog},{default:n((()=>[d("取消")])),_:1},8,["onClick"]),u(B,{class:"btn-primary",loading:y.saving,onClick:v.saveBottle},{default:n((()=>[d(" 保存 ")])),_:1},8,["loading","onClick"])])),_:1})])),_:1})])),_:1},8,["onClick"])):_("",!0)])),_:1})])),_:1})}],["__scopeId","data-v-e5d76122"]]);export{N as default};
