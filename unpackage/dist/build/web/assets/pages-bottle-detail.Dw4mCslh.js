import{s as t,t as e,q as a,c as l,w as s,i as o,o as r,d as i,e as d,l as c,m as n,u,v as _,F as f,p as m,f as b}from"./index-C85BGToL.js";import{e as h,d as g}from"./auth.yulpUJA0.js";import{B as p}from"./BackToDashboardBar.BBeceW6P.js";import{_ as k}from"./_plugin-vue_export-helper.BCo6x5W8.js";const w=k({components:{BackToDashboardBar:p},data:()=>({bottleId:"",bottleNumber:"",bottle:null,loading:!1,records:[],recordsLoading:!1,showAllRecords:!1}),computed:{statusText(){return{in_station:"在站",at_customer:"在客户",in_transit:"途中",repairing:"维修",scrapped:"报废",lost:"丢失",unknown:"未维护"}[this.bottle&&this.bottle.status]||"未维护"},visibleRecords(){return this.showAllRecords?this.records:this.records.slice(0,3)},hasMoreRecords(){return this.records.length>3}},onLoad(t){h()&&(this.bottleId=t&&t.id?t.id:"",this.bottleNumber=t&&t.number?t.number:"",this.fetchBottleDetail())},methods:{async fetchBottleDetail(){const a=g();if(a)if(this.bottleNumber||this.bottleId){this.loading=!0;try{let l;l=await e.callFunction({name:"crm-bottle",data:{action:"getByNumber",token:a,data:{number:this.bottleNumber}}});const s=l&&l.result||{};if(0!==s.code)return t({title:s.msg||"加载失败",icon:"none"}),void(this.bottle=null);this.bottle=s.data||null,this.bottle&&this.bottle.number&&(this.bottleNumber=this.bottle.number,this.loadRecords())}catch(l){console.error("load bottle detail error:",l),t({title:"加载失败，请稍后再试",icon:"none"})}finally{this.loading=!1}}else t({title:"缺少瓶号参数",icon:"none"});else t({title:"请先登录",icon:"none"})},toggleRecords(){this.showAllRecords=!this.showAllRecords},async loadRecords(){if(!this.bottleNumber)return;const a=g();if(a){this.recordsLoading=!0;try{const l=e.callFunction({name:"crm-sale",data:{action:"listByBottle",token:a,data:{number:this.bottleNumber,page:1,pageSize:100}}}),s=e.callFunction({name:"crm-filling",data:{action:"list",token:a,data:{page:1,pageSize:100,bottle_no:this.bottleNumber}}}),[o,r]=await Promise.all([l,s]),i=o.result||{},d=r.result||{};if(0!==i.code&&0!==d.code)return t({title:i.msg||d.msg||"加载流转记录失败",icon:"none"}),void(this.records=[]);const c=Array.isArray(i.data)?i.data:[],n=Array.isArray(d.data)?d.data:[],u=[];c.forEach((t=>{u.push({type:"sale",role:t.role||"record",customer_name:t.customer_name,net_weight:t.net_weight,unit_price:t.unit_price,price_unit:t.price_unit,remark:t.remark,created_at:t.created_at,updated_at:t.updated_at,date:t.date,_raw:t})})),n.forEach((t=>{u.push({type:"fill",role:"fill",customer_name:"站内灌装",net_weight:t.net_fill,unit_price:null,price_unit:null,remark:t.remark,created_at:t.created_at,updated_at:t.updated_at,date:t.date,timestamp:t.timestamp,_raw:t})})),u.sort(((t,e)=>{const a=this.recordTimestamp(t);return this.recordTimestamp(e)-a})),this.records=u}catch(l){console.error("load bottle records error:",l),t({title:"加载流转记录失败",icon:"none"}),this.records=[]}finally{this.recordsLoading=!1}}},recordTimestamp:t=>t?t.created_at?t.created_at:t.updated_at?t.updated_at:t.timestamp?t.timestamp:t.date?new Date(t.date).getTime():0:0,roleLabel:t=>"out"===t?"出瓶":"back"===t?"回瓶":"deposit"===t?"存瓶":"fill"===t?"灌装":"记录",formatTime(t){if(!t)return"";const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`},formatRecordTime(t){return t?t.created_at?this.formatTime(t.created_at):t.updated_at?this.formatTime(t.updated_at):t.date?`${t.date} 00:00`:"未填日期":"未填日期"}}},[["render",function(t,e,h,g,p,k){const w=a("BackToDashboardBar"),y=b,v=o;return r(),l(v,{class:"page"},{default:s((()=>[i(v,{class:"inner"},{default:s((()=>[i(w,{"back-to":"/pages/bottle/manage",text:"返回"}),i(v,{class:"page-header"},{default:s((()=>[i(v,{class:"page-header-left"},{default:s((()=>[i(v,{class:"page-icon"},{default:s((()=>[i(y,{class:"page-icon-text"},{default:s((()=>[d("瓶")])),_:1})])),_:1}),i(v,{class:"page-header-text"},{default:s((()=>[i(y,{class:"page-title"},{default:s((()=>[d("瓶子详情")])),_:1}),i(y,{class:"page-sub"},{default:s((()=>[d(" 查看瓶号、皮重、状态与备注 ")])),_:1})])),_:1})])),_:1})])),_:1}),i(v,{class:"card"},{default:s((()=>[i(v,{class:"card-header"},{default:s((()=>[i(y,{class:"card-title"},{default:s((()=>[d("基本信息")])),_:1})])),_:1}),p.loading?(r(),l(v,{key:0,class:"loading-block"},{default:s((()=>[i(y,{class:"loading-text"},{default:s((()=>[d("加载中…")])),_:1})])),_:1})):p.bottle?(r(),l(v,{key:2,class:"info-body"},{default:s((()=>[i(v,{class:"info-row"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("瓶号")])),_:1}),i(y,{class:"info-value strong"},{default:s((()=>[d(c(p.bottle.number),1)])),_:1})])),_:1}),i(v,{class:"info-row"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("皮重")])),_:1}),i(y,{class:"info-value"},{default:s((()=>[d(c(null!=p.bottle.tare_weight?p.bottle.tare_weight+" kg":"未填写"),1)])),_:1})])),_:1}),i(v,{class:"info-row"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("状态")])),_:1}),i(v,{class:n(["status-pill","status-"+(p.bottle.status||"unknown")])},{default:s((()=>[i(y,{class:"status-dot"}),i(y,{class:"status-text"},{default:s((()=>[d(c(k.statusText),1)])),_:1})])),_:1},8,["class"])])),_:1}),i(v,{class:"info-row"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("备注")])),_:1}),i(y,{class:"info-value"},{default:s((()=>[d(c(p.bottle.remark||"—"),1)])),_:1})])),_:1}),i(v,{class:"info-row"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("最近灌装")])),_:1}),i(y,{class:"info-value"},{default:s((()=>[d(c(p.bottle.last_fill_date?p.bottle.last_fill_date+" · "+(null!=p.bottle.last_fill_net?p.bottle.last_fill_net+" kg":"—"):"—"),1)])),_:1})])),_:1}),i(v,{class:"info-row"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("上次回瓶")])),_:1}),i(y,{class:"info-value"},{default:s((()=>[d(c(p.bottle.last_back_date?p.bottle.last_back_date+" · "+(null!=p.bottle.last_back_net_weight?p.bottle.last_back_net_weight+" kg":"—"):"—"),1)])),_:1})])),_:1}),i(v,{class:"info-row"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("下次出瓶净重")])),_:1}),i(y,{class:"info-value"},{default:s((()=>[d(c(null!=p.bottle.next_out_net?p.bottle.next_out_net+" kg":"—"),1)])),_:1})])),_:1}),i(v,{class:"info-row"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("上次客户")])),_:1}),i(y,{class:"info-value"},{default:s((()=>[d(c(p.bottle.last_customer_name||"—"),1)])),_:1})])),_:1}),i(v,{class:"info-row info-row-small"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("创建时间")])),_:1}),i(y,{class:"info-value minor"},{default:s((()=>[d(c(k.formatTime(p.bottle.created_at)||"—"),1)])),_:1})])),_:1}),i(v,{class:"info-row info-row-small"},{default:s((()=>[i(y,{class:"info-label"},{default:s((()=>[d("最近更新")])),_:1}),i(y,{class:"info-value minor"},{default:s((()=>[d(c(k.formatTime(p.bottle.updated_at)||"—"),1)])),_:1})])),_:1})])),_:1})):(r(),l(v,{key:1,class:"empty-block"},{default:s((()=>[i(y,{class:"empty-main"},{default:s((()=>[d("未找到瓶子信息")])),_:1}),i(y,{class:"empty-sub"},{default:s((()=>[d("请检查传入的瓶号或稍后重试")])),_:1})])),_:1}))])),_:1}),i(v,{class:"card"},{default:s((()=>[i(v,{class:"card-header"},{default:s((()=>[i(y,{class:"card-title"},{default:s((()=>[d("流转记录")])),_:1}),i(y,{class:"card-sub"},{default:s((()=>[d(c(p.records.length>0?"共 "+p.records.length+" 条相关记录":"展示与该瓶号有关的销售/灌装记录"),1)])),_:1})])),_:1}),p.recordsLoading?(r(),l(v,{key:0,class:"loading-block"},{default:s((()=>[i(y,{class:"loading-text"},{default:s((()=>[d("加载中…")])),_:1})])),_:1})):p.records.length?(r(),l(v,{key:2,class:"timeline"},{default:s((()=>[(r(!0),u(f,null,_(k.visibleRecords,((t,e)=>(r(),l(v,{key:e,class:"timeline-row"},{default:s((()=>[i(v,{class:"timeline-left"},{default:s((()=>[i(v,{class:n(["timeline-dot","role-"+t.role])},null,8,["class"]),e!==k.visibleRecords.length-1?(r(),l(v,{key:0,class:"timeline-line"})):m("",!0)])),_:2},1024),i(v,{class:"timeline-content"},{default:s((()=>[i(v,{class:"timeline-top"},{default:s((()=>[i(v,{class:n(["role-tag","role-tag-"+t.role])},{default:s((()=>[i(y,{class:"role-text"},{default:s((()=>[d(c(t.role_text||k.roleLabel(t.role)),1)])),_:2},1024)])),_:2},1032,["class"]),i(y,{class:"time-text"},{default:s((()=>[d(c(k.formatRecordTime(t)),1)])),_:2},1024)])),_:2},1024),i(v,{class:"timeline-main"},{default:s((()=>[i(y,{class:"main-title"},{default:s((()=>[d(c(t.customer_name||"未知客户"),1)])),_:2},1024),i(v,{class:"main-meta"},{default:s((()=>[null!=t.net_weight?(r(),l(y,{key:0,class:"meta-item"},{default:s((()=>[d(" 净重 "+c(t.net_weight)+" kg ",1)])),_:2},1024)):m("",!0),null!=t.unit_price?(r(),l(y,{key:1,class:"meta-item"},{default:s((()=>[d(" 单价 "+c(t.unit_price)+" "+c("bottle"===t.price_unit?"元/瓶":"kg"===t.price_unit?"元/kg":""),1)])),_:2},1024)):m("",!0)])),_:2},1024),t.remark?(r(),l(y,{key:0,class:"meta-remark"},{default:s((()=>[d(" 备注："+c(t.remark),1)])),_:2},1024)):m("",!0)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128)),k.hasMoreRecords?(r(),l(v,{key:0,class:"timeline-toggle"},{default:s((()=>[i(y,{class:"toggle-text",onClick:k.toggleRecords},{default:s((()=>[d(c(p.showAllRecords?"收起部分记录":"展开更多记录"),1)])),_:1},8,["onClick"])])),_:1})):m("",!0)])),_:1})):(r(),l(v,{key:1,class:"empty-block"},{default:s((()=>[i(y,{class:"empty-main"},{default:s((()=>[d("暂无流转记录")])),_:1}),i(y,{class:"empty-sub"},{default:s((()=>[d(" 录入几条含有该瓶号的销售或灌装记录后，这里会自动生成时间线。 ")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-71b76cdb"]]);export{w as default};
