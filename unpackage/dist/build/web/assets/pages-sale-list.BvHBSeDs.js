import{t as e,s as t,n as a,H as s,J as l,q as o,c as i,w as r,i as u,o as c,d,e as n,u as m,v as f,F as _,p as h,l as p,m as g,f as y,I as b,x as v,g as w}from"./index-C85BGToL.js";import{B as x}from"./BackToDashboardBar.BBeceW6P.js";import{e as k,d as N}from"./auth.yulpUJA0.js";import{_ as S}from"./_plugin-vue_export-helper.BCo6x5W8.js";const C=S({components:{BackToDashboardBar:x},data:()=>({loading:!1,filters:{customerId:"",customerName:"",dateFrom:"",dateTo:""},customers:[],customerIndex:-1,customerKeyword:"",customerSuggests:[],paymentStatusOptions:["全部","已付","挂账","部分已付","冲减"],paymentStatusIndex:0,records:[],page:1,pageSize:10,total:0,exporting:!1}),filters:{money(e){const t=Number(e);return isNaN(t)?"0.00":t.toFixed(2)},weight(e){const t=Number(e);return isNaN(t)?"0":t.toFixed(0)}},computed:{customerLabel(){if(this.customerIndex<0)return"全部客户";const e=this.customers[this.customerIndex];return e?e.name:"全部客户"},paymentStatusFilterLabel(){return this.paymentStatusOptions[this.paymentStatusIndex]||"全部"},pageCount(){return this.total&&this.pageSize?Math.ceil(this.total/this.pageSize):0},isSingleDay(){const e=this.filters.dateFrom,t=this.filters.dateTo;return!(!e||!t)&&e===t},stats(){let e=0,t=0,a=0,s=0;return this.records.forEach((l=>{const o=null!=l.display_should?Number(l.display_should)||0:Number(l.amount)||0,i=null!=l.display_received?Number(l.display_received)||0:Number(l.amount_received)||0,r=Number(l.write_off||0);e+=o,t+=i,a+=Math.max(o-i-r,0);let u=null!=l.total_net_weight?Number(l.total_net_weight)||0:null!=l.net_weight?Number(l.net_weight)||0:null!=l.weight_kg&&Number(l.weight_kg)||0;Number.isFinite(u)||(u=0),s+=u})),{totalShould:e,totalReceived:t,totalUnpaid:a,totalWeightKg:s}}},onLoad(e){if(console.log("[sale/list] onLoad"),!k())return void console.log("[sale/list] ensureLogin 未通过，已跳转登录");console.log("[sale/list] ensureLogin 通过");const t=new Date,a=this.formatDate(t),s=new Date(t.getTime()-5184e5),l=this.formatDate(s);this.filters.dateFrom=e.date_from||l,this.filters.dateTo=e.date_to||a,e.customer_id&&(this.filters.customerId=e.customer_id),e.customer_name&&(this.filters.customerName=decodeURIComponent(e.customer_name)),this.loadCustomers(),this.fetchList(!0)},onShow(){k()},methods:{formatDate:e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,onCustomerInput(e){const t=e.detail.value.trim();if(this.customerKeyword=t,!t)return this.customerSuggests=[],this.filters.customerId="",void(this.filters.customerName="");this.customerSuggests=this.customers.filter((e=>e&&e.name&&e.name.includes(t))).slice(0,20)},onSelectCustomer(e){this.customerKeyword=e.name,this.filters.customerId=e._id,this.filters.customerName=e.name,this.customerSuggests=[]},async loadCustomers(){try{const t=N();if(!t)return;const a=await e.callFunction({name:"crm-customer",data:{action:"list",token:t,data:{}}});if(a.result&&0===a.result.code)if(this.customers=a.result.data||[],this.filters.customerId){const e=this.customers.findIndex((e=>e._id===this.filters.customerId));e>=0&&(this.customerIndex=e)}else if(this.filters.customerName){const e=this.customers.findIndex((e=>e.name===this.filters.customerName));e>=0&&(this.customerIndex=e,this.filters.customerId=this.customers[e]._id)}}catch(t){console.error("loadCustomers error",t)}},onCustomerChange(e){const t=Number(e.detail.value);this.customerIndex=t;const a=this.customers[t];a?(this.filters.customerId=a._id,this.filters.customerName=a.name):(this.filters.customerId="",this.filters.customerName="")},onDateFromChange(e){this.filters.dateFrom=e.detail.value},onDateToChange(e){this.filters.dateTo=e.detail.value},onPaymentStatusFilterChange(e){this.paymentStatusIndex=Number(e.detail.value)},resetFilter(){this.customerKeyword="",this.customerSuggests=[],this.customerIndex=-1,this.filters.customerId="",this.filters.customerName="";const e=new Date,t=this.formatDate(e),a=new Date(e.getTime()-5184e5),s=this.formatDate(a);this.filters.dateFrom=s,this.filters.dateTo=t,this.paymentStatusIndex=0,this.page=1,this.fetchList(!0)},onSearch(){this.page=1,this.fetchList(!0)},async fetchList(a=!1){a&&(this.page=1);const s=N();if(s){this.loading=!0;try{const a=(await e.callFunction({name:"crm-sale",data:{action:"list",token:s,data:{customer_id:this.filters.customerId||void 0,customer_name:this.filters.customerName||void 0,date_from:this.filters.dateFrom||void 0,date_to:this.filters.dateTo||void 0,page:this.page,pageSize:this.pageSize}}})).result||{};if(0!==a.code)return void t({title:a.msg||"加载失败",icon:"none"});const l=a.data||[];this.total=a.total||0,this.records=l.map((e=>{const t=e.price_unit||"kg";let a=0;a="m3"===t&&null!=e.flow_amount_should&&""!==e.flow_amount_should?Number(e.flow_amount_should)||0:Number(e.amount)||0;let s=0;s="m3"===t&&null!=e.flow_amount_received&&""!==e.flow_amount_received?Number(e.flow_amount_received)||0:Number(e.amount_received)||0;const l=Number(e.write_off||0),o=Math.max(a-s-l,0);return{...e,display_should:a,display_received:s,unpaid:o}}))}catch(l){console.error("fetchList error",l),t({title:"请求出错",icon:"none"})}finally{this.loading=!1}}else k()},changePage(e){const t=this.page+e;t<1||this.pageCount&&t>this.pageCount||(this.page=t,this.fetchList())},displayBottleNos(e,t){const a=e=>String(e||"").trim();let s=[];return"out"===t?Array.isArray(e.out_items)&&e.out_items.length?s=e.out_items.map((e=>a(e.bottle_no))).filter(Boolean):e.bottle_no&&(s=[a(e.bottle_no)]):"back"===t?Array.isArray(e.back_items)&&e.back_items.length?s=e.back_items.map((e=>a(e.bottle_no))).filter(Boolean):e.return_bottle_no&&(s=[a(e.return_bottle_no)]):"deposit"===t&&(Array.isArray(e.deposit_items)&&e.deposit_items.length?s=e.deposit_items.map((e=>a(e.bottle_no))).filter(Boolean):e.deposit_bottles_raw&&(s=e.deposit_bottles_raw.split(/[\/、,，\s]+/).map((e=>a(e))).filter(Boolean))),s.length?s.length>2?s.slice(0,2).join(" / ")+" / …":s.join(" / "):"—"},formatPriceUnit(e){const t=e||"kg";return"kg"===t?"元/kg":"bottle"===t?"元/瓶":"m3"===t?"元/m³":t},formatBizMode(e){const t=e||"bottle";return"truck"===t?"整车":"bottle"===t?"瓶装":t},goDetail(e){e&&e._id&&a({url:`/pages/sale/detail?id=${e._id}`})},async onExport(){if(this.total){this.exporting=!0;try{const a=N(),o=(await e.callFunction({name:"crm-bill",data:{action:"exportSaleListExcel",token:a,data:{customer_id:this.filters.customerId||"",customer_name:this.filters.customerName||"",date_from:this.filters.dateFrom,date_to:this.filters.dateTo,includeFlow:!0}}})).result||{};if(0!==o.code||!o.url)return void t({title:o.msg||"导出失败",icon:"none"});const i=o.url;s({url:i,success:e=>{200===e.statusCode?l?l({filePath:e.tempFilePath,success:()=>{}}):t({title:"已下载，可在本机查看",icon:"none"}):t({title:"下载失败",icon:"none"})},fail:()=>{t({title:"下载失败",icon:"none"})}})}catch(a){console.error("exportSaleListExcel error",a),t({title:"导出失败",icon:"none"})}finally{this.exporting=!1}}else t({title:"没有可导出的数据",icon:"none"})}}},[["render",function(e,t,a,s,l,x){const k=o("BackToDashboardBar"),N=y,S=u,C=b,I=v,F=w;return c(),i(S,{class:"page"},{default:r((()=>[d(S,{class:"inner"},{default:r((()=>[d(k),d(S,{class:"page-header"},{default:r((()=>[d(S,{class:"page-header-left"},{default:r((()=>[d(S,{class:"page-icon"},{default:r((()=>[d(N,{class:"page-icon-text"},{default:r((()=>[n("销")])),_:1})])),_:1}),d(S,{class:"page-header-text"},{default:r((()=>[d(N,{class:"page-title"},{default:r((()=>[n("销售记录列表")])),_:1}),d(N,{class:"page-sub"},{default:r((()=>[n(" 按日期和客户查询销售记录，支持查看详情与对账 ")])),_:1})])),_:1})])),_:1})])),_:1}),d(S,{class:"card card-filter"},{default:r((()=>[d(S,{class:"card-header"},{default:r((()=>[d(N,{class:"card-title"},{default:r((()=>[n("筛选条件")])),_:1})])),_:1}),d(S,{class:"card-body"},{default:r((()=>[d(S,{class:"form-row"},{default:r((()=>[d(S,{class:"form-item col-quarter"},{default:r((()=>[d(N,{class:"label"},{default:r((()=>[n("客户")])),_:1}),d(S,{class:"input-wrapper"},{default:r((()=>[d(C,{class:"input",type:"text",modelValue:l.customerKeyword,"onUpdate:modelValue":t[0]||(t[0]=e=>l.customerKeyword=e),placeholder:"输入客户名（支持模糊搜索）",onInput:x.onCustomerInput},null,8,["modelValue","onInput"])])),_:1}),l.customerSuggests.length?(c(),i(S,{key:0,class:"suggest-panel"},{default:r((()=>[(c(!0),m(_,null,f(l.customerSuggests,(e=>(c(),i(S,{key:e._id,class:"suggest-item",onClick:t=>x.onSelectCustomer(e)},{default:r((()=>[n(p(e.name),1)])),_:2},1032,["onClick"])))),128))])),_:1})):h("",!0)])),_:1}),d(S,{class:"form-item col-quarter"},{default:r((()=>[d(N,{class:"label"},{default:r((()=>[n("起始日期")])),_:1}),d(I,{mode:"date",value:l.filters.dateFrom,onChange:x.onDateFromChange},{default:r((()=>[d(S,{class:"input-wrapper"},{default:r((()=>[d(S,{class:"picker"},{default:r((()=>[d(N,null,{default:r((()=>[n(p(l.filters.dateFrom||"请选择起始日期"),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["value","onChange"])])),_:1}),d(S,{class:"form-item col-quarter"},{default:r((()=>[d(N,{class:"label"},{default:r((()=>[n("截止日期")])),_:1}),d(I,{mode:"date",value:l.filters.dateTo,onChange:x.onDateToChange},{default:r((()=>[d(S,{class:"input-wrapper"},{default:r((()=>[d(S,{class:"picker"},{default:r((()=>[d(N,null,{default:r((()=>[n(p(l.filters.dateTo||"请选择截止日期"),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["value","onChange"])])),_:1}),d(S,{class:"form-item col-quarter"},{default:r((()=>[d(N,{class:"label"},{default:r((()=>[n("收款状态")])),_:1}),d(I,{mode:"selector",range:l.paymentStatusOptions,value:l.paymentStatusIndex,onChange:x.onPaymentStatusFilterChange},{default:r((()=>[d(S,{class:"input-wrapper"},{default:r((()=>[d(S,{class:"picker"},{default:r((()=>[d(N,null,{default:r((()=>[n(p(x.paymentStatusFilterLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1}),d(S,{class:"btn-row-inline"},{default:r((()=>[d(F,{class:"btn-soft",onClick:x.resetFilter},{default:r((()=>[n("重置")])),_:1},8,["onClick"]),d(F,{class:"btn-primary",onClick:x.onSearch},{default:r((()=>[n("查询")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1}),l.records.length?(c(),i(S,{key:0,class:"card card-summary"},{default:r((()=>[d(S,{class:"summary-row"},{default:r((()=>[d(S,{class:"summary-item"},{default:r((()=>[d(N,{class:"summary-label"},{default:r((()=>[n("应收合计")])),_:1}),d(S,{class:"summary-value-row"},{default:r((()=>[d(N,{class:"summary-value"},{default:r((()=>[n(p(x.stats.totalShould|e.money),1)])),_:1}),d(N,{class:"summary-unit"},{default:r((()=>[n("元")])),_:1})])),_:1})])),_:1}),d(S,{class:"summary-item"},{default:r((()=>[d(N,{class:"summary-label"},{default:r((()=>[n(p(x.isSingleDay?"今日销售额":"实收合计"),1)])),_:1}),d(S,{class:"summary-value-row"},{default:r((()=>[d(N,{class:"summary-value"},{default:r((()=>[n(p(x.stats.totalReceived|e.money),1)])),_:1}),d(N,{class:"summary-unit"},{default:r((()=>[n("元")])),_:1})])),_:1})])),_:1}),d(S,{class:"summary-item"},{default:r((()=>[d(N,{class:"summary-label"},{default:r((()=>[n("未收合计")])),_:1}),d(S,{class:"summary-value-row"},{default:r((()=>[d(N,{class:g(["summary-value",x.stats.totalUnpaid>0?"text-danger":"text-normal"])},{default:r((()=>[n(p(x.stats.totalUnpaid|e.money),1)])),_:1},8,["class"]),d(N,{class:"summary-unit"},{default:r((()=>[n("元")])),_:1})])),_:1})])),_:1}),d(S,{class:"summary-item"},{default:r((()=>[d(N,{class:"summary-label"},{default:r((()=>[n(p(x.isSingleDay?"今日出气量":"出气量合计"),1)])),_:1}),d(S,{class:"summary-value-row"},{default:r((()=>[d(N,{class:"summary-value"},{default:r((()=>[n(p(x.stats.totalWeightKg|e.weight),1)])),_:1}),d(N,{class:"summary-unit"},{default:r((()=>[n("kg")])),_:1})])),_:1})])),_:1}),d(S,{class:"summary-item"},{default:r((()=>[d(N,{class:"summary-label"},{default:r((()=>[n("记录条数")])),_:1}),d(S,{class:"summary-value-row"},{default:r((()=>[d(N,{class:"summary-value"},{default:r((()=>[n(p(l.total),1)])),_:1}),d(N,{class:"summary-unit"},{default:r((()=>[n("条")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})):h("",!0),d(S,{class:"card card-list"},{default:r((()=>[d(S,{class:"card-header card-header-with-action"},{default:r((()=>[d(S,{class:"card-header-left"},{default:r((()=>[d(N,{class:"card-title"},{default:r((()=>[n("销售记录列表")])),_:1}),d(N,{class:"card-sub"},{default:r((()=>[n(" 点击任意行可查看明细，包含多瓶记录、存瓶与结算信息 ")])),_:1})])),_:1}),d(S,{class:"card-header-right"},{default:r((()=>[d(F,{class:"btn-soft btn-export",disabled:l.exporting||!l.total,onClick:x.onExport},{default:r((()=>[l.exporting?(c(),i(N,{key:1},{default:r((()=>[n("导出中…")])),_:1})):(c(),i(N,{key:0},{default:r((()=>[n("导出当前筛选范围")])),_:1}))])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),l.loading?(c(),i(S,{key:0,class:"list-loading"},{default:r((()=>[d(N,{class:"loading-text"},{default:r((()=>[n("加载中…")])),_:1})])),_:1})):l.records.length?(c(),i(S,{key:2,class:"list-wrapper"},{default:r((()=>[d(S,{class:"sale-table"},{default:r((()=>[d(S,{class:"sale-row sale-row-header"},{default:r((()=>[d(S,{class:"sale-col col-date"},{default:r((()=>[d(N,{class:"header-text"},{default:r((()=>[n("日期")])),_:1})])),_:1}),d(S,{class:"sale-col col-customer"},{default:r((()=>[d(N,{class:"header-text"},{default:r((()=>[n("客户")])),_:1})])),_:1}),d(S,{class:"sale-col col-bottle"},{default:r((()=>[d(N,{class:"header-text"},{default:r((()=>[n("出瓶")])),_:1})])),_:1}),d(S,{class:"sale-col col-bottle"},{default:r((()=>[d(N,{class:"header-text"},{default:r((()=>[n("回瓶")])),_:1})])),_:1}),d(S,{class:"sale-col col-bottle"},{default:r((()=>[d(N,{class:"header-text"},{default:r((()=>[n("存瓶")])),_:1})])),_:1}),d(S,{class:"sale-col col-amount"},{default:r((()=>[d(N,{class:"header-text"},{default:r((()=>[n("应收")])),_:1})])),_:1}),d(S,{class:"sale-col col-amount"},{default:r((()=>[d(N,{class:"header-text"},{default:r((()=>[n("实收")])),_:1})])),_:1}),d(S,{class:"sale-col col-amount"},{default:r((()=>[d(N,{class:"header-text"},{default:r((()=>[n("未收")])),_:1})])),_:1}),d(S,{class:"sale-col col-status"},{default:r((()=>[d(N,{class:"header-text"},{default:r((()=>[n("收款状态")])),_:1})])),_:1})])),_:1}),(c(!0),m(_,null,f(l.records,(t=>(c(),i(S,{key:t._id,class:g(["sale-row sale-row-body",{"row-unpaid":t.unpaid>0,"row-partial":t.unpaid>0&&Number(t.display_received||t.amount_received||0)>0}]),onClick:e=>x.goDetail(t)},{default:r((()=>[d(S,{class:"sale-col col-date"},{default:r((()=>[d(N,{class:"cell-main"},{default:r((()=>[n(p(t.date||"-"),1)])),_:2},1024)])),_:2},1024),d(S,{class:"sale-col col-customer"},{default:r((()=>[d(N,{class:"cell-main"},{default:r((()=>[n(p(t.customer_name||"未知客户"),1)])),_:2},1024),d(N,{class:"cell-sub"},{default:r((()=>[n(p(x.formatBizMode(t.biz_mode))+" · "+p(x.formatPriceUnit(t.price_unit)),1)])),_:2},1024)])),_:2},1024),d(S,{class:"sale-col col-bottle"},{default:r((()=>[d(N,{class:"cell-label"},{default:r((()=>[n("出：")])),_:1}),d(N,{class:"cell-main"},{default:r((()=>[n(p(x.displayBottleNos(t,"out")),1)])),_:2},1024)])),_:2},1024),d(S,{class:"sale-col col-bottle"},{default:r((()=>[d(N,{class:"cell-label"},{default:r((()=>[n("回：")])),_:1}),d(N,{class:"cell-main"},{default:r((()=>[n(p(x.displayBottleNos(t,"back")),1)])),_:2},1024)])),_:2},1024),d(S,{class:"sale-col col-bottle"},{default:r((()=>[d(N,{class:"cell-label"},{default:r((()=>[n("存：")])),_:1}),d(N,{class:"cell-main"},{default:r((()=>[n(p(x.displayBottleNos(t,"deposit")),1)])),_:2},1024)])),_:2},1024),d(S,{class:"sale-col col-amount"},{default:r((()=>[d(S,{class:"amount-block"},{default:r((()=>[d(N,{class:"cell-main amount-main"},{default:r((()=>[n(p((null!=t.display_should?t.display_should:t.amount)|e.money),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),d(S,{class:"sale-col col-amount"},{default:r((()=>[d(S,{class:"amount-block"},{default:r((()=>[d(N,{class:"cell-main amount-main"},{default:r((()=>[n(p((null!=t.display_received?t.display_received:t.amount_received)|e.money),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),d(S,{class:"sale-col col-amount"},{default:r((()=>[d(S,{class:"amount-block"},{default:r((()=>[d(N,{class:g(["cell-main amount-main",t.unpaid>0?"text-danger":"text-normal"])},{default:r((()=>[n(p(t.unpaid|e.money),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1024),d(S,{class:"sale-col col-status"},{default:r((()=>[d(S,{class:g(["status-pill",{paid:t.unpaid<=0&&Number((null!=t.display_should?t.display_should:t.amount)||0)>0,unpaid:t.unpaid>0&&0===Number((null!=t.display_received?t.display_received:t.amount_received)||0),partial:t.unpaid>0&&Number((null!=t.display_received?t.display_received:t.amount_received)||0)>0}])},{default:r((()=>[n(p(t.payment_status||(t.unpaid>0?Number((null!=t.display_received?t.display_received:t.amount_received)||0)>0?"部分已付":"挂账":"已付")),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1}),d(S,{class:"pagination"},{default:r((()=>[d(F,{class:"btn-soft btn-mini",disabled:l.page<=1,onClick:t[1]||(t[1]=e=>x.changePage(-1))},{default:r((()=>[n(" 上一页 ")])),_:1},8,["disabled"]),d(N,{class:"page-info"},{default:r((()=>[n(" 第 "+p(l.page)+" / "+p(x.pageCount||1)+" 页 ",1)])),_:1}),d(F,{class:"btn-soft btn-mini",disabled:l.page>=x.pageCount,onClick:t[2]||(t[2]=e=>x.changePage(1))},{default:r((()=>[n(" 下一页 ")])),_:1},8,["disabled"])])),_:1})])),_:1})):(c(),i(S,{key:1,class:"empty"},{default:r((()=>[d(N,{class:"empty-main"},{default:r((()=>[n("暂无符合条件的销售记录")])),_:1}),d(N,{class:"empty-sub"},{default:r((()=>[n("请调整客户或日期范围后重试")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-272f33aa"]]);export{C as default};
