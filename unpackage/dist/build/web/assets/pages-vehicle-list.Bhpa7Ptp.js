import{n as e,s as t,G as a,l as i,v as s,c as l,w as n,i as d,o as r,d as o,e as u,q as c,f as m,p as f,x as _,y as p,F as h,g,j as y,I as b,z as k,D as v,B as D}from"./index-B6DdPhlT.js";import{B as x}from"./BackToDashboardBar.0jhbkRhX.js";import{_ as w,i as C,e as A,g as T}from"./_plugin-vue_export-helper.Dda_PF8M.js";import{c as I}from"./request.DMeHGM82.js";import{c as E,n as V}from"./plate.CWEuA0zK.js";const $=w({components:{BackToDashboardBar:x},data:()=>({userInfo:{},keyword:"",loading:!1,vehicles:[],renderVehicles:[],total:0,startDate:"",endDate:"",exporting:!1,summaryAmount:"0.00",summaryCount:0,insuranceInfo:{text:"未设置",badge:null,items:[]},inspectionInfo:{text:"未设置",badge:null,items:[]},showEdit:!1,saving:!1,form:{_id:"",plate_no:"",name:"",insurance_due_date:"",inspection_due_date:"",remark:""}}),computed:{isAdmin(){return C(this.userInfo)}},onLoad(){A()&&(this.userInfo=T()||{},this.loadList())},methods:{async loadList(){this.loading=!0;const e=await I("crm-vehicle",{action:"list",data:{keyword:this.keyword,page:1,pageSize:200}});if(this.loading=!1,0!==e.code)return this.vehicles=[],void(this.renderVehicles=[]);const t=Array.isArray(e.data||e.list)?e.data||e.list:[];this.vehicles=t,this.total=e.total||this.vehicles.length,this.refreshDerived()},goDetail(t){t&&t._id&&e({url:`/pages/vehicle/detail?id=${t._id}`})},openEdit(e){if(!this.isAdmin)return t({title:"当前账号无权限编辑车辆",icon:"none"});this.form=e?{_id:e._id,plate_no:e.plate_no||"",name:e.name||"",insurance_due_date:e.insurance_due_date||"",inspection_due_date:e.inspection_due_date||"",remark:e.remark||""}:{_id:"",plate_no:"",name:"",insurance_due_date:"",inspection_due_date:"",remark:""},this.showEdit=!0},onPlateInput(e){this.form.plate_no=E(e.detail&&e.detail.value)},closeEdit(){this.saving||(this.showEdit=!1)},getMaintainCount(e){if(e&&"number"==typeof e.filtered_maintain_times)return e.filtered_maintain_times;if(e&&"number"==typeof e.maintain_times)return e.maintain_times;return(e&&(e.filtered_maintain_logs||e.maintain_logs)||[]).length},getMaintainAmount(e){if(e&&"number"==typeof e.filtered_maintain_amount)return Number(e.filtered_maintain_amount).toFixed(2);if(e&&"number"==typeof e.maintain_total_amount)return Number(e.maintain_total_amount).toFixed(2);return(e&&(e.filtered_maintain_logs||e.maintain_logs)||[]).reduce(((e,t)=>e+(Number(t.amount)||0)),0).toFixed(2)},onDateChange(e,t){const a=t&&t.detail&&t.detail.value||"";this[e]=a,this.refreshDerived()},resetDateFilter(){this.startDate="",this.endDate="",this.refreshDerived()},onDatePick(e,t){const a=t&&t.detail&&t.detail.value||"";this.form[e]=a},refreshDerived(){const e=[];let t=0,a=0;const i=this.dateToTimestamp(new Date);(Array.isArray(this.vehicles)?this.vehicles:[]).forEach((i=>{const s=Array.isArray(i.maintain_logs)?i.maintain_logs:[],l=this.filterLogsByDate(s),n=l.reduce(((e,t)=>e+(Number(t.amount)||0)),0);t+=n,a+=l.length,e.push({...i,filtered_maintain_logs:l,filtered_maintain_amount:Number(n.toFixed(2)),filtered_maintain_times:l.length})})),this.renderVehicles=e,this.summaryAmount=Number(t.toFixed(2)).toFixed(2),this.summaryCount=a,this.insuranceInfo=this.buildDueInfo(e,"insurance_due_date",i),this.inspectionInfo=this.buildDueInfo(e,"inspection_due_date",i)},filterLogsByDate(e){if(!this.startDate&&!this.endDate||!Array.isArray(e))return e||[];const t=this.startDate?this.dateToTimestamp(this.startDate):null,a=this.endDate?this.dateToTimestamp(this.endDate):null;return e.filter((e=>{const i=this.dateToTimestamp(e.date);return!!i&&(!(t&&i<t)&&!(a&&i>a+86399999))}))},dateToTimestamp(e){if(!e)return null;if(e instanceof Date)return new Date(`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T00:00:00`).getTime();const t=new Date(`${e}T00:00:00`).getTime();return Number.isNaN(t)?null:t},buildDueInfo(e,t,a){const i=(e||[]).map((e=>({plate_no:e.plate_no||"未填车牌",date:e[t],ts:this.dateToTimestamp(e[t])||null}))).filter((e=>e.date&&e.ts));if(!i.length)return{text:"未设置",badge:null,items:[]};i.sort(((e,t)=>e.ts-t.ts));const s=i.filter((e=>e.ts>=a&&e.ts-a<=2592e6)),l=s.length?s:[i[0]];return{text:s.length?`近30天共 ${s.length} 辆`:"最近到期",badge:this.buildDueBadge(l[0].date,a),items:l.map((e=>({plate_no:e.plate_no,date:e.date})))}},buildDueBadge(e,t){const a=this.dateToTimestamp(e);if(!a)return null;const i=t||this.dateToTimestamp(new Date),s=Math.floor((a-i)/864e5);return s<0?{text:"已过期",type:"danger"}:s<=30?{text:`剩余 ${s} 天`,type:"warning"}:{text:"已设置",type:"info"}},async exportMaintain(){if(this.exporting)return;const e=[["车牌号","车辆名称","日期","项目","配件/油品","数量","单价","金额","里程","人员","备注"]];if(this.renderVehicles.forEach((t=>{(t.filtered_maintain_logs||[]).forEach((a=>{e.push([t.plate_no||"",t.name||"",a.date||"",a.project||"",a.part||"",a.quantity||"",a.unit_price||"",a.amount||"",a.mileage||"",a.staff||"",a.remark||""])}))})),1===e.length)return t({title:"当前筛选暂无可导出的记录",icon:"none"});const i=e.map((e=>e.map((e=>`"${String(e).replace(/"/g,'""')}"`)).join(","))).join("\n");this.exporting=!0;try{if("undefined"!=typeof window&&window.Blob){const e=new Blob([i],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(e),s=document.createElement("a");return s.href=a,s.download=`车辆保养加油记录_${Date.now()}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a),void t({title:"已下载 CSV",icon:"none"})}if(uni.getFileSystemManager){const e=uni.getFileSystemManager(),s=`${"undefined"!=typeof wx&&wx.env&&wx.env.USER_DATA_PATH?wx.env.USER_DATA_PATH:uni.env&&uni.env.USER_DATA_PATH||""}/vehicle-maintain-${Date.now()}.csv`;return void e.writeFile({filePath:s,data:i,encoding:"utf8",success:()=>{t({title:"文件已保存",icon:"none"})},fail:()=>{a({data:i}),t({title:"已复制 CSV 内容",icon:"none"})}})}a({data:i}),t({title:"已复制 CSV 内容",icon:"none"})}finally{this.exporting=!1}},async submitEdit(){if(this.saving)return;if(!this.isAdmin)return t({title:"当前账号无权限保存车辆信息",icon:"none"});const e=V(this.form.plate_no);if(""===e)return t({title:"请填写车牌号",icon:"none"});if(null===e)return t({title:"车牌号格式不正确",icon:"none"});const a={plate_no:e,name:(this.form.name||"").trim(),insurance_due_date:this.form.insurance_due_date||"",inspection_due_date:this.form.inspection_due_date||"",remark:(this.form.remark||"").trim()},i=this.form._id?"update":"create";this.form._id&&(a.id=this.form._id),this.saving=!0;const s=await I("crm-vehicle",{action:i,data:a});this.saving=!1,0===s.code&&(t({title:"保存成功",icon:"success"}),this.showEdit=!1,this.loadList())},confirmRemove(e){if(!this.isAdmin)return t({title:"当前账号无权限删除车辆",icon:"none"});i({title:"删除车辆",content:`确定删除车辆【${e.plate_no||e.name||"未命名"}】吗？\n（仅删除车辆档案，历史销售记录中的车牌号不会被修改）`,success:async a=>{if(!a.confirm)return;0===(await I("crm-vehicle",{action:"remove",data:{id:e._id}})).code&&(t({title:"已删除",icon:"success"}),this.loadList())}})}}},[["render",function(e,t,a,i,x,w){const C=s("BackToDashboardBar"),A=g,T=d,I=y,E=b,V=k,$=v;return r(),l(T,{class:"vehicle-page"},{default:n((()=>[o(T,{class:"vehicle-inner"},{default:n((()=>[o(C,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),o(T,{class:"page-header"},{default:n((()=>[o(T,{class:"page-header-left"},{default:n((()=>[o(T,{class:"page-icon"},{default:n((()=>[o(A,{class:"page-icon-text"},{default:n((()=>[u("车")])),_:1})])),_:1}),o(T,{class:"page-header-text"},{default:n((()=>[o(A,{class:"page-title"},{default:n((()=>[u("车辆管理")])),_:1}),o(A,{class:"page-sub"},{default:n((()=>[u("仅承担列表/搜索与入口，单车维护移至详情页")])),_:1})])),_:1})])),_:1}),w.isAdmin?(r(),l(T,{key:0,class:"page-header-right"},{default:n((()=>[o(I,{class:"btn-primary",onClick:t[0]||(t[0]=e=>w.openEdit(null))},{default:n((()=>[u("+ 新增车辆")])),_:1})])),_:1})):c("",!0)])),_:1}),o(T,{class:"card"},{default:n((()=>[o(T,{class:"card-body"},{default:n((()=>[o(T,{class:"filter-row"},{default:n((()=>[o(T,{class:"filter-item"},{default:n((()=>[o(T,{class:"input-wrapper"},{default:n((()=>[o(E,{class:"input",modelValue:x.keyword,"onUpdate:modelValue":t[1]||(t[1]=e=>x.keyword=e),placeholder:"按车牌号 / 车辆名称搜索","confirm-type":"search",onConfirm:w.loadList},null,8,["modelValue","onConfirm"])])),_:1})])),_:1}),o(T,{class:"filter-item filter-btn"},{default:n((()=>[o(I,{class:"btn-soft",onClick:w.loadList},{default:n((()=>[u("搜索")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})])),_:1}),o(T,{class:"card summary-card"},{default:n((()=>[o(T,{class:"card-body summary-body"},{default:n((()=>[o(T,{class:"filter-row"},{default:n((()=>[o(T,{class:"filter-item"},{default:n((()=>[o(T,{class:"label"},{default:n((()=>[u("开始时间")])),_:1}),o(V,{mode:"date",value:x.startDate,onChange:t[2]||(t[2]=e=>w.onDateChange("startDate",e))},{default:n((()=>[o(T,{class:"input-wrapper picker-wrapper"},{default:n((()=>[o(A,{class:"picker-text"},{default:n((()=>[u(m(x.startDate||"不限"),1)])),_:1})])),_:1})])),_:1},8,["value"])])),_:1}),o(T,{class:"filter-item"},{default:n((()=>[o(T,{class:"label"},{default:n((()=>[u("结束时间")])),_:1}),o(V,{mode:"date",value:x.endDate,onChange:t[3]||(t[3]=e=>w.onDateChange("endDate",e))},{default:n((()=>[o(T,{class:"input-wrapper picker-wrapper"},{default:n((()=>[o(A,{class:"picker-text"},{default:n((()=>[u(m(x.endDate||"不限"),1)])),_:1})])),_:1})])),_:1},8,["value"])])),_:1}),o(T,{class:"filter-item filter-btn"},{default:n((()=>[o(I,{class:"btn-soft",onClick:w.resetDateFilter},{default:n((()=>[u("清空筛选")])),_:1},8,["onClick"])])),_:1}),o(T,{class:"filter-item filter-btn"},{default:n((()=>[o(I,{class:"btn-primary",onClick:w.exportMaintain,disabled:x.exporting},{default:n((()=>[u(m(x.exporting?"导出中…":"导出保养/加油记录"),1)])),_:1},8,["onClick","disabled"])])),_:1})])),_:1}),o(T,{class:"summary-grid"},{default:n((()=>[o(T,{class:"summary-item"},{default:n((()=>[o(A,{class:"summary-label"},{default:n((()=>[u("筛选范围金额")])),_:1}),o(A,{class:"summary-value"},{default:n((()=>[u("￥"+m(x.summaryAmount),1)])),_:1}),o(A,{class:"summary-sub"},{default:n((()=>[u("共 "+m(x.summaryCount)+" 条记录",1)])),_:1})])),_:1}),o(T,{class:"summary-item"},{default:n((()=>[o(A,{class:"summary-label"},{default:n((()=>[u("保险续期")])),_:1}),o(T,{class:"summary-inline"},{default:n((()=>[o(A,null,{default:n((()=>[u(m(x.insuranceInfo.text),1)])),_:1}),x.insuranceInfo.badge?(r(),l(A,{key:0,class:f(["due-tag",x.insuranceInfo.badge.type])},{default:n((()=>[u(m(x.insuranceInfo.badge.text),1)])),_:1},8,["class"])):c("",!0)])),_:1}),x.insuranceInfo.items.length?(r(),l(T,{key:0,class:"due-list"},{default:n((()=>[(r(!0),_(h,null,p(x.insuranceInfo.items,(e=>(r(),l(A,{key:`${e.plate_no}-${e.date}`,class:"due-chip"},{default:n((()=>[u(m(e.plate_no)+" · "+m(e.date),1)])),_:2},1024)))),128))])),_:1})):c("",!0)])),_:1}),o(T,{class:"summary-item"},{default:n((()=>[o(A,{class:"summary-label"},{default:n((()=>[u("年检时间")])),_:1}),o(T,{class:"summary-inline"},{default:n((()=>[o(A,null,{default:n((()=>[u(m(x.inspectionInfo.text),1)])),_:1}),x.inspectionInfo.badge?(r(),l(A,{key:0,class:f(["due-tag",x.inspectionInfo.badge.type])},{default:n((()=>[u(m(x.inspectionInfo.badge.text),1)])),_:1},8,["class"])):c("",!0)])),_:1}),x.inspectionInfo.items.length?(r(),l(T,{key:0,class:"due-list"},{default:n((()=>[(r(!0),_(h,null,p(x.inspectionInfo.items,(e=>(r(),l(A,{key:`${e.plate_no}-${e.date}`,class:"due-chip"},{default:n((()=>[u(m(e.plate_no)+" · "+m(e.date),1)])),_:2},1024)))),128))])),_:1})):c("",!0)])),_:1})])),_:1})])),_:1})])),_:1}),o(T,{class:"card"},{default:n((()=>[o(T,{class:"card-header"},{default:n((()=>[o(A,{class:"card-title"},{default:n((()=>[u("车辆列表")])),_:1}),o(A,{class:"card-sub"},{default:n((()=>[u("共 "+m(x.total)+" 辆",1)])),_:1})])),_:1}),o(T,{class:"card-body"},{default:n((()=>[x.loading?(r(),l(T,{key:0,class:"list-empty"},{default:n((()=>[o(A,{class:"empty-text"},{default:n((()=>[u("加载中…")])),_:1})])),_:1})):0===x.vehicles.length?(r(),l(T,{key:1,class:"list-empty"},{default:n((()=>[w.isAdmin?(r(),l(A,{key:0,class:"empty-text"},{default:n((()=>[u("暂无车辆数据，可以点击右上角「新增车辆」")])),_:1})):(r(),l(A,{key:1,class:"empty-text"},{default:n((()=>[u("暂无车辆数据，当前账号仅能查看车辆信息，如需维护车辆，请联系管理员")])),_:1}))])),_:1})):(r(),l(T,{key:2,class:"vehicle-list"},{default:n((()=>[(r(!0),_(h,null,p(x.renderVehicles,(e=>(r(),l(T,{key:e._id,class:"vehicle-item"},{default:n((()=>[o(T,{class:"vehicle-main",onClick:t=>w.goDetail(e)},{default:n((()=>[o(T,{class:"plate-tag"},{default:n((()=>[o(A,{class:"plate-text"},{default:n((()=>[u(m(e.plate_no||"未填车牌"),1)])),_:2},1024)])),_:2},1024),o(T,{class:"vehicle-info"},{default:n((()=>[o(T,{class:"vehicle-name-row"},{default:n((()=>[o(A,{class:"vehicle-name"},{default:n((()=>[u(m(e.name||"未命名车辆"),1)])),_:2},1024)])),_:2},1024),o(T,{class:"vehicle-sub-row"},{default:n((()=>[o(A,{class:"vehicle-sub"},{default:n((()=>[u(m(e.remark||"暂无备注"),1)])),_:2},1024)])),_:2},1024),(e.filtered_maintain_logs||e.maintain_logs||[]).length?(r(),l(T,{key:0,class:"maintain-meta"},{default:n((()=>[o(A,{class:"maintain-count"},{default:n((()=>[u("加油/保养/维修 "+m(w.getMaintainCount(e))+" 次",1)])),_:2},1024),o(A,{class:"maintain-total"},{default:n((()=>[u("累计金额 ￥"+m(w.getMaintainAmount(e)),1)])),_:2},1024)])),_:2},1024)):c("",!0)])),_:2},1024)])),_:2},1032,["onClick"]),w.isAdmin?(r(),l(T,{key:0,class:"vehicle-actions"},{default:n((()=>[o(A,{class:"action-link",onClick:D((t=>w.goDetail(e)),["stop"])},{default:n((()=>[u("详情")])),_:2},1032,["onClick"]),o(A,{class:"action-link danger",onClick:D((t=>w.confirmRemove(e)),["stop"])},{default:n((()=>[u("删除")])),_:2},1032,["onClick"])])),_:2},1024)):c("",!0)])),_:2},1024)))),128))])),_:1}))])),_:1})])),_:1}),x.showEdit?(r(),l(T,{key:0,class:"edit-mask"},{default:n((()=>[o(T,{class:"edit-dialog"},{default:n((()=>[o(T,{class:"edit-header"},{default:n((()=>[o(A,{class:"edit-title"},{default:n((()=>[u(m(x.form._id?"编辑车辆":"新增车辆"),1)])),_:1})])),_:1}),o(T,{class:"edit-body"},{default:n((()=>[o(T,{class:"form-item"},{default:n((()=>[o(A,{class:"label"},{default:n((()=>[u("* 车牌号")])),_:1}),o(T,{class:"input-wrapper"},{default:n((()=>[o(E,{class:"input",value:x.form.plate_no,placeholder:"例如 浙A12345",maxlength:"10",onInput:w.onPlateInput},null,8,["value","onInput"])])),_:1}),o(A,{class:"helper"},{default:n((()=>[u("支持大写字母/数字/汉字/短横线，5-10 位")])),_:1})])),_:1}),o(T,{class:"form-item"},{default:n((()=>[o(A,{class:"label"},{default:n((()=>[u("车辆名称")])),_:1}),o(T,{class:"input-wrapper"},{default:n((()=>[o(E,{class:"input",modelValue:x.form.name,"onUpdate:modelValue":t[4]||(t[4]=e=>x.form.name=e),modelModifiers:{trim:!0},placeholder:"例如 蓝牌轻卡 / 厢式货车"},null,8,["modelValue"])])),_:1})])),_:1}),o(T,{class:"form-item"},{default:n((()=>[o(A,{class:"label"},{default:n((()=>[u("保险续期时间")])),_:1}),o(V,{mode:"date",value:x.form.insurance_due_date,onChange:t[5]||(t[5]=e=>w.onDatePick("insurance_due_date",e))},{default:n((()=>[o(T,{class:"input-wrapper picker-wrapper"},{default:n((()=>[o(A,{class:"picker-text"},{default:n((()=>[u(m(x.form.insurance_due_date||"请选择日期（可选）"),1)])),_:1})])),_:1})])),_:1},8,["value"])])),_:1}),o(T,{class:"form-item"},{default:n((()=>[o(A,{class:"label"},{default:n((()=>[u("年检时间")])),_:1}),o(V,{mode:"date",value:x.form.inspection_due_date,onChange:t[6]||(t[6]=e=>w.onDatePick("inspection_due_date",e))},{default:n((()=>[o(T,{class:"input-wrapper picker-wrapper"},{default:n((()=>[o(A,{class:"picker-text"},{default:n((()=>[u(m(x.form.inspection_due_date||"请选择日期（可选）"),1)])),_:1})])),_:1})])),_:1},8,["value"])])),_:1}),o(T,{class:"form-item"},{default:n((()=>[o(A,{class:"label"},{default:n((()=>[u("备注")])),_:1}),o($,{class:"textarea",modelValue:x.form.remark,"onUpdate:modelValue":t[7]||(t[7]=e=>x.form.remark=e),modelModifiers:{trim:!0},placeholder:"可记录车辆吨位、使用范围等信息"},null,8,["modelValue"])])),_:1})])),_:1}),o(T,{class:"edit-footer"},{default:n((()=>[o(I,{class:"btn-soft",onClick:w.closeEdit,disabled:x.saving},{default:n((()=>[u("取消")])),_:1},8,["onClick","disabled"]),o(I,{class:"btn-primary",onClick:w.submitEdit,disabled:x.saving},{default:n((()=>[u(m(x.saving?"保存中…":"保存"),1)])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})])),_:1})):c("",!0)])),_:1})])),_:1})}],["__scopeId","data-v-a4257f90"]]);export{$ as default};
