import{s as t,v as e,c as a,w as l,i as s,o,d as r,e as i,f as d,p as c,x as n,y as u,F as _,q as f,g as m}from"./index-B6DdPhlT.js";import{_ as b,e as h}from"./_plugin-vue_export-helper.Dda_PF8M.js";import{c as g}from"./request.DMeHGM82.js";import{B as p}from"./BackToDashboardBar.0jhbkRhX.js";const k=b({components:{BackToDashboardBar:p},data:()=>({bottleId:"",bottleNumber:"",bottle:null,loading:!1,records:[],recordsLoading:!1,showAllRecords:!1}),computed:{statusText(){return{in_station:"在站",at_customer:"在客户",in_transit:"途中",repairing:"维修",scrapped:"报废",lost:"丢失",unknown:"未维护"}[this.bottle&&this.bottle.status]||"未维护"},visibleRecords(){return this.showAllRecords?this.records:this.records.slice(0,3)},hasMoreRecords(){return this.records.length>3}},onLoad(t){h()&&(this.bottleId=t&&t.id?t.id:"",this.bottleNumber=t&&t.number?t.number:"",this.fetchBottleDetail())},methods:{async callWithAuth(t,e){const a=await g(t,e);return 401===a.code?null:a},async fetchBottleDetail(){if(this.bottleNumber||this.bottleId){this.loading=!0;try{const e=await this.callWithAuth("crm-bottle",{action:"getByNumber",data:{number:this.bottleNumber}});if(!e)return;if(0!==e.code)return t({title:e.msg||"加载失败",icon:"none"}),void(this.bottle=null);this.bottle=e.data||null,this.bottle&&this.bottle.number&&(this.bottleNumber=this.bottle.number,this.loadRecords())}catch(e){console.error("load bottle detail error:",e),t({title:"加载失败，请稍后再试",icon:"none"})}finally{this.loading=!1}}else t({title:"缺少瓶号参数",icon:"none"})},toggleRecords(){this.showAllRecords=!this.showAllRecords},async loadRecords(){if(this.bottleNumber){this.recordsLoading=!0;try{const e=this.callWithAuth("crm-sale",{action:"listByBottle",data:{number:this.bottleNumber,page:1,pageSize:100}}),a=this.callWithAuth("crm-filling",{action:"list",data:{page:1,pageSize:100,bottle_no:this.bottleNumber}}),[l,s]=await Promise.all([e,a]),o=l||{},r=s||{};if(0!==o.code&&0!==r.code)return t({title:o.msg||r.msg||"加载流转记录失败",icon:"none"}),void(this.records=[]);const i=Array.isArray(o.data)?o.data:[],d=Array.isArray(r.data)?r.data:[],c=[];i.forEach((t=>{c.push({type:"sale",role:t.role||"record",customer_name:t.customer_name,net_weight:t.net_weight,unit_price:t.unit_price,price_unit:t.price_unit,remark:t.remark,created_at:t.created_at,updated_at:t.updated_at,date:t.date,_raw:t})})),d.forEach((t=>{c.push({type:"fill",role:"fill",customer_name:"站内灌装",net_weight:t.net_fill,unit_price:null,price_unit:null,remark:t.remark,created_at:t.created_at,updated_at:t.updated_at,date:t.date,timestamp:t.timestamp,_raw:t})})),c.sort(((t,e)=>{const a=this.recordTimestamp(t);return this.recordTimestamp(e)-a})),this.records=c}catch(e){console.error("load bottle records error:",e),t({title:"加载流转记录失败",icon:"none"}),this.records=[]}finally{this.recordsLoading=!1}}},recordTimestamp:t=>t?t.created_at?t.created_at:t.updated_at?t.updated_at:t.timestamp?t.timestamp:t.date?new Date(t.date).getTime():0:0,roleLabel:t=>"out"===t?"出瓶":"back"===t?"回瓶":"deposit"===t?"存瓶":"fill"===t?"灌装":"记录",formatTime(t){if(!t)return"";const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`},formatRecordTime(t){return t?t.created_at?this.formatTime(t.created_at):t.updated_at?this.formatTime(t.updated_at):t.date?`${t.date} 00:00`:"未填日期":"未填日期"}}},[["render",function(t,b,h,g,p,k){const w=e("BackToDashboardBar"),y=m,x=s;return o(),a(x,{class:"page"},{default:l((()=>[r(x,{class:"inner"},{default:l((()=>[r(w,{"back-to":"/pages/bottle/manage",text:"返回"}),r(x,{class:"page-header"},{default:l((()=>[r(x,{class:"page-header-left"},{default:l((()=>[r(x,{class:"page-icon"},{default:l((()=>[r(y,{class:"page-icon-text"},{default:l((()=>[i("瓶")])),_:1})])),_:1}),r(x,{class:"page-header-text"},{default:l((()=>[r(y,{class:"page-title"},{default:l((()=>[i("瓶子详情")])),_:1}),r(y,{class:"page-sub"},{default:l((()=>[i(" 查看瓶号、皮重、状态与备注 ")])),_:1})])),_:1})])),_:1})])),_:1}),r(x,{class:"card"},{default:l((()=>[r(x,{class:"card-header"},{default:l((()=>[r(y,{class:"card-title"},{default:l((()=>[i("基本信息")])),_:1})])),_:1}),p.loading?(o(),a(x,{key:0,class:"loading-block"},{default:l((()=>[r(y,{class:"loading-text"},{default:l((()=>[i("加载中…")])),_:1})])),_:1})):p.bottle?(o(),a(x,{key:2,class:"info-body"},{default:l((()=>[r(x,{class:"info-row"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("瓶号")])),_:1}),r(y,{class:"info-value strong"},{default:l((()=>[i(d(p.bottle.number),1)])),_:1})])),_:1}),r(x,{class:"info-row"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("皮重")])),_:1}),r(y,{class:"info-value"},{default:l((()=>[i(d(null!=p.bottle.tare_weight?p.bottle.tare_weight+" kg":"未填写"),1)])),_:1})])),_:1}),r(x,{class:"info-row"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("状态")])),_:1}),r(x,{class:c(["status-pill","status-"+(p.bottle.status||"unknown")])},{default:l((()=>[r(y,{class:"status-dot"}),r(y,{class:"status-text"},{default:l((()=>[i(d(k.statusText),1)])),_:1})])),_:1},8,["class"])])),_:1}),r(x,{class:"info-row"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("备注")])),_:1}),r(y,{class:"info-value"},{default:l((()=>[i(d(p.bottle.remark||"—"),1)])),_:1})])),_:1}),r(x,{class:"info-row"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("最近灌装")])),_:1}),r(y,{class:"info-value"},{default:l((()=>[i(d(p.bottle.last_fill_date?p.bottle.last_fill_date+" · "+(null!=p.bottle.last_fill_net?p.bottle.last_fill_net+" kg":"—"):"—"),1)])),_:1})])),_:1}),r(x,{class:"info-row"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("上次回瓶")])),_:1}),r(y,{class:"info-value"},{default:l((()=>[i(d(p.bottle.last_back_date?p.bottle.last_back_date+" · "+(null!=p.bottle.last_back_net_weight?p.bottle.last_back_net_weight+" kg":"—"):"—"),1)])),_:1})])),_:1}),r(x,{class:"info-row"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("下次出瓶净重")])),_:1}),r(y,{class:"info-value"},{default:l((()=>[i(d(null!=p.bottle.next_out_net?p.bottle.next_out_net+" kg":"—"),1)])),_:1})])),_:1}),r(x,{class:"info-row"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("上次客户")])),_:1}),r(y,{class:"info-value"},{default:l((()=>[i(d(p.bottle.last_customer_name||"—"),1)])),_:1})])),_:1}),r(x,{class:"info-row info-row-small"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("创建时间")])),_:1}),r(y,{class:"info-value minor"},{default:l((()=>[i(d(k.formatTime(p.bottle.created_at)||"—"),1)])),_:1})])),_:1}),r(x,{class:"info-row info-row-small"},{default:l((()=>[r(y,{class:"info-label"},{default:l((()=>[i("最近更新")])),_:1}),r(y,{class:"info-value minor"},{default:l((()=>[i(d(k.formatTime(p.bottle.updated_at)||"—"),1)])),_:1})])),_:1})])),_:1})):(o(),a(x,{key:1,class:"empty-block"},{default:l((()=>[r(y,{class:"empty-main"},{default:l((()=>[i("未找到瓶子信息")])),_:1}),r(y,{class:"empty-sub"},{default:l((()=>[i("请检查传入的瓶号或稍后重试")])),_:1})])),_:1}))])),_:1}),r(x,{class:"card"},{default:l((()=>[r(x,{class:"card-header"},{default:l((()=>[r(y,{class:"card-title"},{default:l((()=>[i("流转记录")])),_:1}),r(y,{class:"card-sub"},{default:l((()=>[i(d(p.records.length>0?"共 "+p.records.length+" 条相关记录":"展示与该瓶号有关的销售/灌装记录"),1)])),_:1})])),_:1}),p.recordsLoading?(o(),a(x,{key:0,class:"loading-block"},{default:l((()=>[r(y,{class:"loading-text"},{default:l((()=>[i("加载中…")])),_:1})])),_:1})):p.records.length?(o(),a(x,{key:2,class:"timeline"},{default:l((()=>[(o(!0),n(_,null,u(k.visibleRecords,((t,e)=>(o(),a(x,{key:e,class:"timeline-row"},{default:l((()=>[r(x,{class:"timeline-left"},{default:l((()=>[r(x,{class:c(["timeline-dot","role-"+t.role])},null,8,["class"]),e!==k.visibleRecords.length-1?(o(),a(x,{key:0,class:"timeline-line"})):f("",!0)])),_:2},1024),r(x,{class:"timeline-content"},{default:l((()=>[r(x,{class:"timeline-top"},{default:l((()=>[r(x,{class:c(["role-tag","role-tag-"+t.role])},{default:l((()=>[r(y,{class:"role-text"},{default:l((()=>[i(d(t.role_text||k.roleLabel(t.role)),1)])),_:2},1024)])),_:2},1032,["class"]),r(y,{class:"time-text"},{default:l((()=>[i(d(k.formatRecordTime(t)),1)])),_:2},1024)])),_:2},1024),r(x,{class:"timeline-main"},{default:l((()=>[r(y,{class:"main-title"},{default:l((()=>[i(d(t.customer_name||"未知客户"),1)])),_:2},1024),r(x,{class:"main-meta"},{default:l((()=>[null!=t.net_weight?(o(),a(y,{key:0,class:"meta-item"},{default:l((()=>[i(" 净重 "+d(t.net_weight)+" kg ",1)])),_:2},1024)):f("",!0),null!=t.unit_price?(o(),a(y,{key:1,class:"meta-item"},{default:l((()=>[i(" 单价 "+d(t.unit_price)+" "+d("bottle"===t.price_unit?"元/瓶":"kg"===t.price_unit?"元/kg":""),1)])),_:2},1024)):f("",!0)])),_:2},1024),t.remark?(o(),a(y,{key:0,class:"meta-remark"},{default:l((()=>[i(" 备注："+d(t.remark),1)])),_:2},1024)):f("",!0)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128)),k.hasMoreRecords?(o(),a(x,{key:0,class:"timeline-toggle"},{default:l((()=>[r(y,{class:"toggle-text",onClick:k.toggleRecords},{default:l((()=>[i(d(p.showAllRecords?"收起部分记录":"展开更多记录"),1)])),_:1},8,["onClick"])])),_:1})):f("",!0)])),_:1})):(o(),a(x,{key:1,class:"empty-block"},{default:l((()=>[r(y,{class:"empty-main"},{default:l((()=>[i("暂无流转记录")])),_:1}),r(y,{class:"empty-sub"},{default:l((()=>[i(" 录入几条含有该瓶号的销售或灌装记录后，这里会自动生成时间线。 ")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-1972884e"]]);export{k as default};
