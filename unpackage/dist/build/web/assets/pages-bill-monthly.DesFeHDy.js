import{s as t,t as e,n as a,v as s,c as o,w as u,i as l,o as r,d as n,e as m,x as i,y as d,F as c,q as _,f as g,g as y,I as f,z as h,j as D}from"./index-B6DdPhlT.js";import{B as p}from"./BackToDashboardBar.0jhbkRhX.js";import{_ as k,f as C,e as S}from"./_plugin-vue_export-helper.Dda_PF8M.js";const b=k({components:{BackToDashboardBar:p},data:()=>({customers:[],customerKeyword:"",customerId:"",customerName:"",showCustomerDropdown:!1,customerSuggests:[],customerSuggestLoading:!1,customerSuggestTimer:null,startDate:"",endDate:"",summary:{out_net_total:"0.00",back_net_total:"0.00",net_total:"0.00",amount_total:"0.00",amount_received_total:"0.00",unpaid_total:"0.00",record_count:0},loadingSummary:!1}),computed:{},onLoad(){this.initDateRange(),this.loadCustomers(),this.$nextTick((()=>{this.loadSummaryByRange()}))},methods:{getToken(){const e=C();return e||(t({title:"登录已过期，请重新登录",icon:"none"}),S(),"")},initDateRange(){const t=new Date,e=new Date;e.setMonth(e.getMonth()-1);const a=t=>`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;this.startDate=a(e),this.endDate=a(t)},async loadCustomers(){try{const a=this.getToken();if(!a)return;const s=(await e.callFunction({name:"crm-customer",data:{action:"list",token:a,data:{pageSize:500}}})).result||{};if(0!==s.code)return void t({title:s.msg||"加载客户失败",icon:"none"});this.customers=s.data||[]}catch(a){console.error("loadCustomers error",a),t({title:"加载客户失败",icon:"none"})}},async fetchCustomerSuggests(){const t=(this.customerKeyword||"").trim();if(!t)return this.customerSuggests=[],void(this.customerSuggestLoading=!1);const a=this.getToken();if(a){this.customerSuggestLoading=!0;try{const s=(await e.callFunction({name:"crm-customer",data:{action:"suggest",token:a,data:{keyword:t,limit:20}}})).result||{};0===s.code&&(this.customerSuggests=s.data||[])}catch(s){console.error("fetchCustomerSuggests error",s)}finally{this.customerSuggestLoading=!1}}},onCustomerInput(t){this.customerKeyword=t.detail.value,this.showCustomerDropdown=!!this.customerKeyword,this.customerSuggestTimer&&clearTimeout(this.customerSuggestTimer),this.customerSuggestTimer=setTimeout((()=>{this.fetchCustomerSuggests()}),200)},onCustomerConfirm(){1===this.customerSuggests.length?this.onSelectCustomer(this.customerSuggests[0]):this.showCustomerDropdown=!0},onSelectCustomer(t){this.customerId=t._id,this.customerName=t.name,this.customerKeyword=t.name,this.customerSuggests=[],this.showCustomerDropdown=!1,this.loadSummaryByRange()},onStartDateChange(t){this.startDate=t.detail.value,this.endDate&&this.loadSummaryByRange()},onEndDateChange(t){this.endDate=t.detail.value,this.startDate&&this.loadSummaryByRange()},async loadSummaryByRange(){if(!this.startDate||!this.endDate)return void this.resetSummary();if(this.startDate>this.endDate)return t({title:"开始日期不能大于结束日期",icon:"none"}),void this.resetSummary();const a=this.getToken();if(a){this.loadingSummary=!0;try{const s=(await e.callFunction({name:"crm-bill",data:{action:"customerSummaryByRange",token:a,data:{customer_id:this.customerId||"",customer_name:this.customerName||"",date_from:this.startDate,date_to:this.endDate}}})).result||{};if(0!==s.code)return t({title:s.msg||"加载账单失败",icon:"none"}),void this.resetSummary();const o=s.data||{},u=t=>Number(t||0).toFixed(2);this.summary={out_net_total:u(o.out_net_total),back_net_total:u(o.back_net_total),net_total:u(o.net_total),amount_total:u(o.amount_total),amount_received_total:u(o.amount_received_total),unpaid_total:u(o.unpaid_total),record_count:o.record_count||0}}catch(s){console.error("loadSummaryByRange error",s),t({title:"加载账单失败",icon:"none"}),this.resetSummary()}finally{this.loadingSummary=!1}}else this.resetSummary()},resetSummary(){this.summary={out_net_total:"0.00",back_net_total:"0.00",net_total:"0.00",amount_total:"0.00",amount_received_total:"0.00",unpaid_total:"0.00",record_count:0}},resetFilter(){this.customerKeyword="",this.customerId="",this.customerName="",this.showCustomerDropdown=!1,this.initDateRange(),this.loadSummaryByRange()},goDailyDetail(){this.customerId||this.customerName?this.startDate&&this.endDate?a({url:`/pages/bill/monthly-detail?customer_id=${this.customerId||""}&customer_name=${encodeURIComponent(this.customerName||"")}&date_from=${this.startDate}&date_to=${this.endDate}`}):t({title:"请选择时间范围",icon:"none"}):t({title:"请选择一个客户再看明细（汇总已经是全部客户了）",icon:"none"})}}},[["render",function(t,e,a,p,k,C){const S=s("BackToDashboardBar"),b=y,w=f,v=l,I=h,B=D;return r(),o(v,{class:"page"},{default:u((()=>[n(v,{class:"inner"},{default:u((()=>[n(S,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),n(v,{class:"top-bar"},{default:u((()=>[n(v,{class:"field customer-field"},{default:u((()=>[n(b,{class:"label"},{default:u((()=>[m("客户")])),_:1}),n(v,{class:"input-wrapper"},{default:u((()=>[n(w,{class:"input",modelValue:k.customerKeyword,"onUpdate:modelValue":e[0]||(e[0]=t=>k.customerKeyword=t),placeholder:"输入客户名称，支持联想搜索（不填=全部客户）","confirm-type":"search",onInput:C.onCustomerInput,onConfirm:C.onCustomerConfirm},null,8,["modelValue","onInput","onConfirm"])])),_:1}),k.showCustomerDropdown?(r(),o(v,{key:0,class:"suggest-panel"},{default:u((()=>[k.customerSuggests.length?(r(),o(v,{key:0,class:"suggest-list"},{default:u((()=>[(r(!0),i(c,null,d(k.customerSuggests,(t=>(r(),o(v,{key:t._id,class:"suggest-item",onClick:e=>C.onSelectCustomer(t)},{default:u((()=>[n(b,{class:"suggest-name"},{default:u((()=>[m(g(t.name),1)])),_:2},1024),t.address?(r(),o(b,{key:0,class:"suggest-sub"},{default:u((()=>[m(g(t.address),1)])),_:2},1024)):_("",!0)])),_:2},1032,["onClick"])))),128))])),_:1})):k.customerSuggestLoading?_("",!0):(r(),o(v,{key:1,class:"suggest-empty"},{default:u((()=>[n(b,null,{default:u((()=>[m("没有匹配的客户")])),_:1})])),_:1})),k.customerSuggestLoading?(r(),o(v,{key:2,class:"suggest-empty"},{default:u((()=>[n(b,null,{default:u((()=>[m("查询中…")])),_:1})])),_:1})):_("",!0)])),_:1})):_("",!0)])),_:1}),n(v,{class:"field date-range-field"},{default:u((()=>[n(b,{class:"label"},{default:u((()=>[m("时间范围")])),_:1}),n(v,{class:"date-range-wrapper"},{default:u((()=>[n(I,{mode:"date",value:k.startDate,onChange:C.onStartDateChange},{default:u((()=>[n(v,{class:"date-input"},{default:u((()=>[n(b,null,{default:u((()=>[m(g(k.startDate||"开始日期"),1)])),_:1})])),_:1})])),_:1},8,["value","onChange"]),n(b,{class:"range-sep"},{default:u((()=>[m("至")])),_:1}),n(I,{mode:"date",value:k.endDate,onChange:C.onEndDateChange},{default:u((()=>[n(v,{class:"date-input"},{default:u((()=>[n(b,null,{default:u((()=>[m(g(k.endDate||"结束日期"),1)])),_:1})])),_:1})])),_:1},8,["value","onChange"])])),_:1})])),_:1})])),_:1}),n(v,{class:"summary-grid"},{default:u((()=>[n(v,{class:"summary-card",onClick:C.goDailyDetail},{default:u((()=>[n(b,{class:"summary-label"},{default:u((()=>[m("出瓶净重合计")])),_:1}),n(v,{class:"summary-main"},{default:u((()=>[n(b,{class:"summary-value"},{default:u((()=>[m(g(k.summary.out_net_total),1)])),_:1}),n(b,{class:"summary-unit"},{default:u((()=>[m("kg")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:C.goDailyDetail},{default:u((()=>[n(b,{class:"summary-label"},{default:u((()=>[m("回瓶净重合计")])),_:1}),n(v,{class:"summary-main"},{default:u((()=>[n(b,{class:"summary-value"},{default:u((()=>[m(g(k.summary.back_net_total),1)])),_:1}),n(b,{class:"summary-unit"},{default:u((()=>[m("kg")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:C.goDailyDetail},{default:u((()=>[n(b,{class:"summary-label"},{default:u((()=>[m("净出气量")])),_:1}),n(v,{class:"summary-main"},{default:u((()=>[n(b,{class:"summary-value"},{default:u((()=>[m(g(k.summary.net_total),1)])),_:1}),n(b,{class:"summary-unit"},{default:u((()=>[m("kg")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:C.goDailyDetail},{default:u((()=>[n(b,{class:"summary-label"},{default:u((()=>[m("应收合计")])),_:1}),n(v,{class:"summary-main"},{default:u((()=>[n(b,{class:"summary-value"},{default:u((()=>[m(g(k.summary.amount_total),1)])),_:1}),n(b,{class:"summary-unit"},{default:u((()=>[m("元")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:C.goDailyDetail},{default:u((()=>[n(b,{class:"summary-label"},{default:u((()=>[m("实收合计")])),_:1}),n(v,{class:"summary-main"},{default:u((()=>[n(b,{class:"summary-value"},{default:u((()=>[m(g(k.summary.amount_received_total),1)])),_:1}),n(b,{class:"summary-unit"},{default:u((()=>[m("元")])),_:1})])),_:1})])),_:1},8,["onClick"]),n(v,{class:"summary-card",onClick:C.goDailyDetail},{default:u((()=>[n(b,{class:"summary-label"},{default:u((()=>[m("未收（挂账）")])),_:1}),n(v,{class:"summary-main"},{default:u((()=>[n(b,{class:"summary-value unpaid"},{default:u((()=>[m(g(k.summary.unpaid_total),1)])),_:1}),n(b,{class:"summary-unit unpaid"},{default:u((()=>[m("元")])),_:1})])),_:1})])),_:1},8,["onClick"])])),_:1}),k.summary.record_count>0?(r(),o(v,{key:0,class:"footer-note"},{default:u((()=>[n(b,{class:"note-text"},{default:u((()=>[m(" 当前范围内共 "),n(b,{class:"note-strong"},{default:u((()=>[m(g(k.summary.record_count),1)])),_:1}),m(" 条销售记录。 "),Number(k.summary.unpaid_total)>0?(r(),o(b,{key:0},{default:u((()=>[m(" 其中仍有 "),n(b,{class:"note-strong"},{default:u((()=>[m(g(k.summary.unpaid_total),1)])),_:1}),m(" 元挂账未收。 ")])),_:1})):_("",!0)])),_:1})])),_:1})):k.startDate&&k.endDate&&!k.loadingSummary?(r(),o(v,{key:1,class:"footer-note footer-note-empty"},{default:u((()=>[n(b,{class:"note-text"},{default:u((()=>[m(" 当前时间范围内 "),k.customerId||k.customerName?_("",!0):(r(),o(b,{key:0},{default:u((()=>[m("（全部客户）")])),_:1})),m(" 暂无任何销售记录。 ")])),_:1}),n(b,{class:"note-sub"},{default:u((()=>[m(" 可以调整时间范围， "),k.customerId||k.customerName?_("",!0):(r(),o(b,{key:0},{default:u((()=>[m("或选择具体客户后")])),_:1})),m(" 再试一次。 ")])),_:1})])),_:1})):k.startDate&&k.endDate?_("",!0):(r(),o(v,{key:2,class:"footer-note footer-note-empty"},{default:u((()=>[n(b,{class:"note-text"},{default:u((()=>[m(" 请先选择一个时间范围，再查看对账汇总。 ")])),_:1})])),_:1})),n(v,{class:"bottom-actions"},{default:u((()=>[n(B,{class:"btn-soft",onClick:C.resetFilter},{default:u((()=>[m("重置")])),_:1},8,["onClick"]),n(B,{class:"btn-primary",onClick:C.goDailyDetail,disabled:!k.customerId||!k.startDate||!k.endDate},{default:u((()=>[m(" 查看明细 ")])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-0883dd56"]]);export{b as default};
