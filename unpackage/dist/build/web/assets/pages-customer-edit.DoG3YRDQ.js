import{j as e,s as t,r as a,a as l,t as s,h as i,B as n,C as o,c as r,w as c,i as d,o as u,d as m,e as f,l as p,f as _,g as h,I as g,D as k,x as v,E as b}from"./index-C85BGToL.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";const V=x({data:()=>({isEdit:!1,id:"",saving:!1,form:{name:"",short_name:"",contact:"",phone:"",address:"",default_unit_price:"",default_price_unit:"kg",remark:"",is_active:!0},priceUnitOptions:["按公斤计价","按瓶计价"],priceUnitValues:["kg","bottle"],priceUnitIndex:0}),computed:{priceUnitLabel(){return this.priceUnitOptions[this.priceUnitIndex]}},onLoad(e){e&&e.id&&(this.isEdit=!0,this.id=e.id,this.loadDetail())},methods:{getToken:()=>e("crm_token")||e("token")||"",async loadDetail(){const e=this.getToken();if(!e)return t({title:"请先登录",icon:"none"}),void setTimeout((()=>{a({url:"/pages/login/login"})}),1200);try{l({title:"加载中…",mask:!0});const a=(await s.callFunction({name:"crm-customer",data:{action:"get",token:e,data:{id:this.id}}})).result||{};if(0!==a.code)return void t({title:a.msg||"加载失败",icon:"none"});const n=a.data||{};this.form={name:n.name||"",short_name:n.short_name||"",contact:n.contact||"",phone:n.phone||"",address:n.address||"",default_unit_price:null!=n.default_unit_price?String(n.default_unit_price):"",default_price_unit:n.default_price_unit||"kg",remark:n.remark||"",is_active:"boolean"!=typeof n.is_active||n.is_active};const o=this.priceUnitValues.indexOf(this.form.default_price_unit);this.priceUnitIndex=o>=0?o:0}catch(n){console.error("crm-customer get error:",n),t({title:"加载失败，请稍后重试",icon:"none"})}finally{i()}},onPriceUnitChange(e){const t=Number(e.detail.value||0);this.priceUnitIndex=t,this.form.default_price_unit=this.priceUnitValues[t]},onActiveChange(e){this.form.is_active=!!e.detail.value},onPhoneInput(e){let t=(e.detail.value||"").replace(/[^\d-]/g,"");t=t.replace(/-+/g,"-"),t.length>20&&(t=t.slice(0,20)),this.form.phone=t},normalizeAndValidatePhone(){const e=(this.form.phone||"").trim();if(!e)return"";const t=e.replace(/\s+/g,""),a=t.replace(/\D/g,""),l=/^1[3-9]\d{9}$/.test(a),s=/^(\d{3,4}-?\d{5,8})$/.test(t);if(!l&&!s)return null;if(l)return a;const i=t.match(/^(\d{3,4})-?(\d{5,8})$/);return i?`${i[1]}-${i[2]}`:t},async handleSave(){if(this.saving)return;const e=(this.form.name||"").trim();if(!e)return t({title:"请填写客户名称",icon:"none"});const l=(this.form.phone||"").trim();l&&/^[0-9]+$/.test(l)&&11!==l.length&&t({title:"手机号一般为 11 位，请检查一下",icon:"none"});const i=this.getToken();if(!i)return t({title:"请先登录",icon:"none"}),void setTimeout((()=>{a({url:"/pages/login/login"})}),1200);this.saving=!0;try{const a=this.isEdit?"update":"create",n={name:e,short_name:(this.form.short_name||"").trim(),contact:(this.form.contact||"").trim(),phone:l,address:(this.form.address||"").trim(),default_unit_price:this.form.default_unit_price,default_price_unit:this.form.default_price_unit||"kg",remark:(this.form.remark||"").trim(),is_active:!!this.form.is_active};this.isEdit&&(n.id=this.id);const o=(await s.callFunction({name:"crm-customer",data:{action:a,token:i,data:n}})).result||{};if(0!==o.code)return void t({title:o.msg||"保存失败",icon:"none"});t({title:"保存成功",icon:"success"}),setTimeout((()=>{this.goBack()}),600)}catch(n){console.error("crm-customer save error:",n),t({title:"保存失败，请稍后重试",icon:"none"})}finally{this.saving=!1}},goBack(){n().length>1?o():a({url:"/pages/customer/list"})}}},[["render",function(e,t,a,l,s,i){const n=_,o=d,x=h,V=g,U=k,C=v,w=b;return u(),r(o,{class:"page"},{default:c((()=>[m(o,{class:"inner"},{default:c((()=>[m(o,{class:"page-header"},{default:c((()=>[m(o,{class:"page-header-left"},{default:c((()=>[m(o,{class:"page-icon"},{default:c((()=>[m(n,{class:"page-icon-text"},{default:c((()=>[f("客")])),_:1})])),_:1}),m(o,{class:"page-header-text"},{default:c((()=>[m(n,{class:"page-title"},{default:c((()=>[f(p(s.isEdit?"编辑客户":"新增客户"),1)])),_:1}),m(n,{class:"page-sub"},{default:c((()=>[f(" 维护客户名称、地址、默认单价与计价方式 ")])),_:1})])),_:1})])),_:1}),m(o,{class:"page-header-right"},{default:c((()=>[m(x,{class:"btn-soft",onClick:i.goBack},{default:c((()=>[f("返回")])),_:1},8,["onClick"])])),_:1})])),_:1}),m(o,{class:"card"},{default:c((()=>[m(o,{class:"form-item"},{default:c((()=>[m(n,{class:"label"},{default:c((()=>[f("客户名称")])),_:1}),m(o,{class:"input-wrapper"},{default:c((()=>[m(V,{class:"input",modelValue:s.form.name,"onUpdate:modelValue":t[0]||(t[0]=e=>s.form.name=e),placeholder:"请输入客户全名（对账单显示用）",maxlength:"50"},null,8,["modelValue"])])),_:1})])),_:1}),m(o,{class:"form-item"},{default:c((()=>[m(n,{class:"label"},{default:c((()=>[f("简称（选填）")])),_:1}),m(o,{class:"input-wrapper"},{default:c((()=>[m(V,{class:"input",modelValue:s.form.short_name,"onUpdate:modelValue":t[1]||(t[1]=e=>s.form.short_name=e),placeholder:"例如：新拓 A 栋，可选",maxlength:"30"},null,8,["modelValue"])])),_:1})])),_:1}),m(o,{class:"form-item"},{default:c((()=>[m(n,{class:"label"},{default:c((()=>[f("联系人（选填）")])),_:1}),m(o,{class:"input-wrapper"},{default:c((()=>[m(V,{class:"input",modelValue:s.form.contact,"onUpdate:modelValue":t[2]||(t[2]=e=>s.form.contact=e),placeholder:"联系人姓名，可选",maxlength:"20"},null,8,["modelValue"])])),_:1})])),_:1}),m(o,{class:"form-item"},{default:c((()=>[m(n,{class:"label"},{default:c((()=>[f("联系电话（选填）")])),_:1}),m(o,{class:"input-wrapper"},{default:c((()=>[m(V,{class:"input",value:s.form.phone,placeholder:"手机或座机，可选",maxlength:"20",type:"text",onInput:i.onPhoneInput},null,8,["value","onInput"])])),_:1})])),_:1}),m(o,{class:"form-item"},{default:c((()=>[m(n,{class:"label"},{default:c((()=>[f("地址（选填）")])),_:1}),m(o,{class:"textarea-wrapper"},{default:c((()=>[m(U,{class:"textarea",modelValue:s.form.address,"onUpdate:modelValue":t[3]||(t[3]=e=>s.form.address=e),placeholder:"详细送气地址，可选","auto-height":""},null,8,["modelValue"])])),_:1})])),_:1}),m(o,{class:"form-row"},{default:c((()=>[m(o,{class:"form-item half"},{default:c((()=>[m(n,{class:"label"},{default:c((()=>[f("默认单价")])),_:1}),m(o,{class:"input-wrapper"},{default:c((()=>[m(V,{class:"input",modelValue:s.form.default_unit_price,"onUpdate:modelValue":t[4]||(t[4]=e=>s.form.default_unit_price=e),placeholder:"例如：6.8",type:"digit"},null,8,["modelValue"])])),_:1})])),_:1}),m(o,{class:"form-item half"},{default:c((()=>[m(n,{class:"label"},{default:c((()=>[f("计价方式")])),_:1}),m(C,{mode:"selector",range:s.priceUnitOptions,value:s.priceUnitIndex,onChange:i.onPriceUnitChange},{default:c((()=>[m(o,{class:"input-wrapper picker-wrapper"},{default:c((()=>[m(o,{class:"picker"},{default:c((()=>[m(n,null,{default:c((()=>[f(p(i.priceUnitLabel),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["range","value","onChange"])])),_:1})])),_:1}),m(o,{class:"form-item status-item"},{default:c((()=>[m(n,{class:"label"},{default:c((()=>[f("状态")])),_:1}),m(o,{class:"status-right"},{default:c((()=>[m(n,{class:"status-text"},{default:c((()=>[f(p(s.form.is_active?"启用中（正常往来）":"停用（暂不往来）"),1)])),_:1}),m(w,{checked:s.form.is_active,onChange:i.onActiveChange},null,8,["checked","onChange"])])),_:1})])),_:1}),m(o,{class:"form-item"},{default:c((()=>[m(n,{class:"label"},{default:c((()=>[f("备注")])),_:1}),m(o,{class:"textarea-wrapper"},{default:c((()=>[m(U,{class:"textarea",modelValue:s.form.remark,"onUpdate:modelValue":t[5]||(t[5]=e=>s.form.remark=e),placeholder:"可填写结算方式、特殊价格约定等","auto-height":""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),m(o,{class:"bottom-actions"},{default:c((()=>[m(x,{class:"btn-soft",onClick:i.goBack},{default:c((()=>[f("取消")])),_:1},8,["onClick"]),m(x,{class:"btn-primary",onClick:i.handleSave,disabled:s.saving},{default:c((()=>[f(p(s.saving?"保存中…":"保存"),1)])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-fc74b1ad"]]);export{V as default};
