import{s as e,u as a,l as s,v as l,c as t,w as r,i as n,o,d,e as i,f as u,x as c,y as m,F as f,g as p,I as g,z as _,j as h,p as v,q as w}from"./index-B6DdPhlT.js";import{B as U}from"./BackToDashboardBar.0jhbkRhX.js";import{_ as b,e as y,g as k,b as x}from"./_plugin-vue_export-helper.Dda_PF8M.js";import{c as C}from"./request.DMeHGM82.js";const I=b({components:{BackToDashboardBar:U},data:()=>({users:[],loading:!1,savingId:"",creating:!1,newUser:{username:"",password:"",role:"user"},roleOptions:[{value:"superadmin",label:"超级管理员"},{value:"admin",label:"管理员"},{value:"user",label:"普通员工"}]}),onLoad(){if(!y())return;const s=k()||{};if(!x(s))return e({title:"仅超级管理员可访问",icon:"none"}),void a();this.loadUsers()},methods:{async loadUsers(){this.loading=!0;const e=await C("crm-auth",{action:"listUsers"});this.loading=!1,0===e.code&&(this.users=Array.isArray(e.data)?e.data:[])},getRoleIndex(e){const a=this.roleOptions.findIndex((a=>a.value===e));return a>=0?a:0},roleLabel(e){const a=this.roleOptions.find((a=>a.value===e));return a?a.label:"未设置"},formatDate(e){if(!e)return"";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`},onNewRoleChange(e){const a=e&&e.detail&&Number(e.detail.value)||0,s=this.roleOptions[a];s&&(this.newUser.role=s.value)},async createUser(){const{username:a,password:s,role:l}=this.newUser;if(!a||!s)return void e({title:"请填写账号和密码",icon:"none"});this.creating=!0;const t=await C("crm-auth",{action:"createUser",data:{username:a,password:s,role:l}});this.creating=!1,0===t.code&&(e({title:"已创建用户",icon:"success"}),this.newUser={username:"",password:"",role:"user"},this.loadUsers())},async onRoleChange(a,s){const l=s&&s.detail&&Number(s.detail.value)||0,t=this.roleOptions[l];if(!t||t.value===a.role)return;this.savingId=a._id;const r=await C("crm-auth",{action:"updateRole",data:{userId:a._id,role:t.value}});this.savingId="",0===r.code&&(e({title:"已更新角色",icon:"success"}),this.loadUsers())},async removeUser(a){if(!a||"superadmin"===a.username)return;if(!(await new Promise((e=>{s({title:"删除确认",content:`确定删除用户 ${a.username} 吗？`,success:a=>e(a.confirm)})}))))return;0===(await C("crm-auth",{action:"removeUser",data:{userId:a._id}})).code&&(e({title:"已删除",icon:"success"}),this.loadUsers())}}},[["render",function(e,a,s,U,b,y){const k=l("BackToDashboardBar"),x=p,C=n,I=g,R=_,B=h;return o(),t(C,{class:"roles-page"},{default:r((()=>[d(C,{class:"roles-inner"},{default:r((()=>[d(k,{"back-to":"/pages/dashboard/index",text:"返回工作台"}),d(C,{class:"card"},{default:r((()=>[d(C,{class:"card-header"},{default:r((()=>[d(x,{class:"card-title"},{default:r((()=>[i("角色与权限管理")])),_:1}),d(x,{class:"card-sub"},{default:r((()=>[i("仅超级管理员可见，用于分配管理员/员工权限")])),_:1})])),_:1}),d(C,{class:"card-body"},{default:r((()=>[d(C,{class:"create-box"},{default:r((()=>[d(C,{class:"create-title"},{default:r((()=>[i("新增用户")])),_:1}),d(C,{class:"create-row"},{default:r((()=>[d(I,{modelValue:b.newUser.username,"onUpdate:modelValue":a[0]||(a[0]=e=>b.newUser.username=e),modelModifiers:{trim:!0},class:"create-input",placeholder:"账号（必填）"},null,8,["modelValue"]),d(I,{modelValue:b.newUser.password,"onUpdate:modelValue":a[1]||(a[1]=e=>b.newUser.password=e),modelModifiers:{trim:!0},class:"create-input",placeholder:"密码（必填）",password:""},null,8,["modelValue"]),d(R,{mode:"selector",range:b.roleOptions,"range-key":"label",value:y.getRoleIndex(b.newUser.role),onChange:y.onNewRoleChange},{default:r((()=>[d(C,{class:"role-picker small"},{default:r((()=>[d(x,null,{default:r((()=>[i(u(y.roleLabel(b.newUser.role)),1)])),_:1})])),_:1})])),_:1},8,["range","value","onChange"]),d(B,{class:"btn-create",size:"mini",loading:b.creating,onClick:y.createUser},{default:r((()=>[i("创建")])),_:1},8,["loading","onClick"])])),_:1})])),_:1}),b.loading?(o(),t(C,{key:0,class:"empty"},{default:r((()=>[d(x,{class:"empty-text"},{default:r((()=>[i("加载中…")])),_:1})])),_:1})):0===b.users.length?(o(),t(C,{key:1,class:"empty"},{default:r((()=>[d(x,{class:"empty-text"},{default:r((()=>[i("暂无用户数据")])),_:1})])),_:1})):(o(),t(C,{key:2,class:"user-list"},{default:r((()=>[(o(!0),c(f,null,m(b.users,(e=>(o(),t(C,{key:e._id,class:"user-item"},{default:r((()=>[d(C,{class:"user-main"},{default:r((()=>[d(C,{class:"avatar"},{default:r((()=>[i(u((e.username||"U").slice(0,1).toUpperCase()),1)])),_:2},1024),d(C,{class:"info"},{default:r((()=>[d(x,{class:"name"},{default:r((()=>[i(u(e.username||"未命名用户"),1)])),_:2},1024),d(x,{class:"meta"},{default:r((()=>[i("创建于 "+u(y.formatDate(e.created_at)||"-"),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),d(C,{class:"role-actions"},{default:r((()=>[d(R,{mode:"selector",range:b.roleOptions,"range-key":"label",value:y.getRoleIndex(e.role),onChange:a=>y.onRoleChange(e,a),disabled:"superadmin"===e.username},{default:r((()=>[d(C,{class:v(["role-picker",{disabled:"superadmin"===e.username}])},{default:r((()=>[d(x,null,{default:r((()=>[i(u(y.roleLabel(e.role)),1)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1032,["range","value","onChange","disabled"]),"superadmin"!==e.username?(o(),t(x,{key:0,class:"delete-user",onClick:a=>y.removeUser(e)},{default:r((()=>[i("删除")])),_:2},1032,["onClick"])):w("",!0),b.savingId===e._id?(o(),t(x,{key:1,class:"saving"},{default:r((()=>[i("保存中…")])),_:1})):w("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1}))])),_:1})])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-0cdccaf7"]]);export{I as default};
